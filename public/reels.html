<!doctype html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Kenai ‚Äì AI Reels Maker</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .page {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 18px 40px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #9ca3af;
      margin-bottom: 24px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 18px;
      padding: 18px 16px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(148, 163, 184, 0.18);
      margin-bottom: 16px;
    }

    .card h2 {
      margin: 0 0 10px;
      font-size: 1.1rem;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      color: #cbd5f5;
    }

    input[type="file"] {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px dashed rgba(148, 163, 184, 0.6);
      color: #e5e7eb;
      cursor: pointer;
    }

    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .row > div {
      flex: 1 1 160px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: #0b1120;
      box-shadow: 0 10px 30px rgba(236, 72, 153, 0.45);
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s ease;
    }

    button:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(236, 72, 153, 0.6);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
      box-shadow: none;
    }

    .log {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(31, 41, 55, 0.8);
      font-size: 0.8rem;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 4px;
    }

    .pill span {
      color: #f87171;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(22, 163, 74, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.4);
      color: #a7f3d0;
      margin-left: 4px;
    }

    .footer {
      margin-top: 20px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    hr {
      border: none;
      border-top: 1px solid rgba(55, 65, 81, 0.9);
      margin: 14px 0;
    }

    @media (max-width: 640px) {
      .page {
        padding-inline: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Kenai Reels Maker</h1>
    <div class="subtitle">
      Ladda upp bilder/klipp ‚Üí vi sparar en reel-plan i Supabase ‚Üí backend kan bygga din reel.
    </div>

    <div class="card">
      <h2>1. V√§lj material</h2>
      <label for="files">Bilder & videoklipp (du kan v√§lja flera)</label>
      <input id="files" type="file" multiple accept="image/*,video/*" />

      <div class="row">
        <div>
          <label for="targetDuration">M√•l-l√§ngd (sekunder)</label>
          <select id="targetDuration">
            <option value="15">15 sek</option>
            <option value="30" selected>30 sek</option>
            <option value="60">60 sek</option>
            <option value="90">90 sek</option>
          </select>
          <div class="pill">
            Max <span>90 sek</span> totalt
          </div>
        </div>
        <div style="margin-top: 22px;">
          <button id="uploadBtn" onclick="startUpload()">
            ‚¨ÜÔ∏è Ladda upp till Supabase
          </button>
        </div>
      </div>

      <div id="uploadStatus" class="log">Redo. V√§lj klipp och klicka ‚ÄùLadda upp‚Äù.</div>
    </div>

    <div class="card">
      <h2>2. Bygg reel-plan</h2>
      <p style="font-size: 0.85rem; color: #9ca3af;">
        N√§r uppladdningen √§r klar aktiveras knappen. Backend l√§ser din
        <code>plan.json</code> och svarar hur m√•nga klipp som hittades.
      </p>

      <button id="buildReelBtn" onclick="buildReel()" class="btn-secondary" disabled>
        üî• Bygg min reel-plan
      </button>

      <div id="reelResult" class="log" style="margin-top: 10px;">
        Inget byggt √§nnu. Ladda upp f√∂rst.
      </div>
    </div>

    <div class="footer">
      Reels backend:
      <code>https://snipp-ai-1.onrender.com</code>
      <span id="healthBadge" class="badge">kollar status‚Ä¶</span>
    </div>
  </div>

  <script>
    // --------------------------------------------------
    // 1. SUPABASE & BACKEND KONFIG
    // --------------------------------------------------
    //
    // VIKTIGT:
    // Byt ut dessa tv√• till dina riktiga v√§rden.
    // Samma SB_URL & SB_ANON som du har p√• Render / i inspelaren.
    //
    const SB_URL = 'https://hywwzzzxgagqhlxooekz.supabase.co'; // <-- BYT
    const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA'; // <-- BYT

    const BUCKET = "audio";
    const BACKEND_BASE = "https://snipp-ai-1.onrender.com";

    // --------------------------------------------------
    // 2. Hj√§lpfunktioner
    // --------------------------------------------------
    const uploadStatusEl = document.getElementById("uploadStatus");
    const buildBtn = document.getElementById("buildReelBtn");
    const reelResultEl = document.getElementById("reelResult");

    function logUpload(msg) {
      if (!uploadStatusEl) return;
      const now = new Date();
      const ts = now.toTimeString().slice(0, 8);
      uploadStatusEl.textContent += `\n[${ts}] ${msg}`;
      uploadStatusEl.scrollTop = uploadStatusEl.scrollHeight;
    }

    function setUploadStatus(msg) {
      if (!uploadStatusEl) return;
      uploadStatusEl.textContent = msg;
    }

    function setResult(msg) {
      if (!reelResultEl) return;
      reelResultEl.textContent = msg;
    }

    function htmlEscape(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function sanitizeFilename(name) {
      return name.replace(/[^a-zA-Z0-9_\.\-]/g, "_");
    }

    async function checkBackendHealth() {
      try {
        const res = await fetch(`${BACKEND_BASE}/api/health`);
        const data = await res.json();
        const badge = document.getElementById("healthBadge");
        if (badge) {
          if (data && data.ok) {
            badge.textContent = "backend OK";
          } else {
            badge.textContent = "backend problem";
          }
        }
      } catch (err) {
        const badge = document.getElementById("healthBadge");
        if (badge) {
          badge.textContent = "backend offline";
        }
      }
    }

    checkBackendHealth();

    // --------------------------------------------------
    // 3. Uppladdning till Supabase (reels/<sessionId>/...)
    // --------------------------------------------------
    async function uploadToSupabase(path, body, contentType) {
      const url = `${SB_URL}/storage/v1/object/${encodeURIComponent(
        BUCKET
      )}/${encodeURIComponent(path)}`;

      const res = await fetch(url, {
        method: "POST",
        headers: {
          apikey: SB_ANON,
          authorization: `Bearer ${SB_ANON}`,
          "content-type": contentType,
          "x-upsert": "true"
        },
        body
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`Upload misslyckades (${res.status}) ${text}`);
      }
    }

    async function startUpload() {
      const filesInput = document.getElementById("files");
      const targetSel = document.getElementById("targetDuration");

      if (!filesInput || !filesInput.files || filesInput.files.length === 0) {
        alert("V√§lj minst en bild eller ett klipp f√∂rst.");
        return;
      }

      const files = Array.from(filesInput.files);
      const targetDuration = parseInt(targetSel.value, 10) || 30;

      if (files.length === 0) {
        alert("Inga filer valda.");
        return;
      }

      const totalMax = 90;
      if (targetDuration > totalMax) {
        alert("Max 90 sek total l√§ngd.");
        return;
      }

      const uploadBtn = document.getElementById("uploadBtn");
      if (uploadBtn) uploadBtn.disabled = true;
      if (buildBtn) buildBtn.disabled = true;
      setUploadStatus("Startar uppladdning...");
      setResult("Inget byggt √§nnu. Ladda upp f√∂rst.");

      const sessionId = "reel_" + Date.now();
      window.KENAI_LAST_REELS_SESSION = sessionId;

      logUpload(`Session: ${sessionId}`);
      logUpload(`Antal filer: ${files.length}`);
      logUpload(`M√•l-l√§ngd: ${targetDuration} sek`);

      // F√∂rsta enkla version: j√§mn f√∂rdelning av tid per klipp
      const perClip = targetDuration / files.length;

      const clipsPlan = [];

      try {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const safeName = sanitizeFilename(file.name || `clip_${i}`);
          const isImage = file.type.startsWith("image/");
          const isVideo = file.type.startsWith("video/");

          const clipType = isImage ? "image" : isVideo ? "video" : "unknown";
          const relPath = `reels/${sessionId}/clips/${i}_${safeName}`;

          logUpload(`‚¨ÜÔ∏è Laddar upp ${safeName} (${clipType}) ...`);

          await uploadToSupabase(relPath, file, file.type || "application/octet-stream");

          clipsPlan.push({
            file: `clips/${i}_${safeName}`,
            type: clipType,
            duration: perClip
          });

          logUpload(`‚úÖ Klar: ${safeName}`);
        }

        // Skapa plan.json
        const plan = {
          sessionId,
          targetDuration,
          version: 1,
          createdAt: new Date().toISOString(),
          clips: clipsPlan
        };

        const planPath = `reels/${sessionId}/plan.json`;
        logUpload("‚¨ÜÔ∏è Laddar upp plan.json ...");
        await uploadToSupabase(
          planPath,
          JSON.stringify(plan),
          "application/json"
        );
        logUpload("‚úÖ plan.json uppladdad.");

        setUploadStatus(
          `KLART ‚úÖ\nSession: ${sessionId}\nKlipp: ${clipsPlan.length}\nDu kan nu klicka 'Bygg min reel-plan'.`
        );

        if (buildBtn) buildBtn.disabled = false;
      } catch (err) {
        console.error(err);
        logUpload("‚ùå Fel: " + err.message);
        setUploadStatus(
          "Uppladdning misslyckades. Se loggen nedan. Prova igen eller kolla Supabase-inst√§llningar."
        );
      } finally {
        if (uploadBtn) uploadBtn.disabled = false;
      }
    }

    // --------------------------------------------------
    // 4. Anropa backend /api/build-reel
    // --------------------------------------------------
    async function buildReel() {
      const sessionId = window.KENAI_LAST_REELS_SESSION;

      if (!sessionId) {
        setResult("Ingen reel-session hittades. Ladda upp klipp f√∂rst.");
        return;
      }

      setResult("Bygger reel-plan, v√§nta lite...");
      if (buildBtn) buildBtn.disabled = true;

      try {
        const resp = await fetch(`${BACKEND_BASE}/api/build-reel`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId })
        });

        const data = await resp.json();
        console.log("build-reel response:", data);

        if (!data.ok) {
          setResult(
            "Kunde inte l√§sa plan.json √§nnu:\n" +
              (data.error || "ok√§nt fel") +
              (data.url ? "\nURL: " + data.url : "")
          );
        } else {
          const count = data.files ? data.files.length : 0;
          const basePublic = data.basePublic || "(ok√§nd URL)";
          reelResultEl.innerHTML =
            "‚úÖ Reel-plan h√§mtad f√∂r <b>" +
            htmlEscape(sessionId) +
            "</b><br>" +
            "Klipp i planen: <b>" +
            count +
            "</b><br>" +
            "Bas-URL i Supabase:<br><code>" +
            htmlEscape(basePublic) +
            "</code>";
        }
      } catch (err) {
        console.error(err);
        setResult("N√•got gick fel med build-reel: " + err.message);
      } finally {
        if (buildBtn) buildBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
