<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Kenai Reels Maker ‚Äì presets & demo</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
    <!-- Supabase JS (f√∂r uploadSelectedFilesToSupabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #101828, #020617);
      color: #e5e7eb;
    }
    h1, h2, h3 { margin: 0 0 12px; }
    .app { max-width: 960px; margin: 0 auto; }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.8);
      margin-bottom: 20px;
    }
 
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: #e0f2fe;
      margin-bottom: 10px;
    }
    .badge span { font-size: 14px; }

    .preset-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }

    .preset-btn {
      flex: 1 1 160px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 10px 14px;
      font-size: 13px;
      cursor: pointer;
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      transition: all 0.15s ease;
    }
    .preset-btn strong { font-size: 13px; }
    .preset-btn small { font-size: 11px; opacity: 0.75; }

    .preset-btn:hover {
      border-color: rgba(56, 189, 248, 0.7);
      transform: translateY(-1px);
    }

    .preset-btn.active {
      border-color: rgb(56, 189, 248);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.2), rgba(15,23,42,0.95));
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    input[type="number"],
    input[type="file"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      font-size: 13px;
    }
    input[type="number"]:focus,
    input[type="file"]:focus,
    textarea:focus {
      outline: none;
      border-color: rgb(56, 189, 248);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    textarea {
      resize: vertical;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .row > div { flex: 1 1 200px; }

    button.primary {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #22d3ee, #6366f1);
      color: white;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 15px 35px rgba(37, 99, 235, 0.5);
      margin-top: 8px;
    }
    button.primary:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .small-muted {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .plan-preview {
      font-size: 13px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 10px 12px;
      max-height: 260px;
      overflow: auto;
      white-space: pre;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(156, 163, 175, 0.7);
      color: #e5e7eb;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .pill span { opacity: 0.8; }

    .pill-style   { border-color: rgba(56,189,248,0.7); color: #e0f2fe; }
    .pill-files   { border-color: rgba(34,197,94,0.7);  color: #bbf7d0; }
    .pill-duration{ border-color: rgba(245,158,11,0.7); color: #fef3c7; }

    @media (max-width: 640px) {
      body { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- AI Hook & Hashtags -->
    <section class="card" id="hookCard">
      <div class="badge">
        <span>‚ú®</span>
        <span>AI hook & hashtags</span>
      </div>

      <h2>G√∂r din Kenai-reel klickbar p√• 5 sek</h2>
      <p style="font-size: 13px; color:#9ca3af;">
        Beskriv din reel (t.ex. ‚Äùsommar p√• b√•t med v√§nner‚Äù eller
        ‚ÄùKenai AI som fixar podd-sammanfattning‚Äù) s√• f√∂resl√•r Kenai hooks och hashtags (demo).
      </p>

      <label for="hookInput">Beskriv din reel-id√©</label>
      <textarea id="hookInput" rows="4" placeholder="Ex: &quot;Sommar p√• b√•t med v√§nner, Kenai visar hur AI klipper reelen √•t mig&quot;"></textarea>

      <button id="hookBtn" class="primary">
        Generera hooks & hashtags (demo)
      </button>

      <div style="margin-top:16px;">
        <div>F√∂rslag p√• hooks</div>
        <textarea id="hookOutput" rows="4" placeholder="H√§r dyker hook-f√∂rslag upp..."></textarea>
      </div>

      <div style="margin-top:16px;">
        <div>Hashtags</div>
        <textarea id="hookHashtags" rows="3" placeholder="#kenai #reels #ai ..."></textarea>
      </div>

      <div style="margin-top:16px; text-align:right;">
        <button id="copyHashtagsBtn" class="primary">
          Kopiera hashtags
        </button>
      </div>

      <div style="margin-top:8px; text-align:right;">
        <a
          href="#reelsMakerCard"
          id="goToReelsBtn"
          class="primary"
          style="display:inline-block;padding:10px 22px;border-radius:999px;">
          Fixa reel med de h√§r hooksen
        </a>
      </div>
    </section>

    <!-- Header / intro -->
    <section class="card" id="reelsMakerCard">
      <div class="badge">
        <span>üöÄ</span>
        <span>Kenai Reels Maker ‚Äì presets</span>
      </div>
      <h1 style="font-size: 22px; margin-bottom: 4px;">Kenai Reels Maker (Marvel & Tarantino-demo)</h1>
      <p style="font-size: 13px; color:#9ca3af; margin:0 0 4px;">
        Testa hur Kenai planerar reels: ladda in sommarbilder, v√§lj stil (Marvel, Tarantino eller Kenai)
        och f√• en AI-plan med klippl√§ngder.
      </p>
      <p style="font-size: 12px; color:#6b7280; margin:0;">
        Steg 1: V√§lj preset &amp; filer ‚Üí Steg 2: Skapa plan ‚Üí Steg 3: Skicka planen till backend (demo).
      </p>
    </section>

    <!-- 1. V√§lj preset -->
    <section class="card">
      <h2 style="font-size: 16px; margin-bottom: 8px;">1. V√§lj reel-stil</h2>
      <div class="preset-row">
        <button class="preset-btn active" data-style="basic">
          <strong>Basic</strong>
          <small>J√§mn l√§ngd per klipp, bra f√∂r test.</small>
        </button>

        <button class="preset-btn" data-style="marvel">
          <strong>Marvel-reel</strong>
          <small>Snabb introsekvens, korta klipp + logga.</small>
        </button>

        <button class="preset-btn" data-style="tarantino">
          <strong>Tarantino-cut</strong>
          <small>Non-linear, smash cuts, &quot;ding&quot; opening shot.</small>
        </button>

        <button class="preset-btn" data-style="kenai">
          <strong>Kenaireel Classic</strong>
          <small>Kenais egen stil (placeholder).</small>
        </button>
      </div>
      <p class="small-muted" id="styleDescription">
        Stil: <strong>Basic</strong> ‚Äì bra f√∂r test. Marvel/Tarantino/Kenai ger olika klippk√§nsla.
      </p>
    </section>

    <!-- 2. Filer & m√•l-l√§ngd -->
    <section class="card">
      <h2 style="font-size: 16px; margin-bottom: 8px;">2. L√§gg till klipp &amp; l√§ngd</h2>
      <div class="row">
        <div>
          <label for="files">Bilder/filmer (lokalt, laddas ej upp f√∂rr√§n du renderar)</label>
          <input id="files" type="file" multiple accept="image/*,video/*" />
          <div class="small-muted">
            Demo: funkar b√§st med max 3 klipp √•t g√•ngen.
          </div>
        </div>
        <div>
          <label for="targetSeconds">M√•l-l√§ngd (sekunder)</label>
          <input id="targetSeconds" type="number" min="1" max="90" value="10" />
          <div class="small-muted">
            Marvel/Tarantino brukar ligga runt 15‚Äì30 sek. Basic kan vara l√§ngre.
          </div>

          <div style="margin-top:8px;">
            <label for="audioInput">L√•t (demo ‚Äì l√§gg p√• musik)</label>
            <input id="audioInput" type="file" accept="audio/*" />
            <div class="small-muted">
              Anv√§nds bara i demo-knappen &quot;Rendera + musik&quot; just nu.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 3. Plan & preview -->
    <section class="card">
      <h2 style="font-size: 16px; margin-bottom: 8px;">3. F√∂rhandsgranska plan (vad AI skulle g√∂ra)</h2>

      <div style="margin-bottom:8px;">
       <button id="createPlanBtn" class="primary">
          Skapa reel-plan (demo)
        </button>

       <button id="renderDemoBtn" class="primary" style="margin-left:8px;">
          Rendera reel (v1 demo)
        </button>

        <button id="renderMusicDemoBtn" class="primary" style="margin-left:8px;">
          Rendera + musik (demo)
        </button>
      </div>

      <div id="planStatus" class="small-muted" style="margin-bottom:8px;">
        Backend k√∂r Reels demo ‚Äì planen tas emot men ingen riktig video byggs √§nnu.
      </div>

      <div style="margin-bottom:8px;">
        <span class="pill pill-style" id="pillStyle">
          üé¨ <span>Stil: Basic</span>
        </span>
        <span class="pill pill-files" id="pillFiles">
          üìÇ <span>Filer: 0</span>
        </span>
        <span class="pill pill-duration" id="pillDuration">
          ‚è±Ô∏è <span>Total: 0.0 s</span>
        </span>
      </div>

      <div id="planPreview" class="plan-preview">Ingen plan √§nnu, klicka p√• &quot;Skapa reel-plan&quot;.</div>

      <div id="renderPreview" style="margin-top: 16px;">
        <!-- H√§r visar Kenai upp videon fr√•n basic-render -->
      </div>

      <p class="small-muted">
        Senare kan vi spara detta som <code>plan.json</code> och l√•ta backend bygga den riktiga videon.
      </p>
    </section>
  </div>

   <script>
(() => {
      const SB_URL = "https://hywzzxzgaxghlxooekz.supabase.co";
    const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // din riktiga key
    let kenaiReelsSupabaseClient = null;

    function getReelsSupabaseClient() {
      if (!window.supabase) {
        throw new Error("Supabase-biblioteket (window.supabase) saknas p√• sidan.");
      }
      if (!kenaiReelsSupabaseClient) {
        kenaiReelsSupabaseClient = window.supabase.createClient(SB_URL, SB_ANON);
      }
      return kenaiReelsSupabaseClient;
    }

    // ----- Upload-funktion f√∂r valda filer -----
    async function uploadSelectedFilesToSupabase() {
      if (!selectedFiles.length) {
        throw new Error("Inga filer valda f√∂r upload.");
      }

      const client = getReelsSupabaseClient();

      const bucket = "audio";               // samma bucket som f√∂r reels
      const basePath = `reels/${sessionId}`; // prefix f√∂r denna session

      const results = [];

      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];

        // S√§kert filnamn
        const safeName = (file.name || `clip_${i + 1}.mp4`).replace(/[^a-zA-Z0-9_.-]/g, "_");
        const path = `${basePath}/${Date.now()}_${i + 1}_${safeName}`;

        const { data, error } = await client
          .storage
          .from(bucket)
          .upload(path, file, {
            contentType: file.type || "video/mp4",
            upsert: false,
          });

        if (error) {
          console.error("Supabase upload-fel f√∂r", file.name, error);
          throw new Error(`Kunde inte ladda upp fil: ${file.name}`);
        }

        const { data: pub } = client
          .storage
          .from(bucket)
          .getPublicUrl(path);

        const publicUrl = pub?.publicUrl || null;

        results.push({
          index: i,
          fileName: file.name,
          storagePath: path,
          publicUrl,
        });
      }

      return results;
    }


let supabaseClient = null;

  // ----- H√§mta element -----
  const styleButtons = document.querySelectorAll("[data-style]");
  const fileInput =
    document.getElementById("files") ||
    document.getElementById("fileInput") ||
    document.querySelector("input[type='file']");

  const fileCountSpan = document.getElementById("fileCount");
  const totalSizeSpan = document.getElementById("totalSize");
  const targetDurationInput = document.getElementById("targetDuration");

  const createPlanBtn = document.getElementById("createPlanBtn");
  const renderDemoBtn = document.getElementById("renderDemoBtn");
  const renderMusicDemoBtn = document.getElementById("renderMusicDemoBtn");

  const planStatus = document.getElementById("planStatus");
  const planPreview = document.getElementById("planPreview");

  // ----- State -----
  let sessionId = (window.crypto && crypto.randomUUID)
    ? crypto.randomUUID()
    : "sess_" + Date.now();

  let selectedStyle = "basic";
  let selectedFiles = [];
    let currentPlan = null;


  // ----- Hj√§lpfunktioner -----
  function logStatus(msg) {
    if (!planStatus) return;
    planStatus.textContent = msg;
  }

  function updateFileStats() {
    if (!fileCountSpan && !totalSizeSpan) return;
    const count = selectedFiles.length;
    const totalBytes = selectedFiles.reduce((sum, f) => sum + f.size, 0);
    const totalMB = totalBytes / (1024 * 1024);

    if (fileCountSpan) fileCountSpan.textContent = String(count);
    if (totalSizeSpan) totalSizeSpan.textContent = totalMB.toFixed(1);
  }

  // ----- V√§lj reel-stil -----
  styleButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      styleButtons.forEach((b) => b.classList.remove("selected"));
      btn.classList.add("selected");
      selectedStyle = btn.dataset.style || "basic";
    });
  });

  // ----- Filval -----
  if (fileInput) {
    fileInput.addEventListener("change", () => {
      selectedFiles = Array.from(fileInput.files || []);
      updateFileStats();
    });
  }

  // ----- Skapa reel-plan (demo) -----
  async function createReelPlan() {
  if (!selectedFiles.length) {
    logStatus("V√§lj minst 1 fil f√∂rst.");
    return;
  }

  // L√§s √∂nskad l√§ngd (sekunder) fr√•n input
  const rawTarget = (targetDurationInput && targetDurationInput.value)
    ? Number(targetDurationInput.value)
    : 15;

  const targetSeconds = Number.isFinite(rawTarget) && rawTarget > 0
    ? rawTarget
    : 15;

  const n = selectedFiles.length;

  try {
    logStatus("Laddar upp klipp till Kenai-molnet ...");

    // 1) Ladda upp filer till Supabase
    const uploaded = await uploadSelectedFilesToSupabase();

    logStatus("Bygger reel-plan (frontend demo + upload) ...");

    // 2) F√∂rdela tid per klipp
    const perClip = n > 0 ? Number((targetSeconds / n).toFixed(1)) : 3;

    // 3) Bygg file-lista med URL + storagePath
    const files = uploaded.map((item) => {
      const f = item.file;
      const idx = item.index;
      return {
        index: idx,
        type: f.type && f.type.startsWith("image/") ? "image" : "video",
        role: "clip",
        filename: f.name,
        size: f.size,
        plannedDuration: perClip,
        storagePath: item.storagePath,
        publicUrl: item.publicUrl,
        effects: {}, // h√§r l√§gger vi Marvel/Tarantino-effekter sen
      };
    });

    const plan = {
      style: selectedStyle,
      targetSeconds,
      totalFiles: n,
      files,
    };

    // 4) Spara planen globalt
    currentPlan = plan;

    // 5) Bygg text som visas i rutan
    const lines = files.map((clip, index) => {
      const num = index + 1;
      const type = clip.type || "clip";
      const dur = clip.plannedDuration != null ? clip.plannedDuration : "?";
      const name = clip.filename || "ok√§nt namn";
      return num + ". " + type + " ‚Äì " + dur + "s (" + name + ")";
    });

    let header = "Plan klar (frontend demo + upload)\n";
    header += "Stil: " + selectedStyle + "\n";
    header += "M√•ll√§ngd: " + targetSeconds + "s\n";
    header += "Antal klipp: " + n + "\n\n";

    const text = header + lines.join("\n");

    logStatus("Plan klar (frontend demo + upload).");
    if (planPreview) {
      planPreview.textContent = text;
    }

    console.log("Reel-plan (frontend demo + upload):", plan);
  } catch (err) {
    console.error(err);
    logStatus("Fel n√§r plan skulle skapas: " + err.message);
  }
}



  // ----- Koppla knappar -----
  if (createPlanBtn) {
    createPlanBtn.addEventListener("click", (event) => {
      event.preventDefault();
      createReelPlan();
    });
  }

    if (renderDemoBtn) {
    renderDemoBtn.addEventListener("click", async (event) => {
      event.preventDefault();

      if (!currentPlan) {
        logStatus("Skapa f√∂rst en plan (demo) innan du renderar.");
        return;
      }

      logStatus("Render-demo: skickar plan till backend ...");

      try {
        const resp = await fetch("/api/render-reel", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            sessionId,
            plan_json: JSON.stringify(currentPlan),
          }),
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error("Serverfel " + resp.status + ": " + text);
        }

        const data = await resp.json();

        // F√∂r demo: visa meddelande + ev. l√§nk om backend skickar tillbaka videoUrl
        const message =
          data.message ||
          "Render-demo klar (ingen riktig video √§nnu ‚Äì bara test av fl√∂de).";

        if (data.videoUrl) {
          logStatus(message + " URL: " + data.videoUrl);
        } else {
          logStatus(message);
        }
 
        console.log("Render-demo svar:", data);
      } catch (err) {
        console.error(err);
        logStatus("Fel i render-demo: " + err.message);
      }
    });
  }


  if (renderMusicDemoBtn) {
    renderMusicDemoBtn.addEventListener("click", (event) => {
      event.preventDefault();
      logStatus("Render + musik-demo: placeholder tills musik-AI √§r klar.");
    });
  }
})();
  </script>
</body>
</html>

