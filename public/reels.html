<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Kenai Reels Maker</title>
    <style>
      :root {
        color-scheme: dark;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #000 100%);
        color: #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: stretch;
      }

      .page {
        width: 100%;
        max-width: 960px;
        margin: 0 auto;
        padding: 24px 16px 32px;
      }

      h1 {
        margin: 0 0 4px;
        font-size: 1.75rem;
      }

      h2 {
        margin: 0 0 8px;
        font-size: 1.1rem;
      }

      p {
        margin: 0 0 10px;
        color: #9ca3af;
        font-size: 0.92rem;
      }

      .card {
        background: radial-gradient(circle at top left, #111827 0, #020617 70%);
        border-radius: 18px;
        padding: 18px 18px 16px;
        box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
        border: 1px solid rgba(148, 163, 184, 0.16);
        margin-bottom: 16px;
      }

      label {
        font-size: 0.88rem;
        color: #9ca3af;
        display: block;
        margin-bottom: 4px;
      }

      input[type="file"],
      select {
        width: 100%;
        max-width: 260px;
        font-size: 0.9rem;
        padding: 7px 9px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        outline: none;
      }

      input[type="file"] {
        padding: 6px 9px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.08s ease, box-shadow 0.08s ease,
          opacity 0.08s ease, filter 0.08s ease;
      }

      button:active {
        transform: translateY(1px) scale(0.99);
        box-shadow: none;
        filter: brightness(0.96);
      }

      button:disabled {
        opacity: 0.45;
        cursor: default;
        transform: none;
        box-shadow: none;
        filter: none;
      }

      #uploadBtn {
        background: linear-gradient(135deg, #f97316, #f97316 40%, #fb7185);
        color: #111827;
        box-shadow: 0 12px 30px rgba(248, 113, 113, 0.35);
      }

      #buildReelBtn {
        background: linear-gradient(135deg, #f97316, #ec4899);
        color: #111827;
        box-shadow: 0 12px 30px rgba(236, 72, 153, 0.45);
      }

      .log {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 0.78rem;
        line-height: 1.5;
        color: #d1d5db;
        border: 1px solid rgba(55, 65, 81, 0.9);
        max-height: 210px;
        overflow-y: auto;
      }

      .log code {
        font-size: 0.76rem;
        color: #e5e7eb;
      }

      .section-label {
        font-size: 0.85rem;
        color: #9ca3af;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        margin-bottom: 6px;
      }

      .row {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-end;
        gap: 10px;
        margin: 8px 0 10px;
      }

      hr {
        border: none;
        border-top: 1px solid rgba(55, 65, 81, 0.7);
        margin: 10px 0 10px;
      }

      .footer {
        margin-top: 16px;
        font-size: 0.75rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
      }

      .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 0.72rem;
        font-weight: 500;
        background: #4b5563;
        color: #e5e7eb;
      }

      .badge-pill {
        border-radius: 999px;
        padding: 3px 9px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      a {
        color: #38bdf8;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .page {
          padding: 18px 10px 24px;
        }

        h1 {
          font-size: 1.4rem;
        }

        .card {
          padding: 14px 13px 13px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header style="margin-bottom: 16px">
        <h1>Kenai Reels Maker</h1>
        <p>
          Ladda upp bilder och korta klipp ‚Äì vi skapar en reel-plan √•t dig. Backend kan
          l√§sa planen och visa hur m√•nga klipp som hittades. Videobygge √§r avst√§ngt i den
          h√§r gratis-versionen, men planen kan anv√§ndas i t.ex. CapCut.
        </p>
      </header>

      <<div class="card">
  <div class="section-label">2. Bygg reel-plan</div>

  <div style="margin: 8px 0 10px">
    <button id="buildReelBtn" onclick="buildReel()" disabled>
      üî•
      <span>Bygg min reel-plan</span>
    </button>
  </div>

  <div
    id="reelResult"
    class="log"
    style="margin-top: 4px; font-size: 0.86rem"
  >
    Inget byggt √§nnu. Ladda upp f√∂rst.
  </div>
</div>

        
          <div style="margin-top: 22px">
  <button id="uploadBtn" onclick="startUpload()">
    ‚¨ÜÔ∏è
    <span>Ladda upp</span>
  </button>
</div>

        <div id="uploadStatus" class="log">
          Redo. V√§lj klipp och klicka &quot;Ladda upp&quot;.
        </div>
      </div>

      <div class="card">
        <div class="section-label">2. Bygg reel-plan</div>
        <h2>Backend l√§ser din plan.json</h2>
        <p>
          N√§r uppladdningen √§r klar aktiveras knappen. Backend l√§ser din
          <code>plan.json</code> och svarar hur m√•nga klipp som hittades, samt total
          l√§ngd.
        </p>

        <div style="margin: 8px 0 10px">
          <button id="buildReelBtn" onclick="buildReel()" disabled>
            üî•
            <span>Bygg min reel-plan</span>
          </button>
        </div>

        <div
          id="reelResult"
          class="log"
          style="margin-top: 4px; font-size: 0.86rem"
        >
          Inget byggt √§nnu. Ladda upp f√∂rst.
        </div>
      </div>

      <div class="footer">
        <div>
          Reels backend:
          <code>https://snipp-ai-1.onrender.com</code>
        </div>
        <div>
          <span id="backendStatus" class="badge badge-pill">backend...</span>
        </div>
      </div>
    </div>

    <script>
      // ====== KONFIG ======
      const BACKEND_BASE = "https://snipp-ai-1.onrender.com";

      // FYLL I DINA RIKTIGA SUPABASE-V√ÑRDEN H√ÑR
      const SB_URL = 'https://hywwzzzxgagqhlxooekz.supabase.co';  // <-- byt
      const SB_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA'; // <-- byt

      const BUCKET = "audio";
      const MAX_TOTAL_SECONDS = 90;

      const fileInput = document.getElementById("files");
      const lengthSelect = document.getElementById("targetLength");
      const uploadStatusEl = document.getElementById("uploadStatus");
      const buildBtn = document.getElementById("buildReelBtn");
      const reelResultEl = document.getElementById("reelResult");

      function htmlEscape(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function formatSeconds(sec) {
        sec = Math.round(sec || 0);
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        if (m <= 0) return `${s}s`;
        return `${m}m ${s}s`;
      }

      function setStatus(msg) {
        uploadStatusEl.innerHTML = msg;
      }

      function appendStatus(msg) {
        uploadStatusEl.innerHTML += "<br>" + msg;
      }

      function setResult(msg) {
        reelResultEl.innerHTML = htmlEscape(msg).replace(/\n/g, "<br>");
      }

      async function startUpload() {
        const files = fileInput.files;
        if (!files || !files.length) {
          setStatus("V√§lj minst ett klipp f√∂rst.");
          return;
        }

        if (
          !SB_URL ||
          !SB_ANON ||
          SB_URL.includes("YOUR_PROJECT_ID") ||
          SB_ANON === "YOUR_PUBLIC_ANON_KEY"
        ) {
          setStatus(
            "SB_URL / SB_ANON saknas. Fyll i dina Supabase-v√§rden i koden (l√§ngst ned i reels.html)."
          );
          return;
        }

        const targetSec = parseInt(lengthSelect.value, 10) || 30;
        const sessionId = "reel_" + Date.now();
        window.KENAI_LAST_REELS_SESSION = sessionId;
        buildBtn.disabled = true;
        setResult(
          "Inget byggt √§nnu. Du kan nu klicka 'Bygg min reel-plan' efter uppladdning."
        );

        let totalDuration = 0;
        const planClips = [];

        setStatus(`Startar uppladdning‚Ä¶ Session: ${htmlEscape(sessionId)}`);

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const safeName = file.name;
          const ext = safeName.split(".").pop().toLowerCase();
          const type =
            ext === "png" ||
            ext === "jpg" ||
            ext === "jpeg" ||
            ext === "webp" ||
            ext === "gif"
              ? "image"
              : "video";

          // Enkel f√∂rdelning: ~10s per klipp, respektera MAX_TOTAL_SECONDS
          let clipDuration = 10;
          if (totalDuration + clipDuration > MAX_TOTAL_SECONDS) {
            clipDuration = Math.max(0, MAX_TOTAL_SECONDS - totalDuration);
          }
          if (clipDuration <= 0) {
            appendStatus(
              `‚è≠Ô∏è Hoppar √∂ver ${htmlEscape(
                safeName
              )} (skulle √∂verskrida max ${MAX_TOTAL_SECONDS}s).`
            );
            continue;
          }

          totalDuration += clipDuration;

          const storagePath = `reels/${sessionId}/${safeName}`;
          const uploadUrl = `${SB_URL}/storage/v1/object/${encodeURIComponent(
            BUCKET
          )}/${encodeURIComponent(storagePath)}`;

          appendStatus(`‚¨ÜÔ∏è Laddar upp ${htmlEscape(safeName)}‚Ä¶`);

          try {
            const resp = await fetch(uploadUrl, {
              method: "POST",
              headers: {
                apikey: SB_ANON,
                authorization: `Bearer ${SB_ANON}`,
                "x-upsert": "true"
              },
              body: file
            });

            if (!resp.ok) {
              const text = await resp.text().catch(() => "");
              appendStatus(
                `‚ùå Kunde inte ladda upp ${htmlEscape(
                  safeName
                )} (${resp.status}). ${htmlEscape(text)}`
              );
              continue;
            }

            appendStatus(`‚úÖ Uppladdad: ${htmlEscape(safeName)}`);

            planClips.push({
              file: safeName,
              type,
              duration: clipDuration
            });
          } catch (err) {
            appendStatus(
              `‚ùå Fel vid uppladdning av ${htmlEscape(safeName)}: ${htmlEscape(
                err.message
              )}`
            );
          }
        }

        if (!planClips.length) {
          appendStatus("Inga klipp i planen (allt hoppades √∂ver).");
          return;
        }

        const plan = {
          sessionId,
          createdAt: new Date().toISOString(),
          targetDuration: targetSec,
          totalDuration,
          maxTotalSeconds: MAX_TOTAL_SECONDS,
          clips: planClips
        };

        const planJson = JSON.stringify(plan, null, 2);
        const planPath = `reels/${sessionId}/plan.json`;
        const planUploadUrl = `${SB_URL}/storage/v1/object/${encodeURIComponent(
          BUCKET
        )}/${encodeURIComponent(planPath)}`;

        appendStatus("üíæ Sparar plan.json‚Ä¶");

        try {
          const planResp = await fetch(planUploadUrl, {
            method: "POST",
            headers: {
              apikey: SB_ANON,
              authorization: `Bearer ${SB_ANON}`,
              "content-type": "application/json",
              "x-upsert": "true"
            },
            body: planJson
          });

          if (!planResp.ok) {
            const text = await planResp.text().catch(() => "");
            appendStatus(
              `‚ùå Kunde inte spara plan.json (${planResp.status}). ${htmlEscape(
                text
              )}`
            );
            return;
          }

          const publicPlanUrl = `${SB_URL}/storage/v1/object/public/${BUCKET}/reels/${sessionId}/plan.json`;

          appendStatus(
            `Reel-plan sparad (${formatSeconds(
              totalDuration
            )} totalt, ${planClips.length} klipp). Planfil: <a href="${publicPlanUrl}" target="_blank">plan.json</a>`
          );

          buildBtn.disabled = false;
          setResult(
            "Inget byggt √§nnu. Du kan nu klicka 'Bygg min reel-plan' s√• l√§ser backend din plan."
          );
        } catch (err) {
          appendStatus(
            `‚ùå N√•got gick fel n√§r plan.json skulle sparas: ${htmlEscape(
              err.message
            )}`
          );
        }
      }

      async function buildReel() {
        const sessionId = window.KENAI_LAST_REELS_SESSION;

        if (!sessionId) {
          setResult("Ingen reel-session hittades. Ladda upp klipp f√∂rst.");
          return;
        }

        setResult("Bygger reel-plan (backend), v√§nta lite‚Ä¶");
        buildBtn.disabled = true;

        try {
          const resp = await fetch(`${BACKEND_BASE}/api/build-reel`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sessionId })
          });

          let data;
          try {
            data = await resp.json();
          } catch (e) {
            throw new Error("Kunde inte l√§sa JSON-svar fr√•n backend.");
          }

          console.log("build-reel response:", data);

          if (!resp.ok || !data.ok) {
            setResult(
              "Kunde inte bygga reel √§nnu:\n" +
                (data && data.error ? data.error : `HTTP ${resp.status}`) +
                (data && data.url ? "\nURL: " + data.url : "")
            );
            return;
          }

          const count = data.files ? data.files.length : 0;
          const basePublic = data.basePublic || "(ok√§nd URL)";
          const totalDur = data.totalDuration || 0;

          let html =
            "‚úÖ Reel-plan h√§mtad f√∂r <b>" +
            htmlEscape(sessionId) +
            "</b><br>" +
            "Klipp i planen: <b>" +
            count +
            "</b><br>" +
            "Total l√§ngd: <b>" +
            htmlEscape(formatSeconds(totalDur)) +
            "</b><br>" +
            "Bas-URL:<br><code>" +
            htmlEscape(basePublic) +
            "</code>";

          if (Array.isArray(data.files) && data.files.length) {
            html += "<br><br><b>Klipp:</b><br><ol>";
            for (const f of data.files) {
              const idx =
                typeof f.index === "number" ? f.index + 1 : data.files.indexOf(f) + 1;
              html +=
                "<li>" +
                htmlEscape(String(idx) + ". ") +
                htmlEscape(f.file || "") +
                " ‚Äì " +
                htmlEscape(f.type || "?") +
                (f.duration
                  ? " (" + htmlEscape(formatSeconds(f.duration)) + ")"
                  : "") +
                "</li>";
            }
            html += "</ol>";
          }

          html +=
            "<br><b>Obs:</b> Videobygge √§r avst√§ngt i denna testversion (gratis server)." +
            "<br>Du kan anv√§nda planen ovan + klippen i t.ex. CapCut f√∂r att bygga reelen.";

          reelResultEl.innerHTML = html;
        } catch (err) {
          console.error(err);
          setResult("N√•got gick fel med build-reel: " + err.message);
        } finally {
          buildBtn.disabled = false;
        }
      }

      async function checkBackend() {
        const badge = document.getElementById("backendStatus");
        try {
          const resp = await fetch(`${BACKEND_BASE}/api/health`);
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          const data = await resp.json();
          console.log("health:", data);
          badge.textContent = "backend OK";
          badge.style.backgroundColor = "#0b9444";
          badge.style.color = "#e5e7eb";
        } catch (e) {
          badge.textContent = "backend OFFLINE";
          badge.style.backgroundColor = "#b91c1c";
          badge.style.color = "#fee2e2";
        }
      }

      checkBackend();
    </script>
  </body>
</html>
