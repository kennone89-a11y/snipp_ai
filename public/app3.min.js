(()=>{"use strict";var e=document.getElementById("startBtn"),t=document.getElementById("stopBtn"),n=document.getElementById("maxlen"),o=document.getElementById("state"),a=document.getElementById("codec"),d=document.getElementById("mime"),c=document.getElementById("fname"),l=document.getElementById("fsize"),i=document.getElementById("dur"),r=document.getElementById("status"),u=document.getElementById("player"),s=document.getElementById("dl"),m=document.getElementById("share"),p=document.getElementById("copy"),f=document.getElementById("dot"),v=document.getElementById("ua");function y(e){r.textContent=(r.textContent?r.textContent+"\n":"")+e}function g(r){o.textContent=r,f.textContent="status: "+r,e.disabled=r!=="idle",t.disabled=r!=="recording"}function h(e){var t=e/1e3|0,n=("0"+(t/60|0)).slice(-2);return n+":"+("0"+t%60).slice(-2)}v.textContent=navigator.userAgent,console.log("recorder loaded"),r.textContent="Ready.";var S={IDLE:"idle",REC:"recording",STOP:"stopping",DONE:"done"},E=0,w=null,b=null,T=+n.value;g(S.IDLE),n.onchange=function(){T=+n.value};var A=null,O=null,R=null,N=1,L=44100;e.addEventListener("click",async function(){try{g(S.REC),r.textContent="1) Request mic...";A=await navigator.mediaDevices.getUserMedia({audio:!0}),y("Mic OK"),E=performance.now(),w&&clearInterval(w),w=setInterval(function(){var e=performance.now()-E;i.textContent=h(e),e>=T&&(y("Auto-stop"),C())},250);var e=window.AudioContext||window.webkitAudioContext;O=new e({sampleRate:44100}),y("2) AudioContext "+O.sampleRate+" Hz"),L=O.sampleRate,R=O.createMediaStreamSource(A),N=1;var t=4096;P=O.createScriptProcessor(t,N,N),q=[],function(){q=[];for(var e=0;e<N;e++)q[e]=[]}(),P.onaudioprocess=function(e){for(var t=0;t<N;t++)q[t].push(new Float32Array(e.inputBuffer.getChannelData(t)))};R.connect(P),P.connect(O.destination),y("3) Recording..."),a.textContent="WAV-fallback",d.textContent="audio/wav",c.textContent="-",l.textContent="-",s.style.display="none",u.src="",m.style.display="none",p.style.display="none",b&&clearTimeout(b),b=setTimeout(function(){y("Auto-stop (hard)");C()},T+600)}catch(n){g(S.IDLE),w&&(clearInterval(w),w=null),y("Error: "+n.message)}});function C(){if(o.textContent!==S.REC&&o.textContent!==S.STOP)return;g(S.STOP),w&&(clearInterval(w),w=null),b&&(clearTimeout(b),b=null),y("4) Stopping...");try{P&&P.disconnect(),R&&R.disconnect()}catch(e){}try{y("5) Building WAV...");for(var e=0,t=0;t<q[0].length;t++)e+=q[0][t].length;for(var n=new Float32Array(e*N),a=0,d=0;d<q[0].length;d++){for(var c=q[0][d].length,l=0;l<c;l++)for(var i=0;i<N;i++)n[(a+l)*N+i]=q[i][d][l];a+=c}var r=2,f=N*r,v=new ArrayBuffer(44+n.length*r),S=new DataView(v);!function(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}(S,0,"RIFF"),S.setUint32(4,36+n.length*r,!0),function(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}(S,8,"WAVE"),function(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}(S,12,"fmt "),S.setUint32(16,16,!0),S.setUint16(20,1,!0),S.setUint16(22,N,!0),S.setUint32(24,L,!0),S.setUint32(28,L*f,!0),S.setUint16(32,f,!0),S.setUint16(34,16,!0),function(e,t,n){for(var o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}(S,36,"data"),S.setUint32(40,n.length*r,!0);for(var y=44,g=0;g<n.length;g++){var T=Math.max(-1,Math.min(1,n[g]));S.setInt16(y,T<0?32768*T:32767*T,!0),y+=2}var A=new Blob([S],{type:"audio/wav"});k(A,"wav")}catch(O){y("Pack error: "+O.message)}try{O&&O.close()}catch(R){}try{A&&A.getTracks().forEach(function(e){e.stop()})}catch(N){}}async function k(e,t){g(S.DONE);var n=URL.createObjectURL(e);u.src=n;try{u.load()}catch(o){}var a="kenai-"+function(){var e=new Date,t=function(e){return("0"+e).slice(-2)};return e.getFullYear()+t(e.getMonth()+1)+t(e.getDate())+"-"+t(e.getHours())+t(e.getMinutes())+t(e.getSeconds())}()+"."+t;s.download=a,s.href=n,s.style.display="inline-block",c.textContent=a,l.textContent=(e.size/1024/1024).toFixed(2)+" MB",y("Done. Press Play if it does not autostart.")}var q=[],P=null;t.addEventListener("click",C),window.__start=()=>e.click(),window.__stop=()=>t.click(),window.addEventListener("error",function(n){g(S.IDLE),y("JS error: "+n.message),e.disabled=!1,t.disabled=!0})})();

