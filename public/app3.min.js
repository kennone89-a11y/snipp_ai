(()=>{"use strict";
// refs
const startBtn=document.getElementById("startBtn");
const stopBtn =document.getElementById("stopBtn");
const maxSel  =document.getElementById("maxlen");
const stateEl =document.getElementById("state");
const codecEl =document.getElementById("codec");
const mimeEl  =document.getElementById("mime");
const fnameEl =document.getElementById("fname");
const fsizeEl =document.getElementById("fsize");
const durEl   =document.getElementById("dur");
const statusEl=document.getElementById("status");
const player  =document.getElementById("player");
const dl      =document.getElementById("dl");
const share   =document.getElementById("share");
const copyBtn =document.getElementById("copy");
const dot     =document.getElementById("dot");
const uaEl    =document.getElementById("ua");
uaEl.textContent = navigator.userAgent;

// helpers
const STATE={IDLE:"idle",REC:"recording",STOP:"stopping",DONE:"done"};
let startedAt=0,tick=null,hard=null,MAX_MS=+maxSel.value;
let stream=null,ac=null,src=null,proc=null,bufs=[],chs=1,rate=44100;
function log(m){ statusEl.textContent=(statusEl.textContent?statusEl.textContent+"\n":"")+m; }
function setState(s){ stateEl.textContent=s; dot.textContent="status: "+s; startBtn.disabled=(s!==STATE.IDLE); stopBtn.disabled=(s!==STATE.REC); }
function tstr(ms){ const s=(ms/1000|0), m=("0"+(s/60|0)).slice(-2); return m+":"+("0"+(s%60)).slice(-2); }
function startTick(){ startedAt=performance.now(); stopTick(); tick=setInterval(()=>{ const e=performance.now()-startedAt; durEl.textContent=tstr(e); if(e>=MAX_MS){ log("Auto-stop"); stopRec(); } },250); }
function stopTick(){ if(tick){ clearInterval(tick); tick=null; } }
maxSel.onchange=()=>{ MAX_MS=+maxSel.value; };

// recorder
async function startRec(){
  try{
    setState(STATE.REC);
    statusEl.textContent="1) Begär mikrofon...";
    stream=await navigator.mediaDevices.getUserMedia({audio:true});
    log("Mikrofon OK"); startTick();

    const AC=window.AudioContext||window.webkitAudioContext;
    ac=new AC({sampleRate:44100});
    log("2) AudioContext "+ac.sampleRate+" Hz");
    rate=ac.sampleRate; src=ac.createMediaStreamSource(stream);
    chs=1; proc=ac.createScriptProcessor(4096,chs,chs);
    bufs=[]; for(let c=0;c<chs;c++) bufs[c]=[];
    proc.onaudioprocess=e=>{
      for(let c=0;c<chs;c++){ bufs[c].push(new Float32Array(e.inputBuffer.getChannelData(c))); }
    };
    src.connect(proc); proc.connect(ac.destination);
    log("3) Spelar in ...");
    codecEl.textContent="WAV-fallback"; mimeEl.textContent="audio/wav";
    fnameEl.textContent="-"; fsizeEl.textContent="-";
    dl.style.display="none"; player.src=""; share.style.display="none"; copyBtn.style.display="none";
    if(hard) clearTimeout(hard); hard=setTimeout(()=>{ log("Auto-stop (hard)"); stopRec(); }, MAX_MS+600);
  }catch(e){ setState(STATE.IDLE); stopTick(); log("Fel: "+e.message); }
}

function stopRec(){
  if(stateEl.textContent!==STATE.REC && stateEl.textContent!==STATE.STOP) return;
  setState(STATE.STOP); stopTick(); if(hard){ clearTimeout(hard); hard=null; }
  log("4) Stoppar inspelning...");
  try{ proc&&proc.disconnect(); src&&src.disconnect(); }catch(_){}
  try{
    log("5) Bygger WAV...");
    let len=0; for(let i=0;i<bufs[0].length;i++) len+=bufs[0][i].length;
    const inter=new Float32Array(len*chs); let off=0;
    for(let b=0;b<bufs[0].length;b++){ const L=bufs[0][b].length;
      for(let s=0;s<L;s++){ for(let c=0;c<chs;c++){ inter[(off+s)*chs+c]=bufs[c][b][s]; } }
      off+=L;
    }
    const bytesPerSample=2, blockAlign=chs*bytesPerSample;
    const ab=new ArrayBuffer(44+inter.length*bytesPerSample), view=new DataView(ab);
    const W=(v,o,str)=>{ for(let i=0;i<str.length;i++) v.setUint8(o+i,str.charCodeAt(i)); };
    W(view,0,"RIFF"); view.setUint32(4,36+inter.length*bytesPerSample,true);
    W(view,8,"WAVE"); W(view,12,"fmt ");
    view.setUint32(16,16,true); view.setUint16(20,1,true);
    view.setUint16(22,chs,true); view.setUint32(24,rate,true);
    view.setUint32(28,rate*blockAlign,true); view.setUint16(32,blockAlign,true);
    view.setUint16(34,16,true); W(view,36,"data"); view.setUint32(40,inter.length*bytesPerSample,true);
    let idx=44; for(let k=0;k<inter.length;k++){ const s=Math.max(-1,Math.min(1,inter[k])); view.setInt16(idx, s<0?s*0x8000:s*0x7FFF, true); idx+=2; }
    const blob=new Blob([view],{type:"audio/wav"});
    log("WAV klar: "+(blob.size/1024/1024).toFixed(2)+" MB"); finish(blob,"wav");
  }catch(err){ log("Packningsfel: "+err.message); }
  try{ ac&&ac.close(); }catch(_){}
  try{ stream&&stream.getTracks().forEach(t=>t.stop()); }catch(_){}
}

function finish(blob,ext){
  setState(STATE.DONE);
  const url=URL.createObjectURL(blob);
  player.src=url; try{ player.load(); }catch(_){}
  const name="kenai-"+ts()+"."+ext;
  dl.download=name; dl.href=url; dl.style.display="inline-block";
  fnameEl.textContent=name; fsizeEl.textContent=(blob.size/1024/1024).toFixed(2)+" MB";
  log("Klar - tryck Play om den inte startar själv.");
}

function ts(){ const d=new Date(),p=n=>("0"+n).slice(-2); return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+"-"+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }

// bind + global fallbacks
startBtn.addEventListener("click",startRec);
stopBtn .addEventListener("click",stopRec);
window.__start=startRec;
window.__stop =stopRec;

// init
console.log("recorder loaded"); statusEl.textContent="Klar. (Recorder laddad)"; setState(STATE.IDLE);
})();
