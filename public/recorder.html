<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Kenai Recorder AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      color-scheme: dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #222844 0, #050509 55%, #000 100%);
      color: #f5f5f5;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    main {
      width: 100%;
      max-width: 480px;
      background: rgba(8, 8, 16, 0.95);
      border-radius: 20px;
      padding: 20px 18px 18px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }
    .subtitle {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 16px;
    }
    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 14px;
      cursor: pointer;
      background: #262b40;
      color: #f5f5f5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.1s ease, background 0.1s ease, opacity 0.1s ease;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
    }
    button:not(:disabled):active {
      transform: scale(0.97);
      background: #323757;
    }
    .record {
      background: #d92c3a;
    }
    .record:not(:disabled):active {
      background: #b0202d;
    }
    .primary {
      background: #3b82f6;
    }
    .primary:not(:disabled):active {
      background: #2563eb;
    }
    .status {
      min-height: 18px;
      font-size: 12px;
      margin-bottom: 10px;
      opacity: 0.9;
    }
    .status.muted { opacity: 0.7; }
    .status.error { color: #f97373; }
    .timer {
      font-variant-numeric: tabular-nums;
      font-size: 14px;
    }
    audio {
      width: 100%;
      margin: 8px 0 6px;
    }
    .label {
      font-size: 11px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 2px;
    }
    .link-row {
      font-size: 12px;
      word-break: break-all;
      margin-bottom: 8px;
    }
    a {
      color: #7dd3fc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    pre {
      background: #050814;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      max-height: 220px;
      overflow: auto;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    hr {
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      margin: 14px 0 10px;
    }
  </style>
</head>
<body>
  <main>
    <h1>Kenai Recorder AI</h1>
    <div class="subtitle">Spela in ‚Ä¢ Ladda upp ‚Ä¢ L√•t AI sammanfatta</div>

    <div class="row">
      <button id="startBtn" class="record">‚óè Spela in</button>
      <button id="stopBtn" disabled>‚ñ† Stoppa</button>
      <button id="uploadBtn" class="primary" disabled>‚¨ÜÔ∏é Ladda upp</button>
      <span class="timer" id="timer">00:00</span>
    </div>

    <div id="status" class="status muted">Redo.</div>

    <div>
      <div class="label">Senaste inspelning</div>
      <audio id="player" controls></audio>
    </div>

    <div>
      <div class="label">Delbar l√§nk</div>
      <div class="link-row">
        <a id="publicLink" href="#" target="_blank"></a>
      </div>
    </div>

    <hr />

    <!-- AI-recension -->
    <div id="aiSection">
      <div class="label">AI-recension</div>
      <button id="aiBtn" disabled>‚ú® AI lyssnar √•t dig</button>
      <pre id="aiOutput"></pre>
    </div>
  </main>

  <script>
    // ========= SUPABASE-inst√§llningar =========
    const SB_URL ='https://hywwzzzxgagqhlxooekz.supabase.co';   // t.ex. https://xxxxx.supabase.co
    const SB_ANON ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA'; // din publika anon key
    const BUCKET = "audio";
    const FOLDER = "reviews";

    // ========= UI-element =========
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl = document.getElementById("status");
    const timerEl = document.getElementById("timer");
    const player = document.getElementById("player");
    const publicLinkEl = document.getElementById("publicLink");
    const aiBtn = document.getElementById("aiBtn");
    const aiOutput = document.getElementById("aiOutput");

    // ========= Recorder-state =========
    let mediaRecorder = null;
    let chunks = [];
    let lastBlob = null;
    let lastObjectUrl = null;
    let timerInterval = null;
    let startTime = 0;
    window.__lastRecordingUrl = null; // anv√§nds av AI

    function setStatus(text, type) {
      statusEl.textContent = text;
      statusEl.className = "status " + (type || "muted");
    }

    function setButtons(recording, hasBlob, uploading) {
      startBtn.disabled = recording || uploading;
      stopBtn.disabled = !recording;
      uploadBtn.disabled = !hasBlob || uploading;
      aiBtn.disabled = !window.__lastRecordingUrl || recording || uploading;
    }

    function resetTimer() {
      timerEl.textContent = "00:00";
    }

    function startTimer() {
      startTime = Date.now();
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const mm = String(Math.floor(diff / 60)).padStart(2, "0");
        const ss = String(diff % 60).padStart(2, "0");
        timerEl.textContent = mm + ":" + ss;
      }, 500);
    }

    function stopTimer() {
      clearInterval(timerInterval);
    }

    // ========= Inspelning =========
    async function startRecording() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          setStatus("Din webbl√§sare st√∂djer inte inspelning.", "error");
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

        mediaRecorder.ondataavailable = (evt) => {
          if (evt.data && evt.data.size > 0) chunks.push(evt.data);
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          lastBlob = blob;
          if (lastObjectUrl) {
            URL.revokeObjectURL(lastObjectUrl);
          }
          lastObjectUrl = URL.createObjectURL(blob);
          player.src = lastObjectUrl;
          setStatus("Inspelning klar. Du kan ladda upp.", "muted");
          setButtons(false, true, false);
        };

        mediaRecorder.start();
        setStatus("Spelar in...", "muted");
        setButtons(true, false, false);
        startTimer();
      } catch (err) {
        console.error(err);
        setStatus("Kunde inte starta inspelning: " + err.message, "error");
        setButtons(false, false, false);
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(t => t.stop());
        stopTimer();
      }
    }

    // ========= Upload till Supabase =========
    async function uploadRecording() {
      try {
        if (!lastBlob) {
          setStatus("Ingen inspelning att ladda upp.", "error");
          return;
        }
        if (!SB_URL || !SB_ANON) {
          setStatus("Supabase-inst√§llningar saknas (SB_URL / SB_ANON).", "error");
          return;
        }

        setButtons(false, true, true);
        setStatus("Laddar upp till Supabase...", "muted");

        const ts = Date.now();
        const fileName = `kenai_${ts}.webm`;
        const uploadUrl = `${SB_URL}/storage/v1/object/${BUCKET}/${FOLDER}/${fileName}`;

        const res = await fetch(uploadUrl, {
          method: "POST",
          headers: {
            "Content-Type": "audio/webm",
            "apikey": SB_ANON,
            "Authorization": `Bearer ${SB_ANON}`,
            "x-upsert": "true"
          },
          body: lastBlob
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Supabase error:", text);
          setStatus("Fel vid uppladdning: " + text, "error");
          setButtons(false, !!lastBlob, false);
          return;
        }

        const publicUrl = `${SB_URL}/storage/v1/object/public/${BUCKET}/${FOLDER}/${fileName}`;

        publicLinkEl.href = publicUrl;
        publicLinkEl.textContent = publicUrl;
        window.__lastRecordingUrl = publicUrl;

        setStatus("Uppladdning klar. L√§nk skapad.", "muted");
        setButtons(false, !!lastBlob, false);
        aiBtn.disabled = false;
      } catch (err) {
        console.error(err);
        setStatus("N√•got gick fel vid uppladdning: " + err.message, "error");
        setButtons(false, !!lastBlob, false);
      }
    }

    // ========= AI-review =========
    async function runAIReview() {
      const audioUrl = window.__lastRecordingUrl;
      if (!audioUrl) {
        alert("Spela in och ladda upp f√∂rst, s√• vet AI vilket klipp den ska lyssna p√•.");
        return;
      }

      aiBtn.disabled = true;
      aiBtn.textContent = "AI lyssnar...";
      aiOutput.textContent = "AI lyssnar och skriver... ‚è≥";

      try {
        const res = await fetch("/api/ai-review", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ audioUrl })
        });

        if (!res.ok) {
          const text = await res.text();
          aiOutput.textContent = "Fel fr√•n servern: " + text;
          aiBtn.disabled = false;
          aiBtn.textContent = "‚ú® AI lyssnar √•t dig";
          return;
        }

        const data = await res.json();
        const transcript = data.transcript || "";
        const summary = data.summary || "";

        aiOutput.textContent =
          (summary ? "üìù Sammanfattning:\n" + summary + "\n\n" : "") +
          (transcript ? "üìú Transkription:\n" + transcript : "");
      } catch (err) {
        console.error(err);
        aiOutput.textContent = "N√•got gick fel n√§r vi pratade med AI:n: " + err.message;
      } finally {
        aiBtn.disabled = false;
        aiBtn.textContent = "‚ú® AI lyssnar √•t dig";
      }
    }

    // ========= Event-listeners =========
    startBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);
    uploadBtn.addEventListener("click", uploadRecording);
    aiBtn.addEventListener("click", runAIReview);
  </script>
</body>
</html>
