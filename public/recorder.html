<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kenai Recorder</title>

    <style>
        body {
            background: #f4f6f9;
            font-family: Arial;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 0 12px rgba(0,0,0,0.1);
        }
        h1 {
            margin-bottom: 10px;
        }
        button {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            margin-right: 6px;
            background: #0d6efd;
            color: #fff;
        }
        button.red { background: #dc3545; }
        textarea {
            width: 100%;
            height: 150px;
            margin-top: 10px;
        }
        input[type="text"] {
            width: 250px;
            padding: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Kenai Recorder</h1>
    <p>Nytt: Testa även AI Reels Maker för att skapa reels automatiskt!</p>

    <button id="startBtn">Starta inspelning</button>
    <button id="stopBtn" class="red">Stoppa</button>

    <p id="status">Idle...</p>

    <audio id="player" controls></audio>

    <p><b>Länk till ljudfil (Supabase URL):</b></p>
    <input id="fileUrl" type="text" readonly />

    <br><br>

    <button id="uploadBtn">Ladda upp till Kenai</button>
    <button id="summarizeBtn">AI-transkribera & sammanfatta</button>

    <h3>AI-transkribering & sammanfattning:</h3>
    <textarea id="summary"></textarea>

    <br><br>

    <button id="pdfBtn">Ladda ner som PDF</button>

    <br><br>

    <input id="email" placeholder="Din e-postadress..." type="text" />
    <button id="mailBtn">Maila sammanfattning</button>
</div>


<script>
/* ============================
      SUPABASE KONFIG
============================ */

const SB_URL ='https://hywwzzzxgagqhlxooekz.supabase.co';   // <-- BYT
const SB_ANON ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';                    // <-- BYT
const BUCKET = "kenai-audio";
const FOLDER = "reviews";

/* ============================
      GLOBALA VARIABLER
============================ */

let mediaRecorder;
let audioChunks = [];
let audioBlob;
let wavBlob;
let stream;

/* ============================
      STARTA INSPELNING
============================ */

document.getElementById("startBtn").onclick = async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mime = MediaRecorder.isTypeSupported("audio/webm")
            ? "audio/webm"
            : "audio/mp4";

        mediaRecorder = new MediaRecorder(stream, { mimeType: mime });

        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = convertToWAV;

        mediaRecorder.start();
        document.getElementById("status").innerText = "Spelar in...";
    } catch (err) {
        alert("Kunde inte starta inspelning: " + err);
    }
};

/* ============================
      STOPPA INSPELNING
============================ */

document.getElementById("stopBtn").onclick = () => {
    if (!mediaRecorder) return;
    mediaRecorder.stop();
    stream.getTracks().forEach(t => t.stop());
    document.getElementById("status").innerText = "Stoppar...";
};

/* ============================
      KONVERTERA TILL WAV (16-bit PCM)
============================ */

async function convertToWAV() {
    const rawBlob = new Blob(audioChunks);
    const arrayBuf = await rawBlob.arrayBuffer();

    let audioCtx = new AudioContext({ sampleRate: 44100 });
    let decoded = await audioCtx.decodeAudioData(arrayBuf);

    let samples = decoded.getChannelData(0); // mono
    let wav = encodeWAV(samples, 44100);
    wavBlob = wav;

    document.getElementById("player").src = URL.createObjectURL(wavBlob);
    document.getElementById("status").innerText = "Inspelning klar!";
}

/* WAV-encoder 16-bit PCM */
function encodeWAV(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);

    function writeString(view, offset, str) {
        for (let i = 0; i < str.length; i++) view.setUint8(offset+i, str.charCodeAt(i));
    }

    writeString(view, 0, "RIFF");
    view.setUint32(4, 36 + samples.length * 2, true);
    writeString(view, 8, "WAVE");
    writeString(view, 12, "fmt ");
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(view, 36, "data");
    view.setUint32(40, samples.length * 2, true);

    let offset = 44;
    for (let i = 0; i < samples.length; i++, offset += 2) {
        let s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(offset, s * 0x7FFF, true);
    }
    return new Blob([view], { type: "audio/wav" });
}

/* ============================
      UPLOAD TILL SUPABASE
============================ */

document.getElementById("uploadBtn").onclick = async () => {
    if (!wavBlob) return alert("Ingen fil!");

    const fileName = `${Date.now()}.wav`;
    const path = `${FOLDER}/${fileName}`;

    const res = await fetch(`${SB_URL}/storage/v1/object/${BUCKET}/${path}`, {
        method: "POST",
        headers: {
            "Content-Type": "audio/wav",
            "Authorization": "Bearer " + SB_ANON,
            "apikey": SB_ANON,
            "x-upsert": "true"
        },
        body: wavBlob
    });

    if (!res.ok) return alert("Upload misslyckades!");

    const publicUrl = `${SB_URL}/storage/v1/object/public/${BUCKET}/${path}`;

    document.getElementById("fileUrl").value = publicUrl;
    document.getElementById("status").innerText = "Uppladdad!";
};

/* ============================
      AI-SAMMANFATTNING
============================ */

document.getElementById("summarizeBtn").onclick = async () => {
    const url = document.getElementById("fileUrl").value;
    if (!url) return alert("Ingen ljudfil!");

    document.getElementById("status").innerText = "Skickar till AI...";

    const res = await fetch("/api/summarize", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
    });

    const data = await res.json();

    if (!res.ok) {
        alert("AI fel: " + data.error);
        document.getElementById("status").innerText = "Misslyckades.";
        return;
    }

    document.getElementById("summary").value = data.summary;
    document.getElementById("status").innerText = "AI sammanfattning klar!";
};

/* ============================
      PDF EXPORT
============================ */

document.getElementById("pdfBtn").onclick = async () => {
    const text = document.getElementById("summary").value;
    if (!text.trim()) return alert("Ingen text att exportera!");

    const res = await fetch("/api/export-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text })
    });

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "summary.pdf";
    a.click();
};

/* ============================
      SKICKA MAIL (mock)
============================ */

document.getElementById("mailBtn").onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const text = document.getElementById("summary").value;

    if (!email) return alert("Skriv e-post!");

    await fetch("/api/send-summary-email", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email, text })
    });

    alert("Skickat!");
};
</script>

</body>
</html>
