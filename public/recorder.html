<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kenai Recorder – Spela in, ladda upp & AI-sammanfatta</title>

  <!-- Supabase JS (för upload) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --card-inner: #020817;
      --border: rgba(148, 163, 184, 0.5);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, #0ea5e9 0, #020617 35%) no-repeat,
        radial-gradient(circle at bottom right, #6366f1 0, #020617 40%) no-repeat,
        var(--bg);
      background-attachment: fixed;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    .kr-shell {
      max-width: 960px;
      width: 100%;
      padding: 32px 16px 40px;
    }

    .kr-card {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.08), rgba(15, 23, 42, 0.96));
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 24px 50px rgba(15, 23, 42, 0.9);
      padding: 20px 20px 24px;
    }

    .kr-header {
      margin-bottom: 18px;
    }

    .kr-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .kr-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .kr-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .kr-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .kr-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 14px;
    }

    .kr-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      transition: all 0.12s ease-out;
    }

    .kr-btn-primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #f9fafb;
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.5);
    }

    .kr-btn-secondary {
      background: rgba(15, 23, 42, 0.7);
    }

    .kr-btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .kr-btn:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.7);
      border-color: #e5e7eb;
    }

    .kr-audio-wrap {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      padding: 10px 12px;
      margin-bottom: 14px;
    }

    audio {
      width: 100%;
    }

    .kr-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .kr-input,
    .kr-textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 13px;
      padding: 8px 10px;
      outline: none;
    }

    .kr-input::placeholder,
    .kr-textarea::placeholder {
      color: #6b7280;
    }

    .kr-input:focus,
    .kr-textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.6);
    }

    .kr-textarea {
      min-height: 220px;
      resize: vertical;
      line-height: 1.45;
    }

    .kr-section-title {
      font-size: 13px;
      font-weight: 600;
      margin: 14px 0 6px;
    }

    .kr-footer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 14px;
    }

    .kr-email {
      flex: 1;
      min-width: 180px;
    }

    .kr-status {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      white-space: pre-line;
    }

    .kr-status-error {
      color: var(--danger);
    }

    @media (max-width: 768px) {
      .kr-shell {
        padding: 20px 12px 28px;
      }
      .kr-card {
        padding: 16px 14px 20px;
      }
      .kr-title {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="kr-shell">
    <div class="kr-card">
      <div class="kr-header">
        <div class="kr-badge">
          <span class="kr-dot"></span>
          <span>Kenai Recorder • Beta</span>
        </div>
        <h1 class="kr-title">Kenai Recorder</h1>
        <p class="kr-subtitle">
          Spela in ljud direkt i webbläsaren, ladda upp till Kenai och låt AI transkribera & sammanfatta.
          Exportera sammanfattningen som PDF.
        </p>
      </div>

      <!-- Inspelning -->
      <div class="kr-row">
        <button id="startBtn" class="kr-btn kr-btn-primary">Starta inspelning</button>
        <button id="stopBtn" class="kr-btn kr-btn-secondary" disabled>Stoppa</button>
        <span id="timer" class="kr-subtitle"></span>
      </div>

      <div class="kr-audio-wrap">
        <audio id="audioPlayer" controls></audio>
      </div>

      <!-- URL / Supabase-länk -->
      <div class="kr-section">
        <div class="kr-label">Länk till ljudfil (Supabase URL):</div>
        <input
          id="audioUrlInput"
          class="kr-input"
          type="text"
          placeholder="Här dyker länken upp efter uppladdning..."
          readonly
        />
        <div class="kr-row" style="margin-top:10px;">
          <button id="uploadBtn" class="kr-btn kr-btn-secondary">Ladda upp till Kenai</button>
          <button id="aiBtn" class="kr-btn kr-btn-primary">AI-transkribera & sammanfatta</button>
        </div>
      </div>

      <!-- Sammanfattning -->
      <div class="kr-section">
        <div class="kr-section-title">AI-transkribering & sammanfattning:</div>
        <textarea
          id="summary"
          class="kr-textarea"
          placeholder="Här kommer transkriberingen och sammanfattningen..."
        ></textarea>
      </div>

      <div class="kr-footer-row">
        <button id="pdfBtn" class="kr-btn kr-btn-secondary">Ladda ner som PDF</button>

        <input
          id="emailInput"
          type="email"
          class="kr-input kr-email"
          placeholder="Din e-postadress..."
        />
        <button id="emailBtn" class="kr-btn kr-btn-secondary">Maila sammanfattning</button>
      </div>

      <div id="status" class="kr-status">
        [Kenai Recorder] redo.
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // KONFIG – ÄNDRA DESSA VÄRDEN
    // ==========================

    // TODO: FYLL I dina riktiga supabase-värden här:
    const SB_URL ='https://hywwzzzxgagqhlxooekz.supabase.co'; // <-- BYT
    const SB_ANON ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';               // <-- BYT
    const SB_BUCKET = "kenai-audio";                       // eller ditt bucket-namn
    const SB_PREFIX = "reviews";                           // prefix i bucket

    const supabase = window.Supabase
      ? window.Supabase.createClient(SB_URL, SB_ANON)
      : supabasejs.createClient(SB_URL, SB_ANON); // fallback om namnet skiljer sig

    // ==========================
    // DOM-refs
    // ==========================
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const aiBtn = document.getElementById("aiBtn");
    const pdfBtn = document.getElementById("pdfBtn");
    const emailBtn = document.getElementById("emailBtn");
    const audioPlayer = document.getElementById("audioPlayer");
    const audioUrlInput = document.getElementById("audioUrlInput");
    const summaryEl = document.getElementById("summary");
    const emailInput = document.getElementById("emailInput");
    const statusEl = document.getElementById("status");
    const timerEl = document.getElementById("timer");

    // ==========================
    // Recorder state
    // ==========================
    let mediaRecorder = null;
    let chunks = [];
    let audioBlob = null;
    let recordingStart = null;
    let timerInterval = null;

    function setStatus(msg, isError = false) {
      console.log(msg);
      statusEl.textContent = msg;
      statusEl.classList.toggle("kr-status-error", isError);
    }

    function updateTimer() {
      if (!recordingStart) return;
      const diff = Math.floor((Date.now() - recordingStart) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, "0");
      const s = String(diff % 60).padStart(2, "0");
      timerEl.textContent = `${m}:${s}`;
    }

    async function startRecording() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("Din webbläsare stöder inte ljudinspelning.");
          return;
        }

        setStatus("[Kenai Recorder] Begär mikrofon-tillgång...");
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        chunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };
        mediaRecorder.onstop = () => {
          clearInterval(timerInterval);
          timerInterval = null;
          timerEl.textContent = "";
          recordingStart = null;

          audioBlob = new Blob(chunks, { type: "audio/webm" });
          const localUrl = URL.createObjectURL(audioBlob);
          audioPlayer.src = localUrl;
          audioPlayer.play().catch(() => {});
          setStatus("[Kenai Recorder] Inspelning stoppad – redo att ladda upp.");
        };

        mediaRecorder.start();
        recordingStart = Date.now();
        timerInterval = setInterval(updateTimer, 500);

        startBtn.disabled = true;
        stopBtn.disabled = false;
        setStatus("[Kenai Recorder] Spelar in...");
      } catch (err) {
        console.error(err);
        setStatus("[Kenai Recorder] Kunde inte starta inspelning (mikrofonfel).", true);
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        setStatus("[Kenai Recorder] Stoppar inspelning...");
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach((t) => t.stop());
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    async function uploadToSupabase() {
      try {
        if (!audioBlob) {
          alert("Spela in något först.");
          return;
        }
        setStatus("[Kenai Recorder] Laddar upp till Supabase...");

        const fileName = `review_${Date.now()}.webm`;
        const filePath = `${SB_PREFIX}/${fileName}`;

        const { data, error } = await supabase.storage.from(SB_BUCKET).upload(filePath, audioBlob, {
          contentType: "audio/webm",
          upsert: false,
        });

        if (error) {
          console.error(error);
          setStatus("[Kenai Recorder] Uppladdning misslyckades.", true);
          return;
        }

        const { data: pub } = supabase.storage.from(SB_BUCKET).getPublicUrl(filePath);
        const url = pub?.publicUrl;
        if (!url) {
          setStatus("[Kenai Recorder] Kunde inte hämta publik URL.", true);
          return;
        }

        audioUrlInput.value = url;
        setStatus("[Kenai Recorder] Uppladdad! Länk insatt i fältet.");
      } catch (err) {
        console.error(err);
        setStatus("[Kenai Recorder] Tekniskt fel vid uppladdning.", true);
      }
    }

    async function summarizeWithAI() {
      try {
        const url = audioUrlInput.value.trim();
        if (!url) {
          alert("Ladda upp ljudet först så att det finns en URL.");
          return;
        }
        setStatus("[Kenai Recorder] Skickar till AI för transkribering & sammanfattning...");

        const res = await fetch("/api/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ audioUrl: url, locale: "sv-SE" }),
        });

        if (!res.ok) {
          const t = await res.text();
          console.error("Summarize error:", t);
          setStatus("[Kenai Recorder] AI-sammanfattning misslyckades.", true);
          return;
        }

        const data = await res.json();
        const text =
          data.summary ||
          data.text ||
          data.content ||
          JSON.stringify(data, null, 2);

        summaryEl.value = text;
        setStatus("[Kenai Recorder] AI-sammanfattning klar.");
      } catch (err) {
        console.error(err);
        setStatus("[Kenai Recorder] Tekniskt fel vid AI-sammanfattning.", true);
      }
    }

    async function downloadPdf() {
      try {
        const content = summaryEl.value.trim();
        if (!content) {
          alert("Det finns ingen sammanfattning att ladda ner.");
          return;
        }
        setStatus("[Kenai Recorder] Skapar PDF...");

        const res = await fetch("/api/export-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content }),
        });

        if (!res.ok) {
          const t = await res.text();
          console.error("PDF error:", t);
          setStatus("[Kenai Recorder] PDF-export misslyckades.", true);
          return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "kenai-sammanfattning.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus("[Kenai Recorder] PDF nedladdad.");
      } catch (err) {
        console.error(err);
        setStatus("[Kenai Recorder] Tekniskt fel vid PDF-export.", true);
      }
    }

    async function emailSummary() {
      try {
        const email = emailInput.value.trim();
        const content = summaryEl.value.trim();
        if (!email) {
          alert("Skriv in en e-postadress.");
          return;
        }
        if (!content) {
          alert("Det finns ingen sammanfattning att skicka.");
          return;
        }

        setStatus("[Kenai Recorder] Skickar sammanfattning via e-post...");

        const res = await fetch("/api/send-summary-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, content }),
        });

        if (!res.ok) {
          const t = await res.text();
          console.error("Email error:", t);
          setStatus("[Kenai Recorder] Kunde inte skicka e-post.", true);
          return;
        }

        setStatus("[Kenai Recorder] Sammanfattning skickad via e-post (mock).");
        alert("I denna version loggas bara mailet på servern som test.");
      } catch (err) {
        console.error(err);
        setStatus("[Kenai Recorder] Tekniskt fel vid mail-sändning.", true);
      }
    }

    // Ereignkoppling
    startBtn.addEventListener("click", startRecording);
    stopBtn.addEventListener("click", stopRecording);
    uploadBtn.addEventListener("click", uploadToSupabase);
    aiBtn.addEventListener("click", summarizeWithAI);
    pdfBtn.addEventListener("click", downloadPdf);
    emailBtn.addEventListener("click", emailSummary);
  </script>
</body>
</html>
