<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kenai Recorder</title>
  <style>
    :root{
      --bg:#050914; --card:#0b1224; --card2:#0e1730; --txt:#eaf1ff; --muted:#94a3b8;
      --a:#38bdf8; --b:#60a5fa; --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:radial-gradient(1200px 700px at 50% 30%, rgba(56,189,248,.10), transparent 60%),
                 radial-gradient(900px 600px at 50% 70%, rgba(96,165,250,.10), transparent 60%),
                 var(--bg);
      color:var(--txt); font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    .wrap{width:min(520px, 92vw); padding:24px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:18px; padding:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    h1{margin:0 0 6px; font-size:18px}
    .sub{color:var(--muted); font-size:12px; margin-bottom:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{
      border:1px solid var(--border); border-radius:999px; padding:10px 14px; cursor:pointer;
      background:rgba(255,255,255,.06); color:var(--txt); font-weight:600;
    }
    button.primary{background:linear-gradient(90deg, rgba(56,189,248,.25), rgba(96,165,250,.25))}
    button.danger{background:rgba(239,68,68,.18)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .status{margin:10px 0 8px; color:var(--muted); font-size:12px}
    .log{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:rgba(0,0,0,.25); border:1px solid var(--border);
      border-radius:12px; padding:10px; font-size:12px; color:#cbd5e1; min-height:46px;
      white-space:pre-wrap;
    }
    .field{width:100%; margin-top:10px}
    input, textarea{
      width:100%; background:rgba(0,0,0,.25); color:var(--txt);
      border:1px solid var(--border); border-radius:12px; padding:10px; outline:none;
    }
    textarea{min-height:160px; resize:vertical}
    audio{width:100%}
    .tiny{font-size:11px;color:var(--muted); margin-top:8px}
    .footer{margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Spela in & f√• AI-sammanfattning</h1>
      <div class="sub">1) Spela in ¬∑ 2) Ladda upp ¬∑ 3) AI transkriberar & sammanfattar</div>

      <div class="row">
        <button id="startBtn" class="danger">‚óè Starta inspelning</button>
        <button id="stopBtn" disabled>‚ñ† Stoppa</button>
        <button id="runBtn" class="primary" disabled>‚¨Ü Ladda upp & transkribera</button>
        <div style="margin-left:auto;color:var(--muted);font-size:12px">‚è± <span id="timer">00:00</span></div>
      </div>

      <div class="status" id="status">Redo att spela in</div>
      <div class="log" id="log"></div>

      <div class="field" style="margin-top:12px">
        <audio id="player" controls></audio>
      </div>

      <div class="field">
        <div class="sub" style="margin:10px 0 6px">Supabase public URL (fylls i automatiskt)</div>
        <input id="urlInput" placeholder="https://... (public url)" readonly />
      </div>

      <div class="field">
        <div class="sub" style="margin:10px 0 6px">AI-sammanfattning</div>
        <textarea id="summary" placeholder="Sammanfattningen dyker upp h√§r n√§r AI √§r klar..."></textarea>
        <p id="ai-status" style="font-size: 12px; color: #8cd9ff; margin-top: 6px; min-height: 1.2em;">
  <!-- AI-status visas h√§r -->
</p>

      </div>

      <div class="footer">
        <button id="pdfBtn" disabled>Ladda ner som PDF</button>
        <input id="emailInput" placeholder="Din e-post (valfritt)" style="flex:1; min-width:220px" />
        <button id="mailBtn" disabled>Maila (mock)</button>
      </div>

      <div class="tiny">Obs: favicon 404 √§r irrelevant. Viktigast: /api/health och /api/summarize ska funka.</div>
    </div>
  </div>

<script>
/** === FYLL I DINA V√ÑRDEN H√ÑR (ta fr√•n din nuvarande fil) === */
const SUPABASE_URL ='https://hywwzzzxgagqhlxooekz.supabase.co';
const SUPABASE_ANON_KEY ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';
const SUPABASE_BUCKET = "kenai-audio";
const SUPABASE_FOLDER = "reviews";
/** =========================================================== */

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const startBtn = document.getElementById("startBtn");
const stopBtn  = document.getElementById("stopBtn");
const runBtn   = document.getElementById("runBtn");
const pdfBtn   = document.getElementById("pdfBtn");
const mailBtn  = document.getElementById("mailBtn");
const emailInput = document.getElementById("emailInput");
const statusEl = document.getElementById("status");
const statusEl = document.getElementById("status");
const aiStatusEl = document.getElementById("ai-status");
const logEl = document.getElementById("log");
const timerEl = document.getElementById("timer");
const player = document.getElementById("player");
const urlInput = document.getElementById("urlInput");
const summaryEl = document.getElementById("summary");

let mediaRecorder = null;
let chunks = [];
let recordingBlob = null;
let publicUrl = "";     // <-- FIX: finns alltid
let timerId = null;
let startTime = 0;

function setStatus(t){ statusEl.textContent = t; console.log("STATUS:", t); }
function setLog(t){ logEl.textContent = t; console.log("LOG:", t); }
function fmt(sec){
  const m = Math.floor(sec/60); const s = sec%60;
  return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
}
function startTimer(){
  startTime = Date.now();
  timerEl.textContent = "00:00";
  if (timerId) clearInterval(timerId);
  timerId = setInterval(()=> {
    const sec = Math.floor((Date.now()-startTime)/1000);
    timerEl.textContent = fmt(sec);
  }, 250);
}
function stopTimer(){
  if (timerId) clearInterval(timerId);
  timerId = null;
}

function pickMime(){
  const prefs = [
    "audio/webm;codecs=opus",
    "audio/webm",
    "audio/mp4", // om browser st√∂djer
    "audio/mpeg",
  ];
  for (const m of prefs) {
    try { if (MediaRecorder.isTypeSupported(m)) return m; } catch {}
  }
  return "";
}

async function startRecording(){
  setLog("");
  summaryEl.value = "";
  summaryEl.dataset.transcript = "";
  urlInput.value = "";
  publicUrl = "";
  recordingBlob = null;
  chunks = [];

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const mimeType = pickMime();
  mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

  mediaRecorder.ondataavailable = (e)=> { if (e.data && e.data.size>0) chunks.push(e.data); };
  mediaRecorder.onstop = ()=> {
    stopTimer();
    const type = mediaRecorder.mimeType || (chunks[0]?.type) || "audio/webm";
    recordingBlob = new Blob(chunks, { type });
    const url = URL.createObjectURL(recordingBlob);
    player.src = url;

    setStatus("Inspelning klar ‚Äî redo att ladda upp");
    setLog(`Filstorlek: ${(recordingBlob.size/1024).toFixed(1)} kB\nMIME: ${type}`);
    runBtn.disabled = false;

    // st√§ng mic
    stream.getTracks().forEach(t=>t.stop());
  };

  mediaRecorder.start();
  startTimer();
  setStatus("Spelar in‚Ä¶");
  runBtn.disabled = true;
  pdfBtn.disabled = true;
  mailBtn.disabled = true;
  stopBtn.disabled = false;
  startBtn.disabled = true;
}

function stopRecording(){
  if (!mediaRecorder) return;
  try { mediaRecorder.stop(); } catch {}
  stopBtn.disabled = true;
  startBtn.disabled = false;
}

async function uploadToSupabase(blob){
  const ts = new Date().toISOString().replace(/[:.]/g,"-");
  const ext = (blob.type.includes("mp4") || blob.type.includes("m4a")) ? "m4a"
            : (blob.type.includes("mpeg") || blob.type.includes("mp3")) ? "mp3"
            : (blob.type.includes("wav")) ? "wav"
            : "webm";
  const filename = `${ts}.${ext}`;
  const pathInBucket = `${SUPABASE_FOLDER}/${filename}`;

  setStatus("Laddar upp till Supabase‚Ä¶");
  const { error } = await sb.storage.from(SUPABASE_BUCKET).upload(pathInBucket, blob, {
    upsert: true,
    contentType: blob.type || "application/octet-stream",
  });
  if (error) throw new Error("Supabase upload error: " + error.message);

  const { data } = sb.storage.from(SUPABASE_BUCKET).getPublicUrl(pathInBucket);
  if (!data?.publicUrl) throw new Error("Kunde inte skapa public URL.");

  return data.publicUrl;
}

async function callSummarize(url){
  setStatus("Skickar till AI f√∂r transkribering‚Ä¶");
    if (aiStatusEl) {
    aiStatusEl.textContent = "AI jobbar‚Ä¶ v√§nta lite üîÑ";
  }
  const backendBase = window.location.origin;

  const res = await fetch(`${backendBase}/api/summarize`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ url }), // <-- server accepterar url eller audioUrl
  });

  // L√§s alltid text f√∂rst s√• du f√•r riktig feltext
  const txt = await res.text();
  let json = null;
  try { json = JSON.parse(txt); } catch {}

  if (!res.ok) {
    const msg = (json && (json.error || json.message)) ? (json.error || json.message) : txt;
    throw new Error(`Backend-fel: ${res.status} ${String(msg).slice(0, 300)}`);
  }
    if (!json?.summary) throw new Error("Ok√§nt AI-fel: saknar summary i svar.");

  if (aiStatusEl) {
    aiStatusEl.textContent = "";
  }

  return json;
}

async function uploadAndSummarize(){
  try{
    runBtn.disabled = true;
    setLog("Laddar upp fil‚Ä¶");

    if (!recordingBlob) throw new Error("Ingen inspelning hittades.");

    publicUrl = await uploadToSupabase(recordingBlob);
    urlInput.value = publicUrl;
    setLog(`Uppladdning klar.\nPublic URL:\n${publicUrl}`);

    const result = await callSummarize(publicUrl);

    const out =
      `SAMMANFATTNING\n${result.summary}\n\n` +
      `TRANSKRIPT\n${result.transcript || ""}`;

    summaryEl.value = out;
    summaryEl.dataset.transcript = result.transcript || "";

    setStatus("AI-sammanfattning klar ‚úÖ");
    pdfBtn.disabled = false;
    mailBtn.disabled = false;
    setLog("Transkription & sammanfattning lyckades.");
     if (aiStatusEl) {
      aiStatusEl.textContent = "Kunde inte h√§mta svar fr√•n AI üíÄ";
    }


async function downloadPdf(){
  try{
    const backendBase = window.location.origin;
    const summary = summaryEl.value || "";
    const transcript = summaryEl.dataset.transcript || "";

    if (!summary.trim()) return setLog("Ingen sammanfattning att exportera.");

    setStatus("Skapar PDF‚Ä¶");
    const res = await fetch(`${backendBase}/api/export-pdf`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ summary, transcript }),
    });

    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`PDF-fel: ${res.status} ${t}`);
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "kenai-sammanfattning.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus("PDF nedladdad ‚úÖ");
  }catch(err){
    setLog(err.message || String(err));
  }
}

async function mailSummary(){
  try{
    const to = (emailInput.value || "").trim();
    const summary = summaryEl.value || "";
    const transcript = summaryEl.dataset.transcript || "";

    const backendBase = window.location.origin;
    setStatus("Mailar (mock)‚Ä¶");

    const res = await fetch(`${backendBase}/api/send-summary-email`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ to, summary, transcript }),
    });

    const txt = await res.text();
    if (!res.ok) throw new Error(`Mail-fel: ${res.status} ${txt}`);
    setStatus("Mail (mock) skickat ‚úÖ");
    setLog("Mock-mail skickat (kolla server-loggar).");
  }catch(err){
    setLog(err.message || String(err));
  }
}

startBtn.onclick = startRecording;
stopBtn.onclick = stopRecording;
runBtn.onclick = uploadAndSummarize;
pdfBtn.onclick = downloadPdf;
mailBtn.onclick = mailSummary;
</script>
</body>
</html>
