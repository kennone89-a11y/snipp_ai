<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kenai Recorder</title>

  <!-- BYT TILL DINA EGNA SUPABASE-V√ÑRDEN (utan extra mellanslag!) -->
  <meta name='https://hywwzzzxgagqhlxooekz.supabase.co';
  <meta name='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #092061 0, #020617 45%, #000000 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
    }

    .page {
      width: 100%;
      max-width: 640px;
    }

    .card {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 18px;
      padding: 24px 22px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(56, 189, 248, 0.14);
    }

    h1 {
      font-size: 1.5rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #f9fafb;
      margin-bottom: 4px;
    }

    .sub {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: #0b1020;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(236, 72, 153, 0.45);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    button.secondary {
      background: #0b1120;
      color: #e5e7eb;
      box-shadow: 0 0 0 rgba(0, 0, 0, 0.0);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(236, 72, 153, 0.65);
    }

    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 4px;
      min-height: 1.2em;
    }

    audio {
      width: 100%;
      margin-top: 12px;
      border-radius: 999px;
      background-color: #020617;
    }

    .link-wrap {
      margin-top: 14px;
      font-size: 0.8rem;
    }

    .link-wrap label {
      display: block;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    #shareLink {
      width: 100%;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      display: none;
    }

    .hint {
      margin-top: 10px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .top-link {
      font-size: 0.75rem;
      margin-bottom: 8px;
    }

    .top-link a {
      color: #38bdf8;
      text-decoration: none;
    }

    .top-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <div class="top-link">
        Nytt: <a href="reels.html">Testa Kenai Reels (tidig test)</a>
      </div>

      <h1>Kenai Recorder</h1>
      <div class="sub">Snabb r√∂stinspelning med delbar l√§nk (Supabase).</div>

      <div class="row">
        <button id="recordBtn">üéôÔ∏è Starta inspelning</button>
        <button id="stopBtn" class="secondary">‚èπÔ∏è Stoppa</button>
        <button id="uploadBtn" class="secondary">‚òÅÔ∏è Ladda upp</button>
      </div>

      <div id="status" class="status">Redo. Klicka ‚ÄùStarta inspelning‚Äù.</div>

      <audio id="player" controls></audio>

      <div class="link-wrap">
        <label for="shareLink">Delbar l√§nk (Supabase):</label>
        <input id="shareLink" type="text" readonly />
      </div>

      <div class="hint">
        Tips: Spela in korta klipp (t.ex. podd-recensioner), ladda upp, och klistra in l√§nken d√§r du vill dela.
      </div>
    </div>
  </div>

  <script>
    (function () {
      const SB_URL_META = document.querySelector('meta[name="supabase-url"]');
      const SB_KEY_META = document.querySelector('meta[name="supabase-key"]');
      const SB_URL = SB_URL_META ? SB_URL_META.content.trim() : "";
      const SB_KEY = SB_KEY_META ? SB_KEY_META.content.trim() : "";

      const recordBtn = document.getElementById("recordBtn");
      const stopBtn = document.getElementById("stopBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const statusEl = document.getElementById("status");
      const audioEl = document.getElementById("player");
      const linkEl = document.getElementById("shareLink");

      let mediaRecorder = null;
      let chunks = [];
      let currentBlob = null;
      let currentFilename = null;

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      async function startRecording() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          setStatus("Din webbl√§sare st√∂djer tyv√§rr inte inspelning.");
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

          chunks = [];
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
              chunks.push(e.data);
            }
          };

          mediaRecorder.onstop = () => {
            const blob = new Blob(chunks, { type: "audio/webm" });
            currentBlob = blob;
            currentFilename = "rec_" + Date.now() + ".webm";

            audioEl.src = URL.createObjectURL(blob);
            audioEl.play().catch(() => {});

            uploadBtn.disabled = false;
            setStatus("Inspelning klar. Spela upp eller klicka ‚ÄùLadda upp‚Äù.");
          };

          mediaRecorder.start();

          recordBtn.disabled = true;
          stopBtn.disabled = false;
          uploadBtn.disabled = true;
          linkEl.style.display = "none";
          setStatus("Spelar in...");
        } catch (err) {
          console.error(err);
          setStatus("Kunde inte starta inspelning: " + err.message);
        }
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          recordBtn.disabled = false;
          stopBtn.disabled = true;
          setStatus("Stoppar inspelning...");
        }
      }

      async function uploadRecording() {
        if (!currentBlob) {
          setStatus("Ingen inspelning att ladda upp.");
          return;
        }
        if (!SB_URL || !SB_KEY) {
          setStatus("Supabase URL eller key saknas i &lt;meta&gt;-taggarna.");
          return;
        }

        const bucketPath = "audio/reviews/" + currentFilename;
        const base = SB_URL.replace(/\/+$/, "");
        const uploadUrl = base + "/storage/v1/object/" + bucketPath;

        setStatus("Laddar upp till Supabase...");
        uploadBtn.disabled = true;

        try {
          const resp = await fetch(uploadUrl, {
            method: "POST",
            headers: {
              "Content-Type": currentBlob.type || "audio/webm",
              Authorization: "Bearer " + SB_KEY,
              apikey: SB_KEY,
              "x-upsert": "true",
            },
            body: currentBlob,
          });

          if (!resp.ok) {
            const text = await resp.text();
            console.error("Upload error", resp.status, text);
            throw new Error("Supabase " + resp.status);
          }

          const publicBase = base + "/storage/v1/object/public/";
          const publicUrl = publicBase + bucketPath;

          linkEl.value = publicUrl;
          linkEl.style.display = "block";
          setStatus("Uppladdning klar ‚úÖ L√§nken √§r redo att kopieras.");
        } catch (err) {
          console.error(err);
          uploadBtn.disabled = false;
          setStatus("Fel vid uppladdning: " + err.message);
        }
      }

      // Init-knappar
      stopBtn.disabled = true;
      uploadBtn.disabled = true;
      setStatus("Redo. Klicka ‚ÄùStarta inspelning‚Äù.");

      recordBtn.addEventListener("click", startRecording);
      stopBtn.addEventListener("click", stopRecording);
      uploadBtn.addEventListener("click", uploadRecording);
    })();
  </script>
</body>
</html>
