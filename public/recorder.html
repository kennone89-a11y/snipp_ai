<!-- public/recorder.html -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Kenai Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: #e5e7eb;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 480px;
      padding: 24px;
      box-sizing: border-box;
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      padding: 20px 18px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(18px);
    }

    h1 {
      font-size: 22px;
      margin: 0 0 4px 0;
      text-align: center;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 16px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.4);
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.3), transparent);
      color: #e0f2fe;
      margin: 0 auto 10px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .timer {
      font-variant-numeric: tabular-nums;
      font-size: 18px;
      font-weight: 600;
      color: #e5e7eb;
    }

    .status-label {
      font-size: 12px;
      color: #9ca3af;
    }

    .status-value {
      font-size: 13px;
      color: #e5e7eb;
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 10px 0 14px 0;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 12px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    button:disabled {
      opacity: 0.35;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-red {
      background: radial-gradient(circle at top left, #f97373, #ef4444);
      color: white;
      box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
    }

    .btn-red:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(239, 68, 68, 0.55);
    }

    .btn-blue {
      background: radial-gradient(circle at top left, #38bdf8, #2563eb);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
    }

    .btn-blue:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.55);
    }

    .btn-secondary {
      background: rgba(30, 64, 175, 0.1);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.4);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(30, 64, 175, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.6);
    }

    audio {
      width: 100%;
      margin: 6px 0 4px 0;
    }

    .small-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      padding: 8px 10px;
      font-size: 12px;
      box-sizing: border-box;
      outline: none;
    }

    textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    .status-box {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      min-height: 16px;
      white-space: pre-line;
    }

    .email-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .email-row input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
      padding: 7px 10px;
      font-size: 12px;
      outline: none;
      box-sizing: border-box;
    }

    .email-row input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.5);
    }

    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .hint {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    .divider {
      margin: 12px 0;
      border-top: 1px dashed rgba(75, 85, 99, 0.6);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div style="text-align:center; margin-bottom: 4px;">
        <div class="pill">
          <span class="pill-dot"></span>
          <span>Kenai Recorder ‚Ä¢ live</span>
        </div>
      </div>
      <h1>Spela in & f√• AI-sammanfattning</h1>
      <div class="subtitle">
        1. Spela in ¬∑ 2. Ladda upp ¬∑ 3. L√•t AI sammanfatta p√• svenska.
      </div>

      <div class="status-row">
        <div>
          <div class="status-label">Status</div>
          <div id="statusLabel" class="status-value">Redo att spela in</div>
        </div>
        <div class="timer" id="timer">00:00</div>
      </div>

      <div class="btn-row">
        <button id="startBtn" class="btn-red">
          ‚óè Starta inspelning
        </button>
        <button id="stopBtn" class="btn-secondary" disabled>
          ‚ñ† Stoppa
        </button>
      </div>

      <button id="uploadBtn" class="btn-blue" style="width:100%; margin-bottom:10px;" disabled>
        ‚¨Ü Ladda upp & transkribera
      </button>

      <div class="small-label">Inspelning:</div>
      <audio id="player" controls></audio>

      <div class="hint">
        Max ~2 minuter. Inspelningen stoppas automatiskt vid 2:00.
      </div>

      <div class="divider"></div>

      <div class="section-title">AI-sammanfattning</div>
      <textarea id="summary" placeholder="Sammanfattningen dyker upp h√§r n√§r AI √§r klar..." readonly></textarea>
      <div id="statusBox" class="status-box"></div>

      <div class="btn-row" style="margin-top:10px;">
        <button id="downloadPdfBtn" class="btn-secondary" disabled>
          ‚¨á Ladda ner PDF
        </button>
        <button id="sendEmailBtn" class="btn-secondary" disabled>
          ‚úâ Maila (mock)
        </button>
      </div>

      <div class="email-row">
        <input id="emailInput" type="email" placeholder="Din e-post (f√∂r framtida riktig mail-funktion)" />
      </div>

      <div class="hint">
        Mailfunktionen √§r just nu bara mock (loggar p√• servern), men allt annat √§r p√• riktigt.
      </div>
    </div>
  </div>

  <script>
    // üîë FYLL I DINA SUPABASE-V√ÑRDEN H√ÑR
    // Dessa √§r de "publika" (anon/publishable) nycklarna, som du redan anv√§nder i andra delar av Kenai.
    const SUPABASE_URL ='https://hywwzzzxgagqhlxooekz.supabase.co'; // <-- byt till din URL
    const SUPABASE_ANON_KEY ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA'; // <-- byt till din anon key
    const SUPABASE_BUCKET = 'kenai-audio'; // t.ex. 'kenai-audio'
    const SUPABASE_FOLDER = 'reviews';     // t.ex. 'reviews'

    // Skapa Supabase-klient via CDN
    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const timerEl = document.getElementById('timer');
    const statusLabel = document.getElementById('statusLabel');
    const statusBox = document.getElementById('statusBox');
    const player = document.getElementById('player');
    const summaryEl = document.getElementById('summary');
    const emailInput = document.getElementById('emailInput');

    let mediaRecorder = null;
    let chunks = [];
    let recordingBlob = null;
    let timerInterval = null;
    let startTime = null;

    function setStatus(text) {
      statusLabel.textContent = text;
      console.log('STATUS:', text);
    }

    function setLog(text) {
      statusBox.textContent = text || '';
      console.log('LOG:', text);
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    function startTimer() {
      startTime = Date.now();
      timerEl.textContent = '00:00';
      if (timerInterval) clearInterval(timerInterval);

      timerInterval = setInterval(() => {
        const diffSec = Math.floor((Date.now() - startTime) / 1000);
        timerEl.textContent = formatTime(diffSec);

        // Auto-stop vid 2:00 (120s)
        if (diffSec >= 120 && mediaRecorder && mediaRecorder.state === 'recording') {
          setStatus('Auto-stop vid 2:00');
          stopRecording();
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    async function startRecording() {
      try {
        chunks = [];
        recordingBlob = null;
        summaryEl.value = '';
        setLog('');

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          stopTimer();
          const blob = new Blob(chunks, { type: 'audio/webm' });
          recordingBlob = blob;
          const url = URL.createObjectURL(blob);
          player.src = url;
          uploadBtn.disabled = false;
          setStatus('Inspelning klar ‚Äì redo att ladda upp');
          setLog(`Filstorlek: ${(blob.size / 1024).toFixed(1)} kB`);
        };

        mediaRecorder.start();
        startTimer();
        setStatus('Spelar in...');
        setLog('Inspelning startad.');

        startBtn.disabled = true;
        stopBtn.disabled = false;
        uploadBtn.disabled = true;
      } catch (err) {
        console.error(err);
        setStatus('Kunde inte starta inspelning');
        setLog(err.message || String(err));
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach((t) => t.stop());
        stopBtn.disabled = true;
        startBtn.disabled = false;
      }
    }

    async function uploadAndSummarize() {
      try {
        if (!recordingBlob) {
          setLog('Ingen inspelning att ladda upp.');
          return;
        }

        setStatus('Laddar upp till Supabase...');
        setLog('Laddar upp fil...');

        uploadBtn.disabled = true;

        const fileExt = 'webm';
        const fileName = `kenai-${Date.now()}.${fileExt}`;
        const filePath = `${SUPABASE_FOLDER}/${fileName}`;

        const { data, error } = await supa.storage
          .from(SUPABASE_BUCKET)
          .upload(filePath, recordingBlob, {
            cacheControl: '3600',
            upsert: false,
            contentType: 'audio/webm',
          });

        if (error) {
          console.error('Upload error:', error);
          setStatus('Fel vid uppladdning');
          setLog(error.message || 'Ok√§nt Supabase-fel');
          uploadBtn.disabled = false;
          return;
        }

        setStatus('Uppladdning klar ‚Äì h√§mtar URL...');
        const { data: publicData } = supa.storage
          .from(SUPABASE_BUCKET)
          .getPublicUrl(filePath);

        const audioUrl = publicData.publicUrl;
        setLog('Publik URL: ' + audioUrl);

        setStatus('Skickar till AI f√∂r transkribering...');
        summaryEl.value = 'AI jobbar...';

       const backendBase = window.location.origin;

const resp = await fetch(`${backendBase}/api/summarize`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ url: publicUrl })
 // <-- VIKTIGT: exakt s√• h√§r
});

const raw = await resp.text();
let json;
try { json = JSON.parse(raw); }
catch { throw new Error(`Backend gav inte JSON (${resp.status}): ${raw.slice(0,200)}`); }

if (!resp.ok) throw new Error(json.error || `Backend-fel: ${resp.status}`);

summaryEl.value = json.summary || "";
summaryEl.dataset.transcript = json.transcript || "";


        setStatus('AI-sammanfattning klar');
        setLog('Transkription & sammanfattning lyckades.');

        // Aktivera PDF- & mailknappar
        downloadPdfBtn.disabled = false;
        sendEmailBtn.disabled = false;

        // Spara transcript i elementet (s√• vi kan skicka med till PDF / mail)
        summaryEl.dataset.transcript = json.transcript || '';
      } catch (err) {
        console.error(err);
        setStatus('Fel vid transkribering');
        setLog(err.message || String(err));
        uploadBtn.disabled = false;
      }
    }

    async function downloadPdf() {
      try {
        const summary = summaryEl.value || '';
        const transcript = summaryEl.dataset.transcript || '';

        if (!summary.trim()) {
          setLog('Ingen sammanfattning att exportera.');
          return;
        }

        setStatus('Skapar PDF...');
        const backendBase = window.location.origin;
        const res = await fetch(`${backendBase}/api/export-pdf`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ summary, transcript }),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(`PDF-fel: ${res.status} ${text}`);
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'kenai-sammanfattning.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        setStatus('PDF nedladdad');
        setLog('PDF skapad och nedladdad.');
      } catch (err) {
        console.error(err);
        setStatus('Fel vid PDF-export');
        setLog(err.message || String(err));
      }
    }

    async function sendMockEmail() {
      try {
        const summary = summaryEl.value || '';
        const transcript = summaryEl.dataset.transcript || '';
        const email = emailInput.value.trim();

        if (!summary.trim()) {
          setLog('Ingen sammanfattning att skicka.');
          return;
        }
        if (!email) {
          setLog('Skriv in en e-postadress f√∂rst (√§ven om det bara √§r f√∂r test).');
          return;
        }

        setStatus('Skickar (mock) mail...');
        const backendBase = window.location.origin;
        const res = await fetch(`${backendBase}/api/send-summary-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, summary, transcript }),
        });

        const json = await res.json();
        if (!res.ok || !json.ok) {
          throw new Error(json.error || 'Ok√§nt mail-fel');
        }

        setStatus('Mock-mail skickad (loggad p√• servern)');
        setLog('Kolla server-loggarna f√∂r att se vad som skickades.');
      } catch (err) {
        console.error(err);
        setStatus('Fel vid mock-mail');
        setLog(err.message || String(err));
      }
    }

    // Koppla knappar
    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
    uploadBtn.addEventListener('click', uploadAndSummarize);
    downloadPdfBtn.addEventListener('click', downloadPdf);
    sendEmailBtn.addEventListener('click', sendMockEmail);
  </script>
</body>
</html>
