<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kenai Recorder – Spela in, ladda upp & AI-sammanfatta</title>

  <!-- Supabase JS (för upload) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
  :root {
  --bg: #020617;
  --bg-soft: #02091c;
  --card: #0b1220;
  --accent: #38bdf8;
  --accent-soft: rgba(56, 189, 248, 0.12);
  --border: #1e293b;
  --text-main: #e5e7eb;
  --text-muted: #9ca3af;
  --danger: #f97373;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html,
body {
  height: 100%;
}

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
    "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #07172a, #020617 45%, #000 100%);
  color: var(--text-main);
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Topbar (blå remsa längst upp) */
.topbar {
  width: 100%;
  max-width: 960px;
  padding: 16px 24px 0;
  color: #e5e7eb;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand-logo {
  width: 32px;
  height: 32px;
  border-radius: 999px;
  background: radial-gradient(circle at 30% 30%, #38bdf8, #1d4ed8);
}

.brand-title {
  font-weight: 600;
  letter-spacing: 0.04em;
}

.brand-sub {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.pill {
  margin-top: 6px;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.pill-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 999px;
  margin-right: 6px;
  background: #22c55e;
}

/* Wrapper runt kortet */
.page {
  width: 100%;
  max-width: 960px;
  padding: 24px;
}

/* Själva kortet */
.card {
  background: radial-gradient(circle at top left, #111827, #020617);
  border-radius: 24px;
  border: 1px solid var(--border);
  padding: 24px 24px 28px;
  box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
}

/* Sektioner inuti kortet */
.section {
  margin-bottom: 18px;
}

.section-label {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 6px;
}

/* Rader */
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

/* Timer / status */
.status {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 2px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid #1f2937;
}

/* Knapp-stil */
button {
  border-radius: 999px;
  padding: 7px 16px;
  border: 1px solid transparent;
  cursor: pointer;
  font-size: 0.8rem;
  font-weight: 500;
  transition: background 0.12s ease-out, transform 0.12s ease-out,
    box-shadow 0.12s ease-out;
  white-space: nowrap;
}

button:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(15, 23, 42, 0.7);
}

button:disabled {
  opacity: 0.55;
  cursor: default;
  box-shadow: none;
}

button.primary {
  background: radial-gradient(circle at 0 0, #22c55e, #16a34a);
  color: #0b1120;
}

button.secondary {
  background: rgba(15, 23, 42, 0.9);
  border-color: #4b5563;
  color: #e5e7eb;
}

/* Inputs / textarea */
input,
textarea {
  width: 100%;
  border-radius: 10px;
  border: 1px solid #4b5563;
  background: rgba(15, 23, 42, 0.9);
  color: var(--text-main);
  padding: 8px 10px;
  font-size: 0.85rem;
}

input::placeholder,
textarea::placeholder {
  color: #6b7280;
}

textarea {
  min-height: 200px;
  resize: vertical;
}

/* Rad med knappar under inputs */
.bottom-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-top: 12px;
}

.bottom-row input[type="email"] {
  max-width: 260px;
}

/* Audio-player */
audio {
  width: 100%;
}

/* Fel / success-meddelanden */
.error {
  margin-top: 6px;
  font-size: 0.8rem;
  color: var(--danger);
}

.success {
  margin-top: 6px;
  font-size: 0.8rem;
  color: #4ade80;
}

/* Småskärm */
@media (max-width: 640px) {
  .topbar {
    padding: 12px 16px 0;
  }

  .page {
    padding: 16px;
  }

  .card {
    padding: 18px 16px 22px;
  }

  .row {
    gap: 8px;
  }

  button {
    width: auto;
  }
}



  /* mörk Kenai-stil istället för vitt */
  background:
    radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.16), transparent 60%),
    rgba(15, 23, 42, 0.98);
  border-radius: 16px;
  border: 1px solid rgba(148, 163, 184, 0.45);
  box-shadow:
    0 0 0 1px rgba(15, 23, 42, 0.9),
    0 18px 45px rgba(15, 23, 42, 0.9);
}


    button {
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      border: 1px solid transparent;
      cursor: pointer;
      white-space: nowrap;
      transition:
        background 0.12s ease-out,
        border-color 0.12s ease-out,
        transform 0.12s ease-out,
        box-shadow 0.12s ease-out;
    }

    button.primary {
      background: radial-gradient(circle at 0 0, #e0f2fe 0, #38bdf8 30%, #0f172a 100%);
      border-color: rgba(56, 189, 248, 0.85);
      color: #020617;
      font-weight: 500;
      box-shadow:
        0 0 24px rgba(56, 189, 248, 0.8),
        0 0 60px rgba(37, 99, 235, 0.6);
    }

    button.secondary {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--text-main);
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 22px rgba(15, 23, 42, 0.9),
        0 0 48px rgba(15, 23, 42, 0.85);
    }

    .status-pill {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-muted);
    }

    .status-pill.recording {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    audio {
      width: 100%;
    }

    input[type="text"],
    input[type="email"],
    textarea {
      width: 100%;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      padding: 8px 10px;
      color: var(--text-main);
      font-size: 0.9rem;
      box-sizing: border-box;
    }

    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }

    textarea {
      min-height: 180px;
      resize: vertical;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .bottom-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .bottom-row input[type="email"] {
      max-width: 220px;
    }

    .error {
      margin-top: 6px;
      font-size: 0.8rem;
      color: var(--danger);
    }

    .success {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #4ade80;
    }

    .loader {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent);
      animation: spin 0.7s linear infinite;
      vertical-align: -2px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    footer {
      margin-top: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
    }
/* ===== Kenai Recorder – mörkt kort utan att röra JS ===== */

/* Hela sidans bakgrund */
body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
  background:
    radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%) !important;
  color: #e5e7eb;
}

/* Slå av ljus bakgrund på ytter-wrappers */
body > div,
body > main {
  background: transparent !important;
}

/* Själva “kortet” runt recordern */
body main,
body main > div,
body > div main,
body > div main > div {
  background:
    radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.16), transparent 60%),
    rgba(15, 23, 42, 0.98) !important;
  border-radius: 24px !important;
  border: 1px solid rgba(148, 163, 184, 0.45) !important;
  box-shadow:
    0 0 0 1px rgba(15, 23, 42, 0.9),
    0 24px 60px rgba(15, 23, 42, 0.95) !important;
}

/* Inputs & textarea – mörka fält */
input[type="text"],
input[type="email"],
textarea {
  background: rgba(15, 23, 42, 0.98) !important;
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.75);
  padding: 8px 10px;
  color: #e5e7eb;
}

input::placeholder,
textarea::placeholder {
  color: #6b7280;
}

/* Knappar – Kenai-stil */
button {
  border-radius: 999px;
  padding: 8px 16px;
  border: 1px solid transparent;
  cursor: pointer;
  transition:
    background 0.12s ease-out,
    border-color 0.12s ease-out,
    transform 0.12s ease-out,
    box-shadow 0.12s ease-out;
}

button:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow:
    0 0 22px rgba(15, 23, 42, 0.9),
    0 0 48px rgba(15, 23, 42, 0.85);
}

/* Primärknappar (start/AI) */
button.primary,
button#btnSummarize,
button#btnStart {
  background: radial-gradient(circle at 0 0, #e0f2fe 0, #38bdf8 30%, #0f172a 100%);
  border-color: rgba(56, 189, 248, 0.85);
  color: #020617;
  font-weight: 500;
  box-shadow:
    0 0 24px rgba(56, 189, 248, 0.8),
    0 0 60px rgba(37, 99, 235, 0.6);
}

/* Sekundära knappar (stop, upload, PDF, mail) */
button.secondary,
button#btnStop,
button#btnUpload,
button#btnPdf,
button#btnEmail {
  background: rgba(15, 23, 42, 0.96);
  border-color: rgba(148, 163, 184, 0.7);
  color: #e5e7eb;
}

/* Småtexter */
.small,
.help-text,
label,
.section-label {
  color: #9ca3af;
}

/* Lite mjukare på mobil */
@media (max-width: 768px) {
  body main,
  body main > div,
  body > div main,
  body > div main > div {
    border-radius: 18px !important;
  }
}
    /* ===== SISTA OVERRIDE – gör själva main-kortet mörkt ===== */

body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
  background:
    radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%) !important;
  color: #e5e7eb;
}

/* Själva stora vita lådan = <main> */
main {
  max-width: 960px;
  margin: 24px auto 40px;
  padding: 24px;
  background:
    radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.16), transparent 60%),
    rgba(15, 23, 42, 0.98);
  border-radius: 24px;
  border: 1px solid rgba(148, 163, 184, 0.45);
  box-shadow:
    0 0 0 1px rgba(15, 23, 42, 0.9),
    0 24px 60px rgba(15, 23, 42, 0.95);
}

/* Sektionerna inuti får transparent bakgrund så kortet lyser igenom */
main > section {
  background: transparent !important;
}
/* ===== Kenai override – gör varje rad-mojäng mörk ===== */ 
    /* ===== Kenai dark layout – gör stora kortet mörkt ===== */

/* Hela sidans bakgrund */
body {
  margin: 0;
  min-height: 100vh;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
  background:
    radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%) !important;
  color: #e5e7eb;
}

/* Ytterkorten runt innehållet – div.page är stora vita boxen */
.page {
  max-width: 960px;
  margin: 24px auto 40px;
  padding: 24px;
  background:
    radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.16), transparent 60%),
    rgba(15, 23, 42, 0.98) !important;
  border-radius: 24px;
  border: 1px solid rgba(148, 163, 184, 0.45);
  box-shadow:
    0 0 0 1px rgba(15, 23, 42, 0.9),
    0 24px 60px rgba(15, 23, 42, 0.95);
}
/* ===== Kenai dark card – gör stora vita lådan mörk ===== */
.page {
  max-width: 960px;
  margin: 24px auto 40px;
  padding: 24px;
  background:
    radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), transparent 55%),
    radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.16), transparent 60%),
    rgba(15, 23, 42, 0.98) !important;
  border-radius: 24px !important;
  border: 1px solid rgba(148, 163, 184, 0.45) !important;
  box-shadow:
    0 0 0 1px rgba(15, 23, 42, 0.9),
    0 24px 60px rgba(15, 23, 42, 0.95) !important;
}

/* main och sektionerna inuti ska INTE lägga på egen vit bakgrund */
.page main,
.page main > section {
    background: transparent !important;
}

/* === FORCE DARK BAKGRUND PÅ HELA SIDAN === */
html,
body {
    background: radial-gradient(circle at top, #07172a, #020617 45%, #000 100%) !important;
}

/* Se till att själva .page inte lägger på vitt */
.page {
    background: transparent !important;
}

/* === KENAI DARK CARD – gör själva kortet mörkt === */
.page .card {
    background: radial-gradient(circle at top, #07172a, #020617 45%, #000 100%) !important;
    border-radius: 24px;
    box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.6),
        0 24px 60px rgba(15, 23, 42, 0.95);
    color: #e5e7eb;
}

.page .card header.section {
    border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}
</style>
</head>
<body style="min-height: 100vh; margin: 0; background: radial-gradient(circle at top, #07172a, #020617 45%, #000 100%);">
    <div class="topbar">
    <div class="brand">
      <div class="brand-logo"></div>
      <div>
        <div class="brand-title">KENAI DARK TEST</div>
        <div class="brand-sub">AI-sammanfattning för ljud</div>
      </div>
    </div>
    <div class="pill">
      <span class="pill-dot"></span>
      Live · Recorder v1
    </div>
  </div>

  <div class="page">
    <div class="card">
      <header class="section">
        <h1>KENAI DARK TEST</h1>
        <p class="subtitle">
          Nytt: Testa även
          <a href="https://app.kenai.technology/reels.html" target="_blank" rel="noopener">
            AI Reels Maker
          </a>
          för att ladda upp bilder & klipp och få en första reel-plan.
        </p>
      </header>

      <!-- Inspelning -->
      <section class="section">
        <div class="section-label">Inspelning:</div>
        <div class="row">
          <button id="btnStart" class="primary">Starta inspelning</button>
          <button id="btnStop" class="secondary" disabled>Stoppa</button>
          <span id="recordStatus" class="status-pill">idle</span>
        </div>
        <div style="margin-top: 10px;">
          <audio id="player" controls></audio>
          <div class="small" id="fileInfo">Ingen inspelning ännu.</div>
        </div>
        <div id="recordError" class="error"></div>
      </section>

      <!-- Supabase-länk -->
      <section class="section">
        <div class="section-label">Länk till ljudfil (Supabase URL):</div>
        <input
          id="audioUrl"
          type="text"
          placeholder="Här hamnar länken efter upload – eller klistra in manuellt..."
        />
        <div class="row" style="margin-top: 8px;">
          <button id="btnUpload" class="secondary">Ladda upp till Kenai</button>
          <button id="btnSummarize" class="primary">AI-transkribera &amp; sammanfatta</button>
        </div>
        <div class="small">
          Kenai laddar upp din inspelning till Supabase, skickar den till AI och fyller i rutan nedan.
        </div>
        <div id="uploadStatus" class="success"></div>
        <div id="uploadError" class="error"></div>
      </section>

      <!-- AI-transkribering & sammanfattning -->
      <section class="section">
        <div class="section-label">AI-transkribering &amp; sammanfattning:</div>
        <textarea
          id="summary"
          placeholder="Här kommer transkriberingen och sammanfattningen..."
        ></textarea>
        <div id="summaryStatus" class="success"></div>
        <div id="summaryError" class="error"></div>
      </section>

      <!-- PDF + e-post -->
      <section class="section">
        <div class="section-label">Export &amp; utskick:</div>
        <div class="bottom-row">
          <button id="btnPdf" class="secondary">Ladda ner som PDF</button>
          <input
            id="email"
            type="email"
            placeholder="Din e-postadress..."
          />
          <button id="btnEmail" class="secondary">Maila sammanfattning</button>
        </div>
        <div id="exportStatus" class="success"></div>
        <div id="exportError" class="error"></div>
      </section>

      <footer>
        Kenai · Framtidens Google Translate fast för ljud.
      </footer>
    </div>
  </div>

  <script>
    // ===== KONFIG – FYLL I DINA RIKTIGA SUPABASE-VÄRDEN HÄR =====
    // Kopiera in exakt samma URL + anon key som du har i den version som funkade.
    const SB_URL ='https://hywwzzzxgagqhlxooekz.supabase.co';  // <-- BYT DETTA
    const SB_ANON ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';                    // <-- BYT DETTA
    const SB_BUCKET = "kenai-audio";                       // eller det bucket-namn du använder
    const SB_PREFIX = "reviews";                           // underkatalog, t.ex. reviews/

    const supabaseClient = window.supabase.createClient(SB_URL, SB_ANON);

    // ===== DOM ELEMENT =====
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const statusSpan = document.getElementById("recordStatus");
    const player = document.getElementById("player");
    const fileInfo = document.getElementById("fileInfo");
    const recordError = document.getElementById("recordError");

    const audioUrlInput = document.getElementById("audioUrl");
    const btnUpload = document.getElementById("btnUpload");
    const btnSummarize = document.getElementById("btnSummarize");
    const uploadStatus = document.getElementById("uploadStatus");
    const uploadError = document.getElementById("uploadError");

    const summaryTextarea = document.getElementById("summary");
    const summaryStatus = document.getElementById("summaryStatus");
    const summaryError = document.getElementById("summaryError");

    const btnPdf = document.getElementById("btnPdf");
    const btnEmail = document.getElementById("btnEmail");
    const emailInput = document.getElementById("email");
    const exportStatus = document.getElementById("exportStatus");
    const exportError = document.getElementById("exportError");

    // ===== STATE =====
    let mediaRecorder = null;
    let chunks = [];
    let currentBlob = null;

    function setRecordingState(state) {
      statusSpan.textContent = state;
      statusSpan.classList.toggle("recording", state === "spelar in...");
    }

    function resetMessages() {
      recordError.textContent = "";
      uploadError.textContent = "";
      uploadStatus.textContent = "";
      summaryError.textContent = "";
      summaryStatus.textContent = "";
      exportError.textContent = "";
      exportStatus.textContent = "";
    }

    // ===== INSPELNING =====
    async function startRecording() {
      resetMessages();
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        recordError.textContent = "Din webbläsare stödjer inte inspelning (getUserMedia saknas).";
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          const mimeType = mediaRecorder.mimeType || "audio/webm";
          currentBlob = new Blob(chunks, { type: mimeType });
          const url = URL.createObjectURL(currentBlob);
          player.src = url;
          player.load();

          const sizeKb = (currentBlob.size / 1024).toFixed(1);
          fileInfo.textContent = `Inspelning klar (${mimeType}, ${sizeKb} KB).`;
          setRecordingState("klar");
          btnStart.disabled = false;
          btnStop.disabled = true;
        };

        mediaRecorder.start();
        setRecordingState("spelar in...");
        btnStart.disabled = true;
        btnStop.disabled = false;
        fileInfo.textContent = "Spelar in...";
      } catch (err) {
        console.error(err);
        recordError.textContent = "Kunde inte starta inspelning. Kolla mikrofonbehörigheter.";
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach((t) => t.stop());
      }
    }

    // ===== SUPABASE-UPPLOAD =====
    async function uploadToSupabase() {
      resetMessages();

      if (!currentBlob) {
        uploadError.textContent = "Det finns ingen inspelning att ladda upp. Spela in först.";
        return;
      }

      try {
        btnUpload.disabled = true;
        btnUpload.innerHTML = '<span class="loader"></span> Laddar upp...';

        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        const ext = currentBlob.type.includes("webm") ? "webm" :
                    currentBlob.type.includes("ogg") ? "ogg" :
                    currentBlob.type.includes("mp4") || currentBlob.type.includes("m4a") ? "m4a" :
                    "wav";
        const filename = `${SB_PREFIX}/${timestamp}.${ext}`;

        const { data, error } = await supabaseClient.storage
          .from(SB_BUCKET)
          .upload(filename, currentBlob, {
            cacheControl: "3600",
            upsert: false,
            contentType: currentBlob.type || "audio/webm"
          });

        if (error) {
          console.error(error);
          uploadError.textContent = "Kunde inte ladda upp filen till Supabase.";
          return;
        }

        const { data: publicUrlData } = supabaseClient
          .storage
          .from(SB_BUCKET)
          .getPublicUrl(data.path);

        const publicUrl = publicUrlData.publicUrl;
        audioUrlInput.value = publicUrl;
        uploadStatus.textContent = "Uppladdning klar. Länken är ifylld.";
      } catch (err) {
        console.error(err);
        uploadError.textContent = "Ett oväntat fel uppstod vid uppladdning.";
      } finally {
        btnUpload.disabled = false;
        btnUpload.textContent = "Ladda upp till Kenai";
      }
    }

    // ===== AI-SUMMARIZE =====
    async function summarizeAudio() {
      resetMessages();

      const audioUrl = audioUrlInput.value.trim();
      if (!audioUrl) {
        summaryError.textContent = "Fyll i eller generera en Supabase-URL först.";
        return;
      }

      try {
        btnSummarize.disabled = true;
        btnSummarize.innerHTML = '<span class="loader"></span> Bearbetar...';

        const res = await fetch("/api/summarize", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ audioUrl })
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error("Summarize error:", res.status, txt);
          summaryError.textContent = "AI-sammanfattning misslyckades. Kolla serverns loggar.";
          return;
        }

        const data = await res.json();
        // Vi förväntar oss t.ex. { transcript: "...", summary: "..." }
        let combined = "";
        if (data.transcript) {
          combined += "TRANSKRIBERING:\n" + data.transcript + "\n\n";
        }
        if (data.summary) {
          combined += "SAMMANFATTNING:\n" + data.summary;
        }
        if (!combined) {
          combined = JSON.stringify(data, null, 2);
        }

        summaryTextarea.value = combined;
        summaryStatus.textContent = "AI-transkribering & sammanfattning klar.";
      } catch (err) {
        console.error(err);
        summaryError.textContent = "Ett oväntat fel uppstod vid AI-sammanfattning.";
      } finally {
        btnSummarize.disabled = false;
        btnSummarize.textContent = "AI-transkribera & sammanfatta";
      }
    }

    // ===== PDF-EXPORT =====
    async function exportPdf() {
      resetMessages();

      const content = summaryTextarea.value.trim();
      if (!content) {
        exportError.textContent = "Det finns ingen text att göra PDF av.";
        return;
      }

      try {
        btnPdf.disabled = true;
        btnPdf.innerHTML = '<span class="loader"></span> Skapar PDF...';

        const res = await fetch("/api/export-pdf", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content })
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error("PDF error:", res.status, txt);
          exportError.textContent = "Kunde inte skapa PDF. Kolla servern.";
          return;
        }

        // Förväntar oss att servern returnerar en fil (application/pdf)
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "kenai-sammanfattning.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
        exportStatus.textContent = "PDF nedladdad.";
      } catch (err) {
        console.error(err);
        exportError.textContent = "Ovntat fel vid PDF-export.";
      } finally {
        btnPdf.disabled = false;
        btnPdf.textContent = "Ladda ner som PDF";
      }
    }

    // ===== EMAIL MOCK =====
    async function sendEmail() {
      resetMessages();

      const email = emailInput.value.trim();
      const content = summaryTextarea.value.trim();

      if (!email) {
        exportError.textContent = "Fyll i en e-postadress.";
        return;
      }
      if (!content) {
        exportError.textContent = "Det finns ingen sammanfattning att skicka.";
        return;
      }

      try {
        btnEmail.disabled = true;
        btnEmail.innerHTML = '<span class="loader"></span> Skickar...';

        const res = await fetch("/api/send-summary-email", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, content })
        });

        if (!res.ok) {
          const txt = await res.text();
          console.error("Email error:", res.status, txt);
          exportError.textContent = "Mail-funktionen misslyckades (mock).";
          return;
        }

        exportStatus.textContent = "Sammanfattningen skickades (mock).";
      } catch (err) {
        console.error(err);
        exportError.textContent = "Ovntat fel vid mail-försök.";
      } finally {
        btnEmail.disabled = false;
        btnEmail.textContent = "Maila sammanfattning";
      }
    }

    // ===== EVENT LISTENERS =====
    btnStart.addEventListener("click", startRecording);
    btnStop.addEventListener("click", stopRecording);
    btnUpload.addEventListener("click", uploadToSupabase);
    btnSummarize.addEventListener("click", summarizeAudio);
    btnPdf.addEventListener("click", exportPdf);
    btnEmail.addEventListener("click", sendEmail);
  </script>
  <div style="position:fixed;bottom:10px;right:10px;color:red;z-index:9999;font-weight:bold;">
    DEBUG 123 – från public/recorder.html
</div>

</body>
</html>
