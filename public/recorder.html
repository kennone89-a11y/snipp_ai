<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kenai Recorder</title>

<!-- FYLL I DINA SUPABASE-VÄRDEN -->
<meta name="supabase-url" content='https://hywwzzzxgagqhlxooekz.supabase.co';
<meta name="supabase-key" content='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: radial-gradient(circle at top,
            #0a1228 0%, #02040f 40%, #000 100%);
        color: white;
    }

    .wrapper {
        max-width: 440px;
        margin: 80px auto;
        background: rgba(255,255,255,0.05);
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 0 40px rgba(0,0,0,0.45);
    }

    h1 {
        margin-top: 0;
        font-size: 26px;
    }

    button {
        padding: 10px 18px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        cursor: pointer;
        margin-right: 8px;
    }

    .start { background:#2d8cff; }
    .stop { background:#d94a4a; }
    .upload { background:#3b8bff; }

    audio {
        width: 100%;
        margin-top: 15px;
    }

    .status {
        margin-top: 10px;
        font-size: 14px;
        opacity: 0.85;
    }
</style>
</head>

<body>

<div class="wrapper">
    <h1>Kenai Recorder</h1>
    <p>Spela in en kort röst-note och ladda upp till Kenai.</p>

    <button class="start" id="btnStart">Starta inspelning</button>
    <button class="stop" id="btnStop" disabled>Stoppa</button>
    <button class="upload" id="btnUpload" disabled>Ladda upp</button>

    <audio id="player" controls></audio>

    <div class="status" id="status">status: idle</div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let blob;
let urlAudio;

const player = document.getElementById("player");
const statusBox = document.getElementById("status");
const btnStart = document.getElementById("btnStart");
const btnStop = document.getElementById("btnStop");
const btnUpload = document.getElementById("btnUpload");

// Läs Supabase från <meta>
const SB_URL = document.querySelector("meta[name='supabase-url']").content.trim();
const SB_KEY = document.querySelector("meta[name='supabase-key']").content.trim();

async function startRec() {
    audioChunks = [];
    blob = null;

    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
        blob = new Blob(audioChunks, { type:"audio/wav" });
        urlAudio = URL.createObjectURL(blob);
        player.src = urlAudio;
        btnUpload.disabled = false;
    };

    mediaRecorder.start();
    statusBox.innerText = "status: recording...";
    btnStart.disabled = true;
    btnStop.disabled = false;
}

function stopRec() {
    mediaRecorder.stop();
    statusBox.innerText = "status: stopped";
    btnStart.disabled = false;
    btnStop.disabled = true;
}

async function uploadRec() {
    if (!blob) return alert("Ingen inspelning.");

    statusBox.innerText = "Laddar upp...";
    const fileName = `kenai-${Date.now()}.wav`;

    const { data, error } = await fetch(`${SB_URL}/storage/v1/object/public/audio/reviews/${fileName}`, {
        method: "POST",
        headers: {
            "Content-Type": "audio/wav",
            "apikey": SB_KEY,
            "Authorization": `Bearer ${SB_KEY}`
        },
        body: blob
    });

    if (error) {
        console.log(error);
        statusBox.innerText = "Fel: kunde inte ladda upp.";
        return;
    }

    const publicUrl = `${SB_URL}/storage/v1/object/public/audio/reviews/${fileName}`;
    statusBox.innerHTML = `Klar! <br> Länk: <a href="${publicUrl}" target="_blank">${publicUrl}</a>`;
}

btnStart.onclick = startRec;
btnStop.onclick = stopRec;
btnUpload.onclick = uploadRec;

// Playback-timer SOM DU VILL HA
player.addEventListener("play", () => {
    const int = setInterval(() => {
        if (!player.paused) {
            statusBox.innerText = `spelar upp: ${player.currentTime.toFixed(1)} sek`;
        } else {
            clearInterval(int);
        }
    }, 200);
});
</script>

</body>
</html>
