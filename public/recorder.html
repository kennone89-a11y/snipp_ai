<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kenai Recorder</title>

  <!-- BYT BARA DESSA TV√Ö RADER TILL DINA RIKTIGA V√ÑRDEN -->
  <meta name='https://hywwzzzxgagqhlxooekz.supabase.co';
  <meta name='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';
  <!-- SLUTA R√ñR H√ÑR üòÑ -->

  <style>
    :root {
      --kenai-bg-top: #020617;
      --kenai-bg-mid: #020e2b;
      --kenai-bg-bottom: #000000;
      --kenai-card: rgba(15, 23, 42, 0.96);
      --kenai-border: rgba(148, 163, 184, 0.35);
      --kenai-accent: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, var(--kenai-bg-mid) 0, var(--kenai-bg-top) 40%, var(--kenai-bg-bottom) 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 32px 16px;
    }

    .page {
      width: 100%;
      max-width: 640px;
    }

    .card {
      background: var(--kenai-card);
      border-radius: 20px;
      padding: 24px 20px 22px;
      border: 1px solid var(--kenai-border);
      box-shadow: 0 26px 90px rgba(0, 0, 0, 0.75);
    }

    h1 {
      font-size: 24px;
      letter-spacing: 0.02em;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }

    .link-row {
      font-size: 12px;
      margin-bottom: 18px;
      color: #9ca3af;
    }

    .link-row a {
      color: #38bdf8;
      text-decoration: none;
    }

    .link-row a:hover {
      text-decoration: underline;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
    }

    button {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #111827;
      color: #e5e7eb;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.55);
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.8);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
    }

    #startBtn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }

    #stopBtn {
      background: linear-gradient(135deg, #f97316, #fb923c);
    }

    #uploadBtn {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
    }

    button:disabled {
      opacity: 0.32;
      box-shadow: none;
      cursor: default;
    }

    #status {
      font-size: 12px;
      color: #9ca3af;
    }

    audio {
      width: 100%;
      margin-top: 10px;
    }

    .result {
      margin-top: 12px;
      font-size: 12px;
      color: #9ca3af;
      word-break: break-all;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 118, 110, 0.2);
      color: #6ee7b7;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Kenai Recorder</h1>
      <p class="subtitle">
        Spela in en kort r√∂st-note och ladda upp till Kenai. Perfekt f√∂r podd-recensioner, id√©er och snabb feedback.
      </p>

      <div class="link-row">
        Testa √§ven <a href="/reels.html">AI Reels Maker</a> ‚Äì ladda upp klipp och l√•t Kenai bygga en reel-plan.
      </div>

      <div class="controls-row">
        <button id="startBtn">
          <span class="dot"></span>
          Starta inspelning
        </button>
        <button id="stopBtn" disabled>Stoppa</button>
        <button id="uploadBtn" disabled>Upload &amp; kopiera l√§nk</button>
        <span id="status">status: idle</span>
      </div>

      <audio id="player" controls></audio>

      <div id="result" class="result">
        Inget uppladdat √§nnu.
      </div>
    </div>
  </div>

  <script>
    // ==== Supabase config ====
    const SB_URL =
      document.querySelector('meta[name="supabase-url"]')?.content.trim() || "";
    const SB_KEY =
      document.querySelector('meta[name="supabase-key"]')?.content.trim() || "";

    const BUCKET = "audio";
    const FOLDER = "reviews";

    if (!SB_URL || !SB_KEY) {
      console.warn("Supabase-konfig saknas ‚Äì upload inaktiveras.");
    }

    // ==== DOM ====
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl = document.getElementById("status");
    const player = document.getElementById("player");
    const resultEl = document.getElementById("result");

    // ==== Recording state ====
    let mediaRecorder = null;
    let chunks = [];
    let audioBlob = null;

    function setStatus(text) {
      statusEl.textContent = "status: " + text;
    }

    function resetRecording() {
      chunks = [];
      audioBlob = null;
      player.src = "";
      uploadBtn.disabled = true;
    }

    // ==== Start recording ====
    startBtn.addEventListener("click", async () => {
      try {
        resetRecording();
        setStatus("beg√§r mikrofon...");
        startBtn.disabled = true;
        stopBtn.disabled = false;

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          const type = chunks[0]?.type || "audio/webm";
          audioBlob = new Blob(chunks, { type });
          player.src = URL.createObjectURL(audioBlob);
          uploadBtn.disabled = !SB_URL || !SB_KEY;
          setStatus("klar att ladda upp");
        };

        mediaRecorder.start();
        setStatus("spelar in...");
      } catch (err) {
        console.error(err);
        setStatus("kunde inte starta inspelning (mic-√•tkomst?)");
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });

    // ==== Stop recording ====
    stopBtn.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach((t) => t.stop());
        stopBtn.disabled = true;
        startBtn.disabled = false;
        setStatus("stoppar...");
      }
    });

    // ==== Upload to Supabase ====
    uploadBtn.addEventListener("click", async () => {
      if (!audioBlob) {
        setStatus("ingen inspelning att ladda upp");
        return;
      }
      if (!SB_URL || !SB_KEY) {
        setStatus("Supabase saknas ‚Äì kolla meta-taggarna");
        return;
      }

      try {
        setStatus("laddar upp...");
        uploadBtn.disabled = true;

        const ext = audioBlob.type.includes("webm")
          ? "webm"
          : audioBlob.type.includes("ogg")
          ? "ogg"
          : "m4a";
        const filename = `rec_${Date.now()}.${ext}`;
        const path = `${BUCKET}/${FOLDER}/${filename}`;

        const uploadUrl = `${SB_URL}/storage/v1/object/${encodeURIComponent(
          path
        )}`;

        const resp = await fetch(uploadUrl, {
          method: "POST",
          headers: {
            apikey: SB_KEY,
            Authorization: `Bearer ${SB_KEY}`,
            "Content-Type": audioBlob.type || "audio/webm",
            "x-upsert": "true",
          },
          body: audioBlob,
        });

        if (!resp.ok) {
          const errText = await resp.text();
          console.error("Upload error", resp.status, errText);
          setStatus("fel vid uppladdning (" + resp.status + ")");
          uploadBtn.disabled = false;
          return;
        }

        const publicUrl = `${SB_URL}/storage/v1/object/public/${BUCKET}/${FOLDER}/${filename}`;

        setStatus("uppladdad ‚úÖ");
        resultEl.innerHTML =
          `Inspelning uppladdad.<br>` +
          `Delbar l√§nk: <a href="${publicUrl}" target="_blank">${publicUrl}</a>` +
          `<span class="tag">public</span>`;
      } catch (err) {
        console.error(err);
        setStatus("ov√§ntat fel vid uppladdning");
        uploadBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
