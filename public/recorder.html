<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Kenai Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- BYT TILL DINA RIKTIGA SUPABASE-VÄRDEN -->
  <meta name='https://hywwzzzxgagqhlxooekz.supabase.co';
  <meta name='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #092061 0, #092761 40%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
    }

    .page {
      width: 100%;
      max-width: 640px;
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 20px 20px 18px;
      box-shadow: 0 22px 60px rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .sub {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 14px;
    }

    .link-row {
      font-size: 12px;
      margin-bottom: 12px;
    }

    .link-row a {
      color: #38bdf8;
      text-decoration: none;
    }

    .link-row a:hover {
      text-decoration: underline;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.12s ease;
    }

    button:disabled {
      opacity: 0.45;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-start {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.45);
    }

    .btn-start:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 38px rgba(34, 197, 94, 0.6);
    }

    .btn-stop {
      background: linear-gradient(135deg, #ef4444, #b91c1c);
      color: #fee2e2;
    }

    .btn-stop:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 38px rgba(239, 68, 68, 0.45);
    }

    .btn-upload {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #fff7ed;
    }

    .btn-upload:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 14px 38px rgba(249, 115, 22, 0.4);
    }

    .status-row {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .status-pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 6px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      color: #e5e7eb;
    }

    .status-pill.recording {
      background: rgba(185, 28, 28, 0.18);
      border-color: #f97373;
      color: #fecaca;
    }

    .status-pill.uploading {
      background: rgba(8, 47, 73, 0.8);
      border-color: #38bdf8;
      color: #e0f2fe;
    }

    .status-pill.done {
      background: rgba(22, 163, 74, 0.18);
      border-color: #4ade80;
      color: #bbf7d0;
    }

    .status-pill.error {
      background: rgba(127, 29, 29, 0.6);
      border-color: #fecaca;
      color: #fee2e2;
    }

    .timer {
      font-variant-numeric: tabular-nums;
    }

    .player-wrap {
      margin-top: 8px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 10px 8px;
      border: 1px solid rgba(51, 65, 85, 0.8);
    }

    audio {
      width: 100%;
    }

    .small {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    .meta {
      font-size: 11px;
      margin-top: 8px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .meta code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.75);
      padding: 2px 4px;
      border-radius: 4px;
    }

    .link-out {
      margin-top: 10px;
      font-size: 11px;
      color: #a5b4fc;
      word-break: break-all;
    }

    .link-out a {
      color: #a5b4fc;
      text-decoration: none;
    }

    .link-out a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card">
      <h1>Kenai Recorder</h1>
      <div class="sub">Spela in en kort röstnotis – spara eller dela via en publik Supabase-länk.</div>

      <div class="link-row">
        Nytt: testa även
        <a href="reels.html">Kenai Reels Maker</a>
        för att bygga en första reel-plan av dina klipp.
      </div>

      <div class="controls">
        <button id="startBtn" class="btn-start">● Starta inspelning</button>
        <button id="stopBtn" class="btn-stop" disabled>■ Stoppa</button>
        <button id="uploadBtn" class="btn-upload" disabled>⬆ Ladda upp</button>
      </div>

      <div class="status-row">
        Status:
        <span id="statusPill" class="status-pill">idle</span>
        <span id="timer" class="timer">00:00</span>
      </div>

      <div class="player-wrap">
        <audio id="player" controls></audio>
        <div class="small">
          Tips: Spela in 10–30 sek för snabb delning. Auto-stop efter 2 minuter.
        </div>
      </div>

      <div class="meta" id="metaInfo">
        Inspelning: <code>-</code><br />
        Storlek: <code>-</code>
      </div>

      <div class="link-out" id="publicLink" style="display:none;">
        Delbar länk:<br />
        <a id="publicUrl" href="#" target="_blank" rel="noopener">-</a>
      </div>
    </div>
  </div>

  <script>
    // ===== Läs Supabase-värden från <meta> =====
    function getMeta(name) {
      const el = document.querySelector('meta[name="' + name + '"]');
      return el ? el.content.trim() : '';
    }

    const SB_URL = getMeta('supabase-url');   // t.ex. https://xxxxx.supabase.co
    const SB_ANON = getMeta('supabase-key');  // din anon public key
    const BUCKET = 'audio';
    const FOLDER = 'reviews';
    const MAX_SECONDS = 120;

    // ===== UI-element =====
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusPill = document.getElementById('statusPill');
    const timerEl = document.getElementById('timer');
    const player = document.getElementById('player');
    const metaInfo = document.getElementById('metaInfo');
    const publicLinkWrap = document.getElementById('publicLink');
    const publicUrlEl = document.getElementById('publicUrl');

    // ===== Inspelnings-state =====
    let mediaRecorder = null;
    let mediaStream = null;
    let chunks = [];
    let lastBlob = null;
    let lastMime = '';
    let lastFilename = '';
    let timerInterval = null;
    let startedAt = 0;

    function setStatus(mode, text) {
      statusPill.textContent = text || mode;

      statusPill.classList.remove('recording', 'uploading', 'done', 'error');

      if (mode === 'recording') {
        statusPill.classList.add('recording');
      } else if (mode === 'uploading') {
        statusPill.classList.add('uploading');
      } else if (mode === 'done') {
        statusPill.classList.add('done');
      } else if (mode === 'error') {
        statusPill.classList.add('error');
      }
    }

    function formatTime(seconds) {
      const s = Math.floor(seconds);
      const mm = String(Math.floor(s / 60)).padStart(2, '0');
      const ss = String(s % 60).padStart(2, '0');
      return mm + ':' + ss;
    }

    function startTimer() {
      startedAt = Date.now();
      timerEl.textContent = '00:00';

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const diffSec = (Date.now() - startedAt) / 1000;
        timerEl.textContent = formatTime(diffSec);

        if (diffSec >= MAX_SECONDS) {
          stopRecording();
        }
      }, 500);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function pickMimeType() {
      if (window.MediaRecorder) {
        if (MediaRecorder.isTypeSupported &&
            MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
          return 'audio/webm;codecs=opus';
        }
        if (MediaRecorder.isTypeSupported &&
            MediaRecorder.isTypeSupported('audio/mp4')) {
          return 'audio/mp4';
        }
      }
      return '';
    }

    async function startRecording() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus('error', 'Ingen mic hittades');
        alert('Den här webbläsaren saknar stöd för mic-inspelning.');
        return;
      }

      if (mediaRecorder && mediaRecorder.state === 'recording') {
        return;
      }

      publicLinkWrap.style.display = 'none';
      publicUrlEl.textContent = '';

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaStream = stream;

        const mimeType = pickMimeType();
        const options = mimeType ? { mimeType } : {};
        mediaRecorder = new MediaRecorder(stream, options);
        chunks = [];
        lastBlob = null;
        lastMime = mimeType || 'audio/webm';

        mediaRecorder.ondataavailable = (ev) => {
          if (ev.data && ev.data.size > 0) {
            chunks.push(ev.data);
          }
        };

        mediaRecorder.onstop = () => {
          stopTimer();
          const blob = new Blob(chunks, { type: lastMime });
          lastBlob = blob;

          const url = URL.createObjectURL(blob);
          player.src = url;
          player.load();

          const sizeKb = (blob.size / 1024).toFixed(1);
          const durationSec = (Date.now() - startedAt) / 1000;

          metaInfo.innerHTML =
            'Inspelning: <code>' + (lastMime || 'okänd') + '</code><br />' +
            'Längd: <code>' + formatTime(durationSec) + '</code> &nbsp; ' +
            'Storlek: <code>' + sizeKb + ' kB</code>';

          if (mediaStream) {
            mediaStream.getTracks().forEach(t => t.stop());
            mediaStream = null;
          }

          startBtn.disabled = false;
          stopBtn.disabled = true;
          uploadBtn.disabled = false;
          setStatus('done', 'klar – redo att ladda upp');
        };

        mediaRecorder.start(500); // timeslice för fler event
        startTimer();
        setStatus('recording', 'spelar in...');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        uploadBtn.disabled = true;

      } catch (err) {
        console.error('startRecording error', err);
        setStatus('error', 'kunde inte starta inspelning');
        alert('Kunde inte starta inspelning: ' + err.message);
      }
    }

    function stopRecording() {
      if (!mediaRecorder) return;
      if (mediaRecorder.state === 'inactive') return;

      try {
        mediaRecorder.stop();
      } catch (err) {
        console.error('stopRecording error', err);
      }
    }

    async function uploadRecording() {
      if (!lastBlob) {
        alert('Ingen inspelning att ladda upp ännu.');
        return;
      }
      if (!SB_URL || !SB_ANON) {
        alert('Supabase-URL eller anon-key saknas i <meta>.');
        return;
      }

      const ts = Date.now();
      const ext = lastMime.includes('mp4') || lastMime.includes('aac') ? 'm4a' : 'webm';
      lastFilename = 'rec_' + ts + '.' + ext;

      const path = FOLDER + '/' + lastFilename;
      const uploadUrl = SB_URL.replace(/\/+$/, '') +
        '/storage/v1/object/public/' + BUCKET + '/' + encodeURIComponent(path);

      setStatus('uploading', 'laddar upp...');
      uploadBtn.disabled = true;

      try {
        const resp = await fetch(uploadUrl, {
          method: 'POST',
          headers: {
            'Content-Type': lastMime || 'application/octet-stream',
            'apikey': SB_ANON,
            'Authorization': 'Bearer ' + SB_ANON,
            'x-upsert': 'true'
          },
          body: lastBlob
        });

        if (!resp.ok) {
          const txt = await resp.text();
          console.error('Upload error', resp.status, txt);
          setStatus('error', 'uppladdning misslyckades');
          uploadBtn.disabled = false;
          alert('Uppladdning misslyckades (' + resp.status + '). Se konsolen för mer info.');
          return;
        }

        const publicUrl = uploadUrl; // samma URL kan användas publikt
        publicUrlEl.href = publicUrl;
        publicUrlEl.textContent = publicUrl;
        publicLinkWrap.style.display = 'block';

        setStatus('done', 'uppladdad ✅');
      } catch (err) {
        console.error('Upload exception', err);
        setStatus('error', 'uppladdning misslyckades');
        uploadBtn.disabled = false;
        alert('Fel vid uppladdning: ' + err.message);
      }
    }

    // ===== Knappar =====
    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
    uploadBtn.addEventListener('click', uploadRecording);

    // Init-status
    setStatus('idle', 'idle');
    timerEl.textContent = '00:00';
  </script>
</body>
</html>
