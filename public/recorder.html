<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Kenai Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 18px;
      margin: 0;
      background-color: #ffffff;
      color: #111827;
    }

    h1 {
      margin-top: 0;
    }

    small code {
      background: #f2f2f2;
      padding: 2px 6px;
      border-radius: 6px;
    }

    button {
      margin-right: 5px;
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .muted {
      opacity: 0.65;
    }

    .controls-row {
      margin: 12px 0;
    }

    .field-row {
      margin: 10px 0;
    }

    input[type="text"] {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      width: 60%;
      max-width: 520px;
    }

    textarea {
      margin-top: 6px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    audio {
      margin-top: 10px;
      width: 100%;
      max-width: 420px;
    }

    #status {
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h1>Kenai Recorder</h1>
  <p>
    Nytt: Testa även <a href="/reels.html">AI Reels Maker</a> (tidig test) för att ladda upp bilder &amp; klipp och få en första reel-plan.
  </p>

  <div class="controls-row">
    <button id="startBtn">Starta inspelning</button>
    <button id="stopBtn" disabled>Stoppa</button>
    <button id="uploadBtn" disabled>Upload till Supabase</button>
    <small id="status" class="muted">status: idle</small>
  </div>

  <audio id="player" controls></audio>

  <div class="field-row">
    <label for="audioUrlInput">Länk till ljudfil (Supabase URL):</label><br />
    <input
      id="audioUrlInput"
      type="text"
      placeholder="Här hamnar länken efter upload – eller klistra in manuellt..."
    />
    <button type="button" id="aiBtn" onclick="aiTranscribe()" disabled>
      AI-transkribera &amp; sammanfatta
    </button>
  </div>

  <div class="field-row">
    <label for="aiResult">AI-transkribering &amp; sammanfattning:</label><br />
    <textarea
      id="aiResult"
      rows="10"
      style="width: 80%; max-width: 720px;"
      placeholder="Här kommer transkriberingen och sammanfattningen..."
    ></textarea>
  </div>

  <script>
    // --- Supabase config: BYT ENDAST SUPABASE_KEY HÄR ---
    const SUPABASE_URL ='https://hywwzzzxgagqhlxooekz.supabase.co';  
    const SUPABASE_KEY ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA';
 // <--- klistra in ANON PUBLIC här

    console.log("Supabase config:", { SUPABASE_URL, SUPABASE_KEY });

    const SUPABASE_BUCKET = "kenai-audio";
    const SUPABASE_PREFIX = "reviews";

    let mediaRecorder = null;
    let mediaStream = null;
    let chunks = [];
    let recordedBlob = null;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl = document.getElementById("status");
    const player = document.getElementById("player");
    const audioUrlInput = document.getElementById("audioUrlInput");
    const aiBtn = document.getElementById("aiBtn");
    const resultBox = document.getElementById("aiResult");

    function setStatus(text) {
      statusEl.textContent = "status: " + text;
    }

    function updateButtons(recording) {
      startBtn.disabled = recording;
      stopBtn.disabled = !recording;
      uploadBtn.disabled = !recordedBlob || !SUPABASE_URL || !SUPABASE_KEY;
      aiBtn.disabled = !audioUrlInput.value.trim();
    }

    startBtn.addEventListener("click", async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("Din webbläsare stödjer inte inspelning.");
          return;
        }

        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];

        mediaRecorder = new MediaRecorder(mediaStream, {
          mimeType: "audio/webm",
        });

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            chunks.push(e.data);
          }
        };

        mediaRecorder.onstop = () => {
          recordedBlob = new Blob(chunks, { type: "audio/webm" });
          const url = URL.createObjectURL(recordedBlob);
          player.src = url;
          setStatus("klar – förhandslyssna eller ladda upp");
          updateButtons(false);
          if (SUPABASE_URL && SUPABASE_KEY) {
            uploadBtn.disabled = false;
          }
        };

        mediaRecorder.start();
        setStatus("spelar in...");
        updateButtons(true);
      } catch (err) {
        console.error("Kunde inte starta inspelning:", err);
        alert("Kunde inte starta inspelning. Kolla mic-behörighet.");
      }
    });

    stopBtn.addEventListener("click", () => {
      try {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
        if (mediaStream) {
          mediaStream.getTracks().forEach((t) => t.stop());
        }
        setStatus("stoppar inspelning...");
      } catch (err) {
        console.error("Fel vid stop:", err);
      }
    });

    uploadBtn.addEventListener("click", async () => {
      if (!recordedBlob) {
        alert("Spela in något först.");
        return;
      }
      if (!SUPABASE_URL || !SUPABASE_KEY) {
        alert("Supabase-konfig saknas (SUPABASE_KEY tom).");
        return;
      }

      try {
        setStatus("laddar upp till Supabase...");
        uploadBtn.disabled = true;

        const fileExt = "webm";
        const fileName =
          "rec_" + new Date().toISOString().replace(/[:.]/g, "-") + "." + fileExt;

        const objectPath = `${SUPABASE_BUCKET}/${SUPABASE_PREFIX}/${fileName}`;
        const uploadUrl =
          SUPABASE_URL + "/storage/v1/object/" + encodeURIComponent(objectPath);

        const resp = await fetch(uploadUrl, {
          method: "POST",
          headers: {
            apikey: SUPABASE_KEY,
            Authorization: "Bearer " + SUPABASE_KEY,
            "Content-Type": recordedBlob.type,
            "x-upsert": "true",
          },
          body: recordedBlob,
        });

        if (!resp.ok) {
          const text = await resp.text();
          console.error("Supabase upload fail:", resp.status, text);
          setStatus("upload misslyckades");
          alert("Upload misslyckades. Se konsolen för detaljer.");
          uploadBtn.disabled = false;
          return;
        }

        const publicUrl =
          SUPABASE_URL +
          "/storage/v1/object/public/" +
          encodeURIComponent(objectPath);

        audioUrlInput.value = publicUrl;
        aiBtn.disabled = false;

        setStatus("uppladdad ✅ – länk kopierad till fältet");
        console.log("Public URL:", publicUrl);
      } catch (err) {
        console.error("Upload error:", err);
        setStatus("upload-fel");
        alert("Tekniskt fel vid upload. Se konsolen.");
        uploadBtn.disabled = false;
      }
    });

    audioUrlInput.addEventListener("input", () => {
      aiBtn.disabled = !audioUrlInput.value.trim();
    });

    async function aiTranscribe() {
      const audioUrl = audioUrlInput.value.trim();
      if (!audioUrl) {
        alert("Klistra in Supabase-länken först.");
        return;
      }

      resultBox.value = "AI jobbar... (transkriberar & sammanfattar)";

      try {
        const resp = await fetch("/api/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ audioUrl }),
        });

        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          console.error("Fel från /api/summarize:", data);
          resultBox.value =
            "Något gick fel med AI-sammanfattningen.\n\n" +
            (data.error ? "Fel: " + data.error : "");
          return;
        }

        resultBox.value =
          "=== SAMMANFATTNING ===\n" +
          data.summary +
          "\n\n=== TRANSKRIBERING ===\n" +
          data.transcript;
      } catch (err) {
        console.error("AI error:", err);
        resultBox.value =
          "Tekniskt fel när vi pratade med servern. Kolla konsolen i devtools.";
      }
    }
  </script>
</body>
</html>
