<!DOCTYPE html>
<html lang="sv">
<head>
  <!-- 01: Meta & Title -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>snipp_ai ‚Äì Offline MVP</title>
  <!-- 02: Minimal stil (dark/glass) -->
  <style>
    :root { --bg:#0b0f14; --panel:#0f172a99; --text:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --danger:#ef4444; --ok:#22c55e; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0b0f14,#0e1320);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:960px;margin:40px auto;padding:24px}
    .card{background:rgba(15,23,42,.6);backdrop-filter:blur(10px);border:1px solid #1f2937;border-radius:18px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:26px} .muted{color:var(--muted);font-size:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button,.btn{background:#111827;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;padding:10px 14px;cursor:pointer}
    button:hover{border-color:#334155}
    .primary{border-color:var(--accent)} .danger{border-color:#7f1d1d;color:#fecaca}
    .ok{border-color:#14532d;color:#bbf7d0}
    input[type="text"]{background:#0b1220;border:1px solid #1f2937;border-radius:12px;color:#e5e7eb;padding:10px 12px;min-width:240px}
    .list{margin-top:16px;display:grid;gap:10px}
    .item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;border:1px solid #1f2937;border-radius:14px;padding:12px}
    .meta{font-size:12px;color:var(--muted)}
    audio{width:100%}
    .pill{display:inline-block;border:1px solid #334155;border-radius:999px;padding:3px 8px;font-size:12px;color:#cbd5e1}
    .wave{height:38px;border:1px dashed #334155;border-radius:10px;display:flex;align-items:flex-end;gap:2px;padding:4px;overflow:hidden}
    .bar{width:3px;background:var(--accent);opacity:.7}
    .right{display:flex;gap:8px;align-items:center}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr 1fr}
    @media (max-width:800px){.two{grid-template-columns:1fr}}
    .sep{height:1px;background:#1f2937;margin:14px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>snipp_ai ‚Äì Offline</h1>
      <div class="muted">Spela in r√∂ster, spara lokalt, exportera/importera. Supabase kommer sen.</div>
      <div class="sep"></div>

      <!-- 03: Inspelning -->
      <div class="grid two">
        <div>
          <div class="row">
            <input id="title" type="text" placeholder="Titel (t.ex. 'Rogan avsnitt 2134 ‚Äì kort review')" />
            <button id="recBtn" class="primary">‚óè Starta inspelning</button>
            <span id="timer" class="pill">00:00</span>
          </div>
          <div id="wave" class="wave" aria-label="live waveform"></div>
          <div class="row" style="margin-top:10px">
            <button id="saveBtn" class="ok" disabled>Spara klipp</button>
            <button id="resetBtn" class="danger">Rensa allt (lokalt)</button>
          </div>
        </div>
        <!-- 04: Export/Import -->
        <div>
          <div class="row">
            <button id="exportBtn">Exportera .json</button>
            <input id="importFile" type="file" accept="application/json" />
            <button id="importBtn">Importera .json</button>
          </div>
          <div class="muted" style="margin-top:6px">Tips: Exportera innan du byter dator/mobil. Importera f√∂r att √•terst√§lla.</div>
        </div>
      </div>

      <div class="sep"></div>

      <!-- 05: Lista -->
      <h3 style="margin:0 0 8px">Dina klipp</h3>
      <div id="list" class="list"></div>

      <div class="sep"></div>

      <!-- 06: ‚ÄúHook‚Äù f√∂r Supabase (avst√§ngd) -->
      <div class="muted">
        Backend-l√§ge: <span id="backendFlag" class="pill">Offline</span> &nbsp;|&nbsp; 
        N√§r nycklar funkar: s√§tt <code>ENABLE_SUPABASE = true</code> i koden (rad markerad nedan) och fyll i URL/KEY.
      </div>
    </div>
  </div>

  <!-- 07: Script -->
  <script>
    // ======= [A] Konfig =======
    // Byt till true n√§r vi vill testa uppladdning (m√•ste fylla URL/KEY)
    const ENABLE_SUPABASE = false; // <-- √§ndra till true sen
    const SUPABASE_URL = "";       // ex: "https://abcxyz.supabase.co"
    const SUPABASE_ANON = "";      // ex: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    const BUCKET = "audio";

    // ======= [B] State =======
    let mediaRecorder, chunks = [], startedAt = 0, timerInt = null, waveInt = null;

    // ======= [C] Helpers =======
    const $ = sel => document.querySelector(sel);
    const fmt = s => String(s).padStart(2,"0");
    function setTimerLabel(sec){
      $("#timer").textContent = `${fmt(Math.floor(sec/60))}:${fmt(sec%60)}`
    }
    function download(filename, text){
      const a = document.createElement('a');
      a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(text);
      a.download = filename; a.click();
    }
    async function blobToBase64(blob){
      const buf = await blob.arrayBuffer();
      let binary = "";
      const bytes = new Uint8Array(buf);
      const len = bytes.byteLength;
      for(let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }
    function base64ToBlob(b64, mime){
      const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      return new Blob([bytes], { type: mime || "audio/webm" });
    }
    function getDB(){
      const raw = localStorage.getItem("snipp_ai_db");
      return raw ? JSON.parse(raw) : { clips: [] };
    }
    function setDB(db){
      localStorage.setItem("snipp_ai_db", JSON.stringify(db));
      renderList();
    }

    // ======= [D] UI: lista =======
    function renderList(){
      const wrap = $("#list"); wrap.innerHTML = "";
      const db = getDB();
      if(!db.clips.length){ wrap.innerHTML = `<div class="muted">Inga klipp sparade √§nnu.</div>`; return; }
      db.clips
        .sort((a,b)=>b.created-a.created)
        .forEach((c, idx) => {
          const div = document.createElement("div");
          div.className = "item";
          const left = document.createElement("div");
          const right = document.createElement("div"); right.className = "right";
          const h4 = document.createElement("div");
          h4.innerHTML = `<strong contenteditable="true" data-id="${c.id}" class="titleEdit">${c.title||"Utan titel"}</strong>
                          <div class="meta">${new Date(c.created).toLocaleString()} ‚Ä¢ ${Math.round((c.duration||0))}s ‚Ä¢ ${Math.round((c.size||0)/1024)} KB</div>`;
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = URL.createObjectURL(base64ToBlob(c.data, c.mime || "audio/webm"));

          left.appendChild(h4); left.appendChild(audio);
          const playBtn = document.createElement("button"); playBtn.textContent = "‚ñ∂ Spela";
          playBtn.onclick = () => { audio.currentTime = 0; audio.play(); };

          const delBtn = document.createElement("button"); delBtn.textContent = "üóë Radera"; delBtn.className="danger";
          delBtn.onclick = () => {
            const ndb = getDB();
            ndb.clips = ndb.clips.filter(x => x.id !== c.id);
            setDB(ndb);
          };

          right.appendChild(playBtn); right.appendChild(delBtn);
          div.appendChild(left); div.appendChild(right);
          wrap.appendChild(div);
        });

      // D√∂p om (inline)
      wrap.querySelectorAll(".titleEdit").forEach(el=>{
        el.addEventListener("blur", ()=>{
          const id = el.getAttribute("data-id");
          const db2 = getDB();
          const k = db2.clips.find(x=>x.id===id);
          if(k){ k.title = el.textContent.trim(); setDB(db2); }
        });
      });
    }

    // ======= [E] Live waveform (dummy RMS) =======
    function startWave(){
      const el = $("#wave"); el.innerHTML = "";
      waveInt = setInterval(()=>{
        const bar = document.createElement("div");
        bar.className = "bar";
        const h = Math.floor(Math.random()*34)+4; // enkel fake-v√•gform som r√∂r sig
        bar.style.height = h + "px";
        el.appendChild(bar);
        if(el.children.length>160) el.removeChild(el.firstChild);
      }, 60);
    }
    function stopWave(){
      clearInterval(waveInt); waveInt = null; $("#wave").innerHTML = "";
    }

    // ======= [F] Recording =======
    $("#recBtn").onclick = async () => {
      if(mediaRecorder && mediaRecorder.state === "recording"){
        mediaRecorder.stop();
        $("#recBtn").textContent = "‚óè Starta inspelning";
        $("#saveBtn").disabled = false;
        clearInterval(timerInt); timerInt = null; stopWave();
        return;
      }
      chunks = [];
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = () => {};
        mediaRecorder.start();
        startedAt = Date.now();
        $("#recBtn").textContent = "‚ñ† Stoppa";
        $("#saveBtn").disabled = true;
        setTimerLabel(0);
        timerInt = setInterval(()=>{
          const sec = Math.floor((Date.now()-startedAt)/1000);
          setTimerLabel(sec);
        }, 1000);
        startWave();
      }catch(err){
        alert("Mikrofonfel: " + err.message);
      }
    };

    $("#saveBtn").onclick = async () => {
      if(!chunks.length){ alert("Inget inspelat."); return; }
      const blob = new Blob(chunks, { type: "audio/webm" });
      const b64 = await blobToBase64(blob);
      const sec = Math.floor((Date.now()-startedAt)/1000) || 0;
      const db = getDB();
      const id = crypto.randomUUID();
      const item = {
        id,
        title: $("#title").value.trim() || "Utan titel",
        created: Date.now(),
        duration: sec,
        size: blob.size,
        mime: "audio/webm",
        data: b64
      };
      db.clips.push(item);
      setDB(db);
      $("#title").value = "";
      $("#saveBtn").disabled = true;
      alert("Klipp sparat lokalt ‚úÖ");

      // ======= [G] F√∂rberedd uppladdning (avst√§ngd) =======
      if(ENABLE_SUPABASE){
        try{
          await uploadToSupabase(item, blob);
          console.log("Uppladdad till Supabase");
        }catch(e){
          console.warn("Supabase uppladdning misslyckades:", e);
        }
      }
    };

    $("#resetBtn").onclick = () => {
      if(confirm("Rensa ALLT lokalt? (g√•r ej att √•ngra)")){
        localStorage.removeItem("snipp_ai_db");
        renderList();
      }
    };

    // ======= [H] Export/Import =======
    $("#exportBtn").onclick = () => {
      const db = getDB();
      const name = `snipp_ai_export_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      download(name, JSON.stringify(db));
    };
    $("#importBtn").onclick = async () => {
      const f = $("#importFile").files?.[0];
      if(!f){ alert("V√§lj en .json att importera"); return; }
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);
        if(!data || !Array.isArray(data.clips)) throw new Error("Fel format");
        setDB(data);
        alert("Import klart ‚úÖ");
      }catch(e){
        alert("Kunde inte importera: " + e.message);
      }
    };

    // ======= [I] (Sen) Supabase uppladdning =======
    async function uploadToSupabase(item, blob){
      // OBS: Detta k√∂rs bara om ENABLE_SUPABASE=true
      if(!SUPABASE_URL || !SUPABASE_ANON) throw new Error("Saknar URL/ANON key");
      // Minimal klient utan SDK (fetch mot Storage REST)
      const path = `${new Date(item.created).toISOString().split('T')[0]}/${item.id}.webm`;
      const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${encodeURIComponent(BUCKET)}/${path}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${SUPABASE_ANON}`,
          "x-upsert": "true",
          "Content-Type": "audio/webm"
        },
        body: blob
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`Storage error ${res.status}: ${t}`);
      }
      return path;
    }

    // ======= [J] Init =======
    function init(){
      $("#backendFlag").textContent = ENABLE_SUPABASE ? "Online (Supabase)" : "Offline";
      renderList();
    }
    init();
  </script>
</body>
</html>
