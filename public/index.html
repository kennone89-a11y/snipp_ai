<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kenai Recorder ‚Äì SuperSafe v2 + Supabase Upload</title>
  <style>
    :root { --bg:#0b0b0f; --card:#15151d; --text:#eef2ff; --muted:#aab; --ok:#4ade80; --warn:#fbbf24; --err:#fb7185; }
    body { margin:0; font-family:system-ui, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:720px; margin:40px auto; padding:16px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.3); }
    h1 { margin:0 0 8px; font-size:24px; }
    .muted { color:var(--muted); }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin:14px 0; }
    button { appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer; }
    .primary { background:#3b82f6; color:white; }
    .danger  { background:#ef4444; color:white; }
    .ghost   { background:transparent; color:var(--text); border:1px solid #2a2a38; }
    audio { width:100%; margin-top:12px; }
    .status { font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:13px; white-space:pre-wrap; background:#101017; border:1px solid #2a2a38; border-radius:12px; padding:12px; margin-top:12px; }
    .ok { color:var(--ok); } .warn{ color:var(--warn);} .err{ color:var(--err); }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    .linkbox { word-break:break-all; background:#0e0e15; padding:10px; border-radius:10px; border:1px dashed #2a2a38; }
    label { font-size:13px; color:var(--muted); }
    input[type="number"] { width:90px; border-radius:8px; border:1px solid #2a2a38; background:#0f0f16; color:var(--text); padding:8px; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #2a2a38; display:inline-block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Kenai Recorder ‚Äì SuperSafe v2</h1>
      <div class="muted">WAV-only, 44.1 kHz mono, auto-stop, Supabase-upload med delbar l√§nk.</div>

      <!-- BLOCK ‚ë† ‚Äì Kontroller -->
      <div class="row">
        <button id="btnStart" class="primary">Starta inspelning</button>
        <button id="btnStop" class="danger" disabled>Stoppa</button>
        <button id="btnDownload" class="ghost" disabled>Ladda ner WAV</button>
      </div>

      <!-- BLOCK ‚ë° ‚Äì Inst√§llningar -->
      <div class="row" style="align-items:center">
        <label>Auto-stop (sek): <input id="autoSeconds" type="number" min="10" max="600" step="10" value="120"></label>
        <span class="pill" id="codecInfo">codec: wav @ 44.1k mono</span>
        <span class="pill" id="ua"></span>
      </div>

      <!-- BLOCK ‚ë¢ ‚Äì Player + status -->
      <audio id="player" controls></audio>
      <div id="status" class="status">Idle.</div>

      <!-- BLOCK ‚ë£ ‚Äì Upload resultat -->
      <div class="grid" id="uploadArea" style="display:none">
        <div><strong>Uppladdad!</strong> H√§r √§r din delbara l√§nk:</div>
        <div class="linkbox" id="publicUrl"></div>
        <div class="row">
          <button id="btnOpen" class="primary">√ñppna</button>
          <button id="btnCopy" class="ghost">Kopiera l√§nk</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ====== BLOCK ‚ë§ ‚Äì KONFIG ======
  // S√§tt dina Supabase-v√§rden h√§r:
  const SUPABASE_URL = "https://hywwzzzxgagqhlxooekz.supabase.co; // <- byt ut hela str√§ngen
  const SUPABASE_ANON_KEY = "sb_publishable_fLQC4d675JKhsc-QXj2oGw_BGIfI87Z';                     // <- din anon public key
  const BUCKET = "audio";                // existerande bucket
  const BASE_PATH = "reviews";           // undermapp
  const MAKE_PUBLIC = true;              // om din bucket √§r public visas direkt en https-l√§nk

  // ====== SuperSafe WAV (44.1k mono) ======
  let audioCtx, mediaStream, sourceNode, processor, recBuffer = [], recording = false, autoTimer=null;
  const statusEl = document.getElementById('status');
  const player   = document.getElementById('player');
  const btnStart = document.getElementById('btnStart');
  const btnStop  = document.getElementById('btnStop');
  const btnDl    = document.getElementById('btnDownload');
  const uaEl     = document.getElementById('ua');
  uaEl.textContent = navigator.userAgent;

  function log(msg, cls) {
    statusEl.innerHTML = (cls ? `<span class="${cls}">${msg}</span>` : msg) + "\n" + statusEl.innerHTML;
  }

  function floatTo16BitPCM(float32Array) {
    const buffer = new ArrayBuffer(float32Array.length * 2);
    const view = new DataView(buffer);
    let offset = 0;
    for (let i = 0; i < float32Array.length; i++, offset += 2) {
      let s = Math.max(-1, Math.min(1, float32Array[i]));
      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
    return view;
  }
  function writeWavHeader(view, sampleRate, numSamples, numChannels=1, bitsPerSample=16) {
    function writeString(v, off, s){ for(let i=0;i<s.length;i++) v.setUint8(off+i, s.charCodeAt(i)); }
    const byteRate = sampleRate * numChannels * bitsPerSample/8;
    const blockAlign = numChannels * bitsPerSample/8;
    writeString(view,0,'RIFF');
    view.setUint32(4, 36 + numSamples*bitsPerSample/8, true);
    writeString(view,8,'WAVE');
    writeString(view,12,'fmt ');
    view.setUint32(16,16,true);
    view.setUint16(20,1,true); // PCM
    view.setUint16(22,numChannels,true);
    view.setUint32(24,sampleRate,true);
    view.setUint32(28,byteRate,true);
    view.setUint16(32,blockAlign,true);
    view.setUint16(34,bitsPerSample,true);
    writeString(view,36,'data');
    view.setUint32(40, numSamples*bitsPerSample/8, true);
  }
  function encodeWav(chunks, sampleRate) {
    // concat Float32
    const length = chunks.reduce((a,c)=>a+c.length,0);
    const pcm16 = new Int16Array(length);
    let offset = 0;
    for (const c of chunks) { pcm16.set(floatTo16BitPCM(c).buffer ? new Int16Array(floatTo16BitPCM(c).buffer) : c, offset); offset += c.length; }

    const buffer = new ArrayBuffer(44 + pcm16.length*2);
    const view = new DataView(buffer);
    writeWavHeader(view, sampleRate, pcm16.length, 1, 16);
    // PCM data
    let pos = 44;
    for (let i=0;i<pcm16.length;i++,pos+=2) view.setInt16(pos, pcm16[i], true);
    return new Blob([view], { type: 'audio/wav' });
  }

  async function startRec() {
    if (recording) return;
    recBuffer = [];
    const autoSec = parseInt(document.getElementById('autoSeconds').value || "120", 10);
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:false, noiseSuppression:false }, video:false });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 44100 });
    sourceNode = audioCtx.createMediaStreamSource(mediaStream);
    processor = audioCtx.createScriptProcessor(4096, 1, 1);
    sourceNode.connect(processor);
    processor.connect(audioCtx.destination);
    processor.onaudioprocess = e => {
      if (!recording) return;
      const ch0 = e.inputBuffer.getChannelData(0);
      // clone buffer
      recBuffer.push(new Float32Array(ch0));
    };
    recording = true;
    btnStart.disabled = true; btnStop.disabled = false; btnDl.disabled = true;
    log(`üéôÔ∏è Recording... auto-stop om ${autoSec}s`);
    autoTimer = setTimeout(stopRec, autoSec * 1000);
  }

  async function stopRec() {
    if (!recording) return;
    recording = false;
    if (autoTimer) { clearTimeout(autoTimer); autoTimer = null; }
    processor && processor.disconnect(); sourceNode && sourceNode.disconnect();
    mediaStream && mediaStream.getTracks().forEach(t=>t.stop());
    const wavBlob = encodeWav(recBuffer, 44100);
    const fname = `kenai-${Date.now()}.wav`;
    player.src = URL.createObjectURL(wavBlob);
    player.load();
    btnStart.disabled = false; btnStop.disabled = true; btnDl.disabled = false;
    btnDl.onclick = () => {
      const a = document.createElement('a');
      a.href = player.src; a.download = fname; a.click();
    };
    log(`‚úÖ Klar: ${fname} ‚Ä¢ ${(wavBlob.size/1024/1024).toFixed(2)} MB`, "ok");

    // === Upload direkt efter stopp ===
    try {
      const url = await uploadToSupabase(wavBlob, fname);
      if (url) {
        document.getElementById('uploadArea').style.display = 'grid';
        document.getElementById('publicUrl').textContent = url;
        document.getElementById('btnOpen').onclick = ()=> window.open(url, '_blank');
        document.getElementById('btnCopy').onclick = async ()=>{
          await navigator.clipboard.writeText(url);
          log("üîó L√§nk kopierad till urklipp.", "ok");
        };
      }
    } catch (e) {
      log("Upload misslyckades: " + e.message, "err");
    }
  }

  btnStart.addEventListener('click', startRec);
  btnStop .addEventListener('click', stopRec);

  // ====== BLOCK ‚ë• ‚Äì SUPABASE UPLOAD ======
  async function uploadToSupabase(blob, filename) {
    if (!SUPABASE_URL.startsWith("http")) {
      throw new Error("SUPABASE_URL saknas (PASTE_HERE_1).");
    }
    if (SUPABASE_ANON_KEY.startsWith("PASTE_")) {
      throw new Error("SUPABASE_ANON_KEY saknas (PASTE_HERE_2).");
    }
    const filePath = `${BASE_PATH}/${filename}`;

    // Storage upload
    const res = await fetch(`${SUPABASE_URL}/storage/v1/object/${encodeURIComponent(BUCKET)}/${encodeURIComponent(filePath)}`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'apikey': SUPABASE_ANON_KEY,
        'x-upsert': 'true',
        'Content-Type': 'audio/wav'
      },
      body: blob
    });

    if (!res.ok) {
      const t = await res.text();
      log("Supabase svar: " + t, "err");
      throw new Error("HTTP " + res.status);
    }
    log("‚¨ÜÔ∏è Uppladdat till storage: " + filePath, "ok");

    if (MAKE_PUBLIC) {
      // Public URL: https://<project>.supabase.co/storage/v1/object/public/<bucket>/<path>
      const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${encodeURIComponent(BUCKET)}/${encodeURIComponent(filePath)}`;
      log("Public URL skapad.", "ok");
      return publicUrl;
    } else {
      // Signed URL som exempel (60 dagar ~ 5184000 sek)
      const signed = await fetch(`${SUPABASE_URL}/storage/v1/object/sign/${encodeURIComponent(BUCKET)}/${encodeURIComponent(filePath)}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'apikey': SUPABASE_ANON_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ expiresIn: 5184000 })
      });
      if (!signed.ok) throw new Error("Kunde inte skapa signed URL.");
      const data = await signed.json();
      const signedUrl = `${SUPABASE_URL}${data.signedURL}`;
      return signedUrl;
    }
  }
  </script>
</body>
</html>
