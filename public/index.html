<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kenai – Recorder (Emergency Unstick)</title>
<style>
  :root { --bg:#0b0f14; --card:#111723; --muted:#8aa0b6; --text:#e6eef7; --ok:#29bf12; --err:#ff006e; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:860px;margin:32px auto;padding:20px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 8px}
  p.muted{color:var(--muted);margin:4px 0 16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
  #startBtn{background:var(--ok);color:#000}
  #stopBtn{background:var(--err);color:#fff}
  #stopBtn[disabled], #startBtn[disabled]{opacity:.45;cursor:not-allowed}
  .controls{display:flex;gap:10px;align-items:center;margin:8px 0 4px}
  select{background:#0a0e14;color:#e6eef7;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;margin:10px 0 4px}
  .kv b{color:#9ec3ff}
  small#status{display:block;white-space:pre-wrap;background:#0a0e14;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;margin-top:10px;min-height:54px;color:var(--muted)}
  audio{width:100%;margin-top:12px}
  a.download{display:inline-block;margin-top:10px;color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Kenai – Recorder (Emergency Unstick)</h1>
      <p class="muted">WAV-only • 44.1 kHz mono • Auto-stop • Inga externa uploads i denna version.</p>

      <div class="row">
        <!-- INLINE onclick = klick funkar alltid -->
        <button id="startBtn" onclick="window.__start && window.__start()">▶︎ Starta inspelning</button>
        <button id="stopBtn"  onclick="window.__stop && window.__stop()" disabled>■ Stoppa</button>
        <span id="dot" style="margin-left:8px">● idle</span>
      </div>

      <div class="controls">
        <label for="maxlen">Maxlängd:</label>
        <select id="maxlen">
          <option value="30000">00:30</option>
          <option value="60000">01:00</option>
          <option value="120000" selected>02:00</option>
          <option value="300000">05:00</option>
        </select>
        <span style="margin-left:8px;color:#9ec3ff">Mono • 44.1 kHz</span>
      </div>

      <div class="kv">
        <b>Tillstånd:</b><span id="state">idle</span>
        <b>Codec:</b><span id="codec">–</span>
        <b>MIME:</b><span id="mime">–</span>
        <b>Filnamn:</b><span id="fname">–</span>
        <b>Storlek:</b><span id="fsize">–</span>
        <b>Varaktighet:</b><span id="dur">00:00</span>
        <b>UA:</b><span id="ua"></span>
      </div>

      <small id="status">Klar. Tryck Starta för att begära mikrofonåtkomst.</small>
      <audio id="player" controls></audio>
      <a id="dl" class="download" download style="display:none">⬇︎ Ladda ner</a>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // ===== refs =====
  var startBtn = document.getElementById('startBtn');
  var stopBtn  = document.getElementById('stopBtn');
  var maxSel   = document.getElementById('maxlen');
  var stateEl  = document.getElementById('state');
  var codecEl  = document.getElementById('codec');
  var mimeEl   = document.getElementById('mime');
  var fnameEl  = document.getElementById('fname');
  var fsizeEl  = document.getElementById('fsize');
  var durEl    = document.getElementById('dur');
  var statusEl = document.getElementById('status');
  var player   = document.getElementById('player');
  var dl       = document.getElementById('dl');
  var dot      = document.getElementById('dot');
  var uaEl     = document.getElementById('ua'); uaEl.textContent = navigator.userAgent;

  // ===== state =====
  var STATE={IDLE:'idle',REC:'recording',STOP:'stopping',DONE:'done'};
  var startedAt=0, tick=null, hard=null, MAX_MS=+maxSel.value;

  function log(m){ statusEl.textContent = (statusEl.textContent ? statusEl.textContent + '\n' : '') + m; }
  function setState(s){
    stateEl.textContent=s;
    dot.textContent = (s===STATE.REC? '● recording' : s===STATE.STOP? '● stopping' : s===STATE.DONE? '● done' : '● idle');
    dot.style.color = (s===STATE.REC? '#ff3864' : s===STATE.STOP? '#ffbe0b' : s===STATE.DONE? '#29bf12' : '#8aa0b6');
    // Failsafe: tvinga knapplägen
    startBtn.disabled = (s!==STATE.IDLE) ? true : false;
    stopBtn.disabled  = (s!==STATE.REC)  ? true : false;
  }
  setState(STATE.IDLE); // lås upp vid start

  maxSel.onchange = function(){ MAX_MS = +maxSel.value; };

  function tstr(ms){ var s=(ms/1000|0), m=('0'+(s/60|0)).slice(-2); return m+':'+('0'+(s%60)).slice(-2); }
  function startTick(){
    startedAt=performance.now();
    stopTick();
    tick=setInterval(function(){
      var e=performance.now()-startedAt;
      durEl.textContent=tstr(e);
      if(e>=MAX_MS){ log('Auto-stop'); stopRec(); }
    },250);
  }
  function stopTick(){ if(tick){clearInterval(tick); tick=null;} }

  // ===== WAV engine (44.1 kHz mono) =====
  var stream=null, ac=null, src=null, proc=null;
  var bufs=[], chs=1, rate=44100;

  async function startRec(){
    try{
      setState(STATE.REC);
      statusEl.textContent = '1) Begär mikrofon…';
      // HTTPS krävs för mic; se till att sidan är https://
      stream = await navigator.mediaDevices.getUserMedia({audio:true});
      log('✔︎ Mikrofon OK');
      startTick();

      var AC=window.AudioContext||window.webkitAudioContext;
      ac=new AC({sampleRate:44100});
      log('2) AudioContext @ ' + ac.sampleRate + ' Hz');
      rate=ac.sampleRate;
      src=ac.createMediaStreamSource(stream);
      chs=1;
      proc=ac.createScriptProcessor(4096,chs,chs);
      bufs=[]; for(var c=0;c<chs;c++) bufs[c]=[];
      proc.onaudioprocess=function(e){
        for(var c=0;c<chs;c++) bufs[c].push(new Float32Array(e.inputBuffer.getChannelData(c)));
      };
      src.connect(proc); proc.connect(ac.destination);
      log('3) Spelar in …');

      codecEl.textContent='WAV-fallback';
      mimeEl.textContent='audio/wav';
      fnameEl.textContent='–'; fsizeEl.textContent='–';
      dl.style.display='none'; player.src='';

      if(hard) clearTimeout(hard);
      hard=setTimeout(function(){ log('Auto-stop (hard)'); stopRec(); }, MAX_MS+600);
    }catch(e){
      setState(STATE.IDLE); stopTick();
      log('✖︎ Fel: '+e.message);
    }
  }

  function stopRec(){
    if(stateEl.textContent!==STATE.REC && stateEl.textContent!==STATE.STOP) return;
    setState(STATE.STOP); stopTick(); if(hard){clearTimeout(hard); hard=null;}
    log('4) Stoppar inspelning…');
    try{ proc&&proc.disconnect(); src&&src.disconnect(); }catch(_){}

    try{
      log('5) Bygger WAV…');
      var len = 0; for (var i=0;i<bufs[0].length;i++) len += bufs[0][i].length;
      var inter = new Float32Array(len * chs), off = 0;
      for (var b=0;b<bufs[0].length;b++){
        var L = bufs[0][b].length;
        for (var s=0;s<L;s++){
          for (var c=0;c<chs;c++){
            inter[(off+s)*chs + c] = bufs[c][b][s];
          }
        }
        off += L;
      }
      var bytesPerSample = 2;
      var blockAlign = chs * bytesPerSample;
      var ab = new ArrayBuffer(44 + inter.length * bytesPerSample);
      var view = new DataView(ab);
      function W(v,o,s){ for (var i=0;i<s.length;i++) v.setUint8(o+i, s.charCodeAt(i)); }
      W(view, 0, 'RIFF');
      view.setUint32(4, 36 + inter.length * bytesPerSample, true);
      W(view, 8, 'WAVE'); W(view, 12, 'fmt ');
      view.setUint32(16, 16, true); view.setUint16(20, 1, true);
      view.setUint16(22, chs, true); view.setUint32(24, rate, true);
      view.setUint32(28, rate * blockAlign, true);
      view.setUint16(32, blockAlign, true); view.setUint16(34, 16, true);
      W(view, 36, 'data'); view.setUint32(40, inter.length * bytesPerSample, true);
      var idx = 44;
      for (var k=0;k<inter.length;k++){
        var s = Math.max(-1, Math.min(1, inter[k]));
        view.setInt16(idx, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        idx += 2;
      }
      var blob = new Blob([view], { type: 'audio/wav' });
      log('✔︎ WAV klar: ' + (blob.size/1024/1024).toFixed(2) + ' MB');

      finish(blob, 'wav');
    }catch(err){
      log('✖︎ Packningsfel: ' + err.message);
    }

    // stäng efter att blob är klar
    try{ ac&&ac.close(); }catch(_){}
    try{ stream&&stream.getTracks().forEach(function(t){ t.stop(); }); }catch(_){}
  }

  function finish(blob,ext){
    setState(STATE.DONE);
    var url=URL.createObjectURL(blob);
    player.src=url; try{ player.load(); }catch(_){}
    var name='kenai-'+ts()+'.'+ext;
    dl.download=name; dl.href=url; dl.style.display='inline-block';
    fnameEl.textContent=name; fsizeEl.textContent=(blob.size/1024/1024).toFixed(2)+' MB';
    log('6) Klar – tryck play om den inte startar själv.');
  }

  function ts(){ var d=new Date(),p=n=>('0'+n).slice(-2); return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+'-'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }

  // Exponera start/stop globalt så inline onclick alltid fungerar
  window.__start = startRec;
  window.__stop  = stopRec;

  // Felsäkring: om något JS-fel händer, lås upp knapparna
  window.addEventListener('error', function(e){
    setState(STATE.IDLE);
    log('✖︎ JS-fel: ' + e.message);
  });

  // Ytterligare failsafe vid sidladdning
  setTimeout(function(){
    startBtn.disabled = false;
    stopBtn.disabled  = true;
  }, 0);
})();
</script>
</body>
</html>
