<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kenai – Recorder (WAV + Supabase)</title>

  <!-- FYLL I DINA TVÅ VÄRDEN -->
  <meta name="supabase-url" content="https://hywwzzzxgagqhlxooekz.supabase.co;>
  <meta name="supabase-anon" content="sb_publishable_fLQC4d675JKhsc-QXj2oGw_BGIfI87Z';>

  <style>
    :root{--bg:#0b0f14;--card:#111723;--muted:#8aa0b6;--text:#e6eef7;--ok:#29bf12;--err:#ff006e}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:880px;margin:32px auto;padding:20px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px}
    p.muted{color:var(--muted);margin:4px 0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    #startBtn{background:#22ff7f;color:#001}
    #stopBtn{background:#ff2f6e;color:#fff}
    #shareBtn{background:#4aa8ff;color:#001}
    #stopBtn[disabled],#startBtn[disabled],#shareBtn[disabled]{opacity:.45;cursor:not-allowed}
    select{background:#0a0e14;color:#e6eef7;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;margin:10px 0 4px}
    #codec,#mime,#name,#size,#dur{color:#9ec3ff}
    small#status{display:block;white-space:pre-wrap;background:#0a0e14;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;margin-top:10px}
    audio{width:100%;margin-top:12px}
    a.action{display:inline-block;margin-top:10px;color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Kenai – Recorder</h1>
      <p class="muted">WAV-only, 44.1 kHz mono, auto-stop. Supabase-upload → delbar länk.</p>

      <div class="row">
        <button id="startBtn">Starta inspelning</button>
        <button id="stopBtn" disabled>Stoppa</button>
        <button id="shareBtn" disabled>Dela (upload)</button>

        <label for="maxlen">Maxlängd:</label>
        <select id="maxlen">
          <option value="30000">00:30</option>
          <option value="60000">01:00</option>
          <option value="120000" selected>02:00</option>
          <option value="300000">05:00</option>
        </select>
        <span style="margin-left:8px;color:#9ec3ff">Mono, 44100 Hz</span>
      </div>

      <div class="kv">
        <b>Tillstånd:</b><span id="state">idle</span>
        <b>Codec:</b><span id="codec">WAV-fallback</span>
        <b>MIME:</b><span id="mime">audio/wav</span>
        <b>Filnamn:</b><span id="name">–</span>
        <b>Storlek:</b><span id="size">–</span>
        <b>Varaktighet:</b><span id="dur">00:00</span>
        <b>UA:</b><span id="ua"></span>
      </div>

      <small id="status">Klar. Tryck Starta för att begära mikrofontillstånd.</small>
      <audio id="player" controls></audio>

      <div id="dlbox" style="margin-top:8px">
        <a id="dl" class="action" download style="display:none">Ladda ner</a>
        <a id="open" class="action" target="_blank" rel="noopener" style="display:none">Öppna fil</a>
        <a id="copy" class="action" href="javascript:void(0)" style="display:none">Kopiera länk</a>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    // ====== Supabase config (läser från <meta>) ======
    const SUPABASE_URL  = document.querySelector('meta[name="supabase-url"]')?.content?.trim() || '';
    const SUPABASE_ANON = document.querySelector('meta[name="supabase-anon"]')?.content?.trim() || '';
    const SUPABASE_BUCKET = 'audio';
    const SUPABASE_PATH   = 'reviews';

    // ====== refs ======
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const shareBtn = document.getElementById('shareBtn');
    const maxSel   = document.getElementById('maxlen');
    const stateEl  = document.getElementById('state');
    const codecEl  = document.getElementById('codec');
    const mimeEl   = document.getElementById('mime');
    const nameEl   = document.getElementById('name');
    const sizeEl   = document.getElementById('size');
    const durEl    = document.getElementById('dur');
    const statusEl = document.getElementById('status');
    const player   = document.getElementById('player');
    const dl       = document.getElementById('dl');
    const openA    = document.getElementById('open');
    const copyA    = document.getElementById('copy');
    document.getElementById('ua').textContent = navigator.userAgent;

    // ====== state ======
    const S = { IDLE:'idle', REC:'recording', STOP:'stopping', DONE:'done' };
    let STATE=S.IDLE, startedAt=0, tick=null, maxMs=+maxSel.value;
    let ac=null, stream=null, proc=null, bufs=[], chs=1, rate=44100;
    let lastBlob=null, lastName='';

    function setState(s){
      STATE=s; stateEl.textContent=s;
      stopBtn.disabled = (s!==S.REC);
      startBtn.disabled= (s!==S.IDLE);
      shareBtn.disabled= !(s===S.DONE);
    }
    function log(t){ statusEl.textContent += (statusEl.textContent?'\n':'') + t; statusEl.scrollTop = statusEl.scrollHeight; }
    function ts(ms){ const s=Math.floor(ms/1000), m=('0'+Math.floor(s/60)).slice(-2), ss=('0'+(s%60)).slice(-2); return m+':'+ss; }

    // ====== WAV utils ======
    function interleave(buffers, len){
      const out = new Float32Array(len);
      let off=0; for(const b of buffers){ out.set(b, off); off+=b.length; }
      return out;
    }
    function floatTo16BitPCM(input){
      const out = new DataView(new ArrayBuffer(input.length*2));
      let offset=0;
      for(let i=0;i<input.length;i++){
        let s = Math.max(-1, Math.min(1, input[i]));
        out.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true);
        offset+=2;
      }
      return out;
    }
    function writeWav(samples, sampleRate){
      const numFrames=samples.length, blockAlign=chs*2, byteRate=sampleRate*blockAlign;
      const buffer = new ArrayBuffer(44 + numFrames*2);
      const view   = new DataView(buffer);
      function wStr(o,s){ for(let i=0;i<s.length;i++) view.setUint8(o+i, s.charCodeAt(i)); }
      let o=0;
      wStr(o,'RIFF'); o+=4;
      view.setUint32(o, 36 + numFrames*2, true); o+=4;
      wStr(o,'WAVE'); o+=4;
      wStr(o,'fmt '); o+=4;
      view.setUint32(o, 16, true); o+=4;           // PCM chunk length
      view.setUint16(o, 1, true); o+=2;            // PCM
      view.setUint16(o, chs, true); o+=2;
      view.setUint32(o, sampleRate, true); o+=4;
      view.setUint32(o, byteRate, true); o+=4;
      view.setUint16(o, blockAlign, true); o+=2;
      view.setUint16(o, 16, true); o+=2;           // bits/sample
      wStr(o,'data'); o+=4;
      view.setUint32(o, numFrames*2, true); o+=4;
      const pcm = floatTo16BitPCM(samples);
      // copy PCM after header
      new Uint8Array(buffer, 44).set(new Uint8Array(pcm.buffer));
      return new Blob([buffer], {type:'audio/wav'});
    }

    // ====== recorder ======
    async function startRec(){
      try{
        statusEl.textContent = 'Begär mikrofon...';
        stream = await navigator.mediaDevices.getUserMedia({audio:true});
        statusEl.textContent = 'Mikrofon OK\nSkapar AudioContext...';
        ac = new (window.AudioContext || window.webkitAudioContext)({sampleRate:44100});
        rate = ac.sampleRate; // iOS → 44100
        const src = ac.createMediaStreamSource(stream);
        proc = ac.createScriptProcessor(4096, chs, chs);
        proc.onaudioprocess = (e)=>{
          const ch0 = e.inputBuffer.getChannelData(0);
          bufs.push(new Float32Array(ch0));
        };
        src.connect(proc); proc.connect(ac.destination);
        bufs = []; startedAt = performance.now();
        setState(S.REC);
        statusEl.textContent = 'Spelar in...';
        tick = setInterval(()=>{
          durEl.textContent = ts(performance.now()-startedAt);
          if(performance.now()-startedAt >= maxMs){ stopRec(); }
        }, 200);
      }catch(err){
        log('Fel: ' + err.message);
        setState(S.IDLE);
      }
    }

    async function stopRec(){
      if(STATE!==S.REC) return;
      setState(S.STOP);
      clearInterval(tick);
      statusEl.textContent = 'Stoppar inspelning...';

      try{
        proc && proc.disconnect(); proc=null;
        ac   && ac.close(); ac=null;
        stream && stream.getTracks().forEach(t=>t.stop());

        const samples = interleave(bufs, bufs.reduce((a,b)=>a+b.length,0));
        const wav = writeWav(samples, 44100);
        lastBlob = wav;

        const name = 'kenai-'+new Date().toISOString().replace(/[-:T.Z]/g,'').slice(0,14)+'.wav';
        lastName = name;

        player.src = URL.createObjectURL(wav);
        player.load(); player.play().catch(()=>{});
        dl.download = name; dl.href = player.src; dl.style.display='inline-block';

        nameEl.textContent = name;
        sizeEl.textContent = (wav.size/1024/1024).toFixed(2) + ' MB';
        durEl.textContent  = ts(performance.now()-startedAt);
        setState(S.DONE);
        log('WAV klar. Tryck “Dela” för att ladda upp.');
      }catch(err){
        log('Stop-fel: '+err.message);
        setState(S.IDLE);
      }
    }

    // ====== Supabase upload ======
    async function uploadSupabase(blob, name){
      if(!SUPABASE_URL || SUPABASE_URL.indexOf('https://')!==0) throw new Error('Supabase URL saknas/fel.');
      if(!SUPABASE_ANON || SUPABASE_ANON.length<20)           throw new Error('Supabase anon-key saknas/fel.');
      const path = encodeURIComponent(SUPABASE_BUCKET) + '/' + encodeURIComponent(SUPABASE_PATH) + '/' + encodeURIComponent(name);
      const endpoint = `${SUPABASE_URL}/storage/v1/object/${path}`;
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + SUPABASE_ANON,
          'Content-Type': blob.type || 'application/octet-stream',
          'x-upsert': 'true'
        },
        body: blob
      });
      if(!res.ok){
        const t = await res.text().catch(()=>String(res.status));
        throw new Error('Upload misslyckades: '+res.status+' '+t);
      }
      // Public URL
      return `${SUPABASE_URL}/storage/v1/object/public/${SUPABASE_BUCKET}/${SUPABASE_PATH}/${name}`;
    }

    async function share(){
      if(STATE!==S.DONE || !lastBlob){ log('Ingen fil att ladda upp.'); return; }
      shareBtn.disabled = true;
      log('Laddar upp till Supabase...');
      try{
        const url = await uploadSupabase(lastBlob, lastName);
        openA.href = url;  openA.style.display='inline-block';
        copyA.style.display='inline-block';
        copyA.onclick = async ()=>{
          try{ await navigator.clipboard.writeText(url); copyA.textContent='Länk kopierad!'; setTimeout(()=>copyA.textContent='Kopiera länk',1500);}catch(e){ alert(url); }
        };
        log('Upload klar ✅\n'+url);
      }catch(err){
        log('Supabase-fel: ' + err.message);
      }finally{
        shareBtn.disabled = false;
      }
    }

    // ====== wire up ======
    startBtn.onclick = startRec;
    stopBtn.onclick  = stopRec;
    shareBtn.onclick = share;
    maxSel.onchange  = e => { maxMs = +e.target.value; };

    // init
    document.getElementById('mime').textContent = 'audio/wav';
    log('JS laddades (start)');
  })();
  </script>
</body>
</html>
