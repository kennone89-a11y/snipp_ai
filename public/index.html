<script>
(function(){
  'use strict';

  // ===== Super-minimal WAV-only recorder (2:00 auto-stop) =====
  var MAX_MS = 120000; // 2 min

  var startBtn = document.getElementById('startBtn');
  var stopBtn  = document.getElementById('stopBtn');
  var stateEl  = document.getElementById('state');
  var codecEl  = document.getElementById('codec');
  var mimeEl   = document.getElementById('mime');
  var fnameEl  = document.getElementById('fname');
  var fsizeEl  = document.getElementById('fsize');
  var durEl    = document.getElementById('dur');
  var statusEl = document.getElementById('status');
  var player   = document.getElementById('player');
  var dl       = document.getElementById('dl');
  function log(m){ statusEl.textContent = m; }

  var STATE={IDLE:'idle',REC:'recording',STOP:'stopping',DONE:'done'};
  function setState(s){
    stateEl.textContent=s;
    startBtn.disabled = (s!==STATE.IDLE);
    stopBtn.disabled  = (s!==STATE.REC);
  }
  setState(STATE.IDLE);

  var startedAt=0, tick=null, hard=null;
  function tstr(ms){ var s=(ms/1000|0), m=('0'+(s/60|0)).slice(-2); return m+':'+('0'+(s%60)).slice(-2); }
  function startTick(){
    startedAt=performance.now();
    stopTick();
    tick=setInterval(function(){
      var e=performance.now()-startedAt;
      durEl.textContent=tstr(e);
      if(e>=MAX_MS){ log('Auto-stop 2:00'); stopRec(); }
    },250);
  }
  function stopTick(){ if(tick){clearInterval(tick); tick=null;} }

  // WAV buffers
  var stream=null, ac=null, src=null, proc=null;
  var bufs=[], chs=1, rate=48000;

  async function startRec(){
    try{
      setState(STATE.REC);
      log('Begär mikrofonåtkomst…');
      stream = await navigator.mediaDevices.getUserMedia({audio:true});
      startTick();

      var AC=window.AudioContext||window.webkitAudioContext;
      ac=new AC({sampleRate:48000});
      rate=ac.sampleRate;
      src=ac.createMediaStreamSource(stream);
      chs=Math.min(2,src.channelCount||1);
      proc=ac.createScriptProcessor(4096,chs,chs);
      bufs=[]; for(var c=0;c<chs;c++) bufs[c]=[];
      proc.onaudioprocess=function(e){
        for(var c=0;c<chs;c++) bufs[c].push(new Float32Array(e.inputBuffer.getChannelData(c)));
      };
      src.connect(proc); proc.connect(ac.destination);

      codecEl.textContent='WAV-fallback';
      mimeEl.textContent='audio/wav';
      fnameEl.textContent='–'; fsizeEl.textContent='–'; dl.style.display='none'; player.src='';
      if(hard) clearTimeout(hard);
      hard=setTimeout(function(){ log('Auto-stop (hard)'); stopRec(); }, MAX_MS+500);
    }catch(e){
      setState(STATE.IDLE); stopTick();
      log('Fel: '+e.message);
    }
  }

  function stopRec(){
    if(stateEl.textContent!==STATE.REC && stateEl.textContent!==STATE.STOP) return;
    setState(STATE.STOP); stopTick(); if(hard){clearTimeout(hard); hard=null;}
    try{ proc&&proc.disconnect(); src&&src.disconnect(); }catch(_){}
    try{ ac&&ac.close(); }catch(_){}
    try{ stream&&stream.getTracks().forEach(t=>t.stop()); }catch(_){}
    // packa WAV
    var len=0; for(var i=0;i<bufs[0].length;i++) len+=bufs[0][i].length;
    var inter=new Float32Array(len*chs), off=0;
    for(var b=0;b<bufs[0].length;b++){
      var L=bufs[0][b].length;
      for(var s=0;s<L;s++){ for(var c=0;c<chs;c++){ inter[(off+s)*chs+c]=bufs[c][b][s]; } }
      off+=L;
    }
    var bytesPerSample=2, blockAlign=chs*bytesPerSample;
    var buf=new ArrayBuffer(44+inter.length*bytesPerSample), v=new DataView(buf);
    w('RIFF'); v.setUint32(4,36+inter.length*bytesPerSample,true);
    w('WAVE'); w('fmt '); v.setUint32(16,16,true); v.setUint16(20,1,true);
    v.setUint16(22,chs,true); v.setUint32(24,rate,true);
    v.setUint32(28,rate*blockAlign,true); v.setUint16(32,blockAlign,true); v.setUint16(34,16,true);
    w('data'); v.setUint32(40,inter.length*bytesPerSample,true);
    var idx=44;
    for(var k=0;k<inter.length;k++){ var s=Math.max(-1,Math.min(1,inter[k])); v.setInt16(idx, s<0?s*0x8000:s*0x7FFF, true); idx+=2; }
    var blob=new Blob([v],{type:'audio/wav'});
    finish(blob,'wav');

    function w(s){ for(var i=0;i<s.length;i++) v.setUint8((arguments.callee.pos||0)+i, s.charCodeAt(i)); arguments.callee.pos=(arguments.callee.pos||0)+s.length; }
  }

  function finish(blob,ext){
    setState(STATE.DONE);
    var url=URL.createObjectURL(blob); player.src=url;
    var name='kenai-'+ts()+'.'+ext; dl.download=name; dl.href=url; dl.style.display='inline-block';
    fnameEl.textContent=name; fsizeEl.textContent=(blob.size/1024/1024).toFixed(2)+' MB';
    log('Klar. Spela upp eller ladda ner filen.');
  }
  function ts(){ var d=new Date(),p=n=>('0'+n).slice(-2); return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+'-'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }

  startBtn.onclick=startRec;
  stopBtn.onclick=stopRec;

  window.addEventListener('error', function(e){ setState(STATE.IDLE); log('JS-fel: '+e.message); });
})();
</script>
