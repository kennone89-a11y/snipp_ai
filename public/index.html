<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snipp ‚Äì Ljud till Text</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      max-width: 860px;
      margin: 32px auto;
      padding: 0 16px;
      background: var(--bg);
    }
    h1 { margin-bottom: 12px; }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,.05);
      margin: 16px 0;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background:#111; color:#fff;
      cursor:pointer;
      transition: all .2s;
    }
    button.secondary { background:#fff; color:#111; }
    button:hover { opacity: .85; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    textarea {
      width:100%; min-height:160px; padding:12px;
      border-radius: 12px; border:1px solid #d1d5db;
    }
    .muted { color:#6b7280; font-size:12px; }
    ul { list-style:none; padding:0; margin:0; }
    li {
      display:flex; justify-content:space-between; align-items:center;
      gap:8px; padding:8px 0; border-bottom:1px solid #eee;
    }
    .right { margin-left:auto; }
    #status { font-size:14px; margin-top:6px; opacity:.85; }
  </style>
</head>
<body>
  <h1>üéôÔ∏è Snipp ‚Äì Ljud till Text</h1>

  <div class="card">
    <div class="row">
      <button id="recordBtn">üé§ Starta inspelning</button>
      <button id="stopBtn" class="secondary" disabled>‚èπÔ∏è Stoppa</button>
      <button id="saveLocalBtn" class="secondary">üíæ Spara som textfil</button>
      <span class="right">
        <input id="fileInput" type="file" accept=".flac,.m4a,.mp3,.mp4,.mpeg,.mpga,.oga,.ogg,.wav,.webm" style="display:none" />
        <button id="uploadBtn" class="secondary">üì§ Ladda upp ljudfil</button>
      </span>
    </div>

    <div id="status">‚úÖ Redo</div>
    <audio id="player" controls style="width:100%; margin-top:12px; display:none;"></audio>

    <h3>Transkription</h3>
    <textarea id="result" placeholder="H√§r kommer texten..."></textarea>
    <div class="muted">Transkriptioner sparas automatiskt p√• servern.</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h3 style="margin:0">üóÇÔ∏è Historik</h3>
      <button id="refreshBtn" class="secondary">Uppdatera</button>
    </div>
    <ul id="history"><li class="muted">H√§mtar...</li></ul>
  </div>

  <script>
  (function () {
    const $ = (id) => document.getElementById(id);
    const statusEl = $('status');
    const setStatus = (m) => statusEl.textContent = m;

    const recordBtn = $('recordBtn');
    const stopBtn = $('stopBtn');
    const saveLocalBtn = $('saveLocalBtn');
    const player = $('player');
    const result = $('result');
    const historyEl = $('history');
    const refreshBtn = $('refreshBtn');
    const fileInput = $('fileInput');
    const uploadBtn = $('uploadBtn');

    let mediaRecorder = null;
    let chunks = [];

    // Testa backend
    fetch('/api/health').then(r => r.json()).then(j => {
      if (!j.ok) setStatus('‚ö†Ô∏è Backend fel: ' + JSON.stringify(j));
    }).catch(() => setStatus('‚ùå Kunde inte n√• backend.'));

    // Ladda upp f√§rdig ljudfil
    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      await transcribeFile(file);
      fileInput.value = '';
    };

    async function transcribeFile(file) {
      const form = new FormData();
      form.append('audio', file, file.name || 'file.webm');
      setStatus('‚¨ÜÔ∏è Laddar upp & transkriberar...');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: form });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        result.value = data.text || '';
        setStatus('‚úÖ Klar!');
        await loadHistory();
      } catch (err) {
        console.error(err);
        setStatus('‚ùå Fel: ' + err.message);
      }
    }

    // Spela in
    recordBtn.onclick = async () => {
      if (!navigator.mediaDevices) return alert('Din webbl√§sare st√∂der inte inspelning.');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size) chunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          const blob = new Blob(chunks, { type: 'audio/webm' });
          player.src = URL.createObjectURL(blob);
          player.style.display = 'block';
          await transcribeFile(new File([blob], 'inspelning.webm', { type: 'audio/webm' }));
          stream.getTracks().forEach(t => t.stop());
          recordBtn.disabled = false; stopBtn.disabled = true;
        };
        mediaRecorder.start();
        recordBtn.disabled = true; stopBtn.disabled = false;
        setStatus('üéôÔ∏è Spelar in...');
      } catch (err) {
        console.error(err);
        setStatus('‚ùå Ingen mikrofon√•tkomst.');
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        setStatus('‚èπÔ∏è Stoppar...');
        mediaRecorder.stop();
      }
    };

    // Spara lokalt
    saveLocalBtn.onclick = () => {
      const text = result.value.trim();
      if (!text) return alert('Ingen text att spara.');
      const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `transkript_${Date.now()}.txt`;
      a.click();
    };

    // Historik
    async function loadHistory() {
      try {
        const res = await fetch('/api/history');
        const data = await res.json();
        const files = Array.isArray(data.files) ? data.files : [];
        if (!files.length) return historyEl.innerHTML = '<li class="muted">Ingen historik √§nnu.</li>';
        historyEl.innerHTML = files.map(f => {
          const dt = new Date(f.mtime).toLocaleString();
          const sizeKB = (f.size/1024).toFixed(1);
          const name = encodeURIComponent(f.name);
          return `<li>
            <div><strong>${f.name}</strong><div class="muted">${dt} ¬∑ ${sizeKB} KB</div></div>
            <div>
              <a href="/api/text/${name}" download><button class="secondary">‚¨áÔ∏è Ladda ner</button></a>
              <button class="secondary" onclick="delFile('${name}')">üóëÔ∏è Radera</button>
            </div>
          </li>`;
        }).join('');
      } catch (err) {
        historyEl.innerHTML = '<li class="muted">Kunde inte h√§mta historik.</li>';
      }
    }
    window.delFile = async (name) => {
      if (!confirm('Radera filen permanent?')) return;
      await fetch('/api/text/' + name, { method: 'DELETE' });
      await loadHistory();
    };
    refreshBtn.onclick = loadHistory;

    loadHistory();
  })();
  </script>
</body>
</html>
