<!-- App Script -->
<script>
  // ===== CONFIG (byt dessa två exakt, inga radbrytningar eller “smarta” citattecken) =====
  const SUPABASE_URL  = "https://hywwzzzxgagqhlxooekz.supabase.co";   // ex: https://abcxyzcompany.supabase.co
  const SUPABASE_ANON = "sb_publishable_fLQC4d675JKhsc-QXj2oGw_BGIfI87Z;
  const BUCKET = "audio";

  // Säker start-logg så vi ser att skriptet laddats
  console.log("BOOT OK");

  // Initiera klient
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ===== STATE =====
  let mediaRecorder, chunks = [], startedAt = 0, timerInt = null, waveInt = null;
  const uploads = [];

  // ===== HELPERS =====
  const $ = s => document.querySelector(s);
  const fmt = s => String(s).padStart(2,"0");
  $("#year").textContent = new Date().getFullYear();
  function setTimer(sec){ $("#timer").textContent = `${fmt(Math.floor(sec/60))}:${fmt(sec%60)}` }
  function startWave(){
    const el = $("#wave"); el.innerHTML = "";
    waveInt = setInterval(()=>{
      const bar=document.createElement("div");
      bar.className="bar";
      bar.style.height=(Math.floor(Math.random()*34)+6)+"px";
      el.appendChild(bar);
      if(el.children.length>160) el.removeChild(el.firstChild);
    }, 60);
  }
  function stopWave(){ clearInterval(waveInt); waveInt=null; $("#wave").innerHTML=""; }

  function renderList(items){
    const wrap = $("#list"); wrap.innerHTML = "";
    if(!items.length){ wrap.innerHTML = `<div class="muted">Inga uppladdningar ännu.</div>`; return; }
    items.slice().reverse().forEach((c)=>{
      const div = document.createElement("div"); div.className = "item";
      const left = document.createElement("div"); const right = document.createElement("div"); right.className="right";
      const h4 = document.createElement("div");
      h4.innerHTML = `<strong>${c.title||"Utan titel"}</strong>
                      <div class="meta">${new Date(c.created).toLocaleString()} • ${Math.round((c.duration||0))}s • ${Math.round((c.size||0)/1024)} KB</div>`;
      const audio = document.createElement("audio"); audio.controls = true; audio.src = c.publicUrl || c.objectUrl;
      left.appendChild(h4); left.appendChild(audio);
      if (c.publicUrl){
        const linkBtn = document.createElement("a"); linkBtn.href = c.publicUrl; linkBtn.target="_blank"; linkBtn.rel="noopener";
        const btn = document.createElement("button"); btn.textContent = "Öppna URL"; linkBtn.appendChild(btn);
        right.appendChild(linkBtn);
      }
      div.appendChild(left); div.appendChild(right);
      wrap.appendChild(div);
    });
  }

  // ===== RECORD =====
  $("#recBtn").onclick = async () => {
    if(mediaRecorder && mediaRecorder.state === "recording"){
      mediaRecorder.stop();
      $("#recBtn").textContent = "● Starta inspelning";
      $("#saveBtn").disabled = false;
      clearInterval(timerInt); timerInt = null; stopWave();
      $("#liveDot")?.classList.remove("live");
      return;
    }
    chunks = [];
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.start();
      startedAt = Date.now();
      $("#recBtn").textContent = "■ Stoppa";
      $("#saveBtn").disabled = true;
      setTimer(0);
      timerInt = setInterval(()=>{ setTimer(Math.floor((Date.now()-startedAt)/1000)) }, 1000);
      startWave();
      $("#liveDot")?.classList.add("live");
    }catch(err){
      alert("Mikrofonfel: " + err.message);
    }
  };

  // ===== UPLOAD =====
  async function uploadToSupabase(path, blob){
    const { data, error } = await sb.storage.from(BUCKET).upload(
      path, blob, { upsert: true, contentType: "audio/webm" }
    );
    if (error) throw error;
    const { data: pub } = sb.storage.from(BUCKET).getPublicUrl(path);
    return pub.publicUrl;
  }

  $("#saveBtn").onclick = async () => {
    if(!chunks.length){ alert("Inget inspelat."); return; }
    const blob = new Blob(chunks, { type: "audio/webm" });
    const sec = Math.floor((Date.now()-startedAt)/1000) || 0;

    const title = $("#title").value.trim() || "Utan titel";
    const id = crypto.randomUUID();
    const dateFolder = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const path = `${dateFolder}/${id}.webm`;

    try{
      const publicUrl = await uploadToSupabase(path, blob);
      const objectUrl = URL.createObjectURL(blob);
      const item = { id, title, created: Date.now(), duration: sec, size: blob.size, publicUrl, objectUrl };
      uploads.push(item);
      renderList(uploads);
      $("#title").value = "";
      $("#saveBtn").disabled = true;
      alert("Uppladdat ✅");
    }catch(e){
      console.error(e);
      alert("Uppladdning misslyckades: " + e.message);
    }
  };

  $("#resetBtn").onclick = () => {
    if(confirm("Rensa visad lista? (påverkar inte filer i Supabase)")){
      uploads.length = 0; renderList(uploads);
    }
  };
</script>
