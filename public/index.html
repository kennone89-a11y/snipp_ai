<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snipp â€“ Ljud â†’ Text</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 820px; margin: 40px auto; padding: 0 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.04); margin-bottom: 20px; }
    button { padding: 10px 16px; border-radius: 10px; border: 1px solid #d1d5db; background: #111; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    #status { opacity: .8; font-size: 14px; margin-top: 8px; }
    textarea { width: 100%; min-height: 160px; padding: 12px; border-radius: 12px; border: 1px solid #d1d5db; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    ul { list-style: none; padding-left: 0; }
    li { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; gap: 8px; align-items: center; justify-content: space-between; }
    .muted { color: #6b7280; font-size: 12px; }
    .right { margin-left: auto; }
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ Snipp â€“ Ljud â†’ Text</h1>

  <div class="card">
    <div class="row">
      <button id="recordBtn">Starta inspelning</button>
      <button class="secondary" id="stopBtn" disabled>Stoppa</button>
      <button class="secondary" id="saveLocalBtn">ğŸ’¾ Spara som textfil</button>

      <span class="right">
        <input type="file" id="fileInput" accept=".mp3,.wav,.m4a,.mp4,.mpeg,.ogg,.oga,.webm,.flac" style="display:none;">
        <button class="secondary" id="uploadBtn" type="button">ğŸ“¤ Ladda upp ljudfil</button>
      </span>
    </div>

    <div id="status">Redo</div>
    <audio id="player" controls style="width:100%; margin-top:12px; display:none"></audio>

    <h3>Transkript</h3>
    <textarea id="result" placeholder="HÃ¤r kommer texten..."></textarea>
    <div class="muted">Obs: Transkriptioner sparas automatiskt pÃ¥ servern och syns i â€œHistorikâ€.</div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <h3 style="margin:0">ğŸ—‚ï¸ Historik</h3>
      <button class="secondary" id="refreshBtn">Uppdatera</button>
    </div>
    <ul id="history"></ul>
  </div>

  <script>
    // Element
    let mediaRecorder, chunks = [];
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const saveLocalBtn = document.getElementById('saveLocalBtn');
    const statusEl = document.getElementById('status');
    const player = document.getElementById('player');
    const result = document.getElementById('result');
    const historyEl = document.getElementById('history');
    const refreshBtn = document.getElementById('refreshBtn');
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');

    // HjÃ¤lp
    function setStatus(msg) { statusEl.textContent = msg; }

    // Uppladdning av existerande ljudfil
    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const form = new FormData();
      form.append('audio', file, file.name);
      setStatus('â¬†ï¸ Laddar upp & transkriberar...');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: form });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        result.value = data.text || '';
        setStatus(data.saved ? `âœ… Sparad: ${data.filename}` : 'âœ… Klar!');
        await loadHistory();
      } catch (err) {
        console.error(err);
        setStatus('âŒ Fel: ' + err.message);
      }
    };

    // Start inspelning
    recordBtn.onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        chunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = onStop;
        mediaRecorder.start();
        recordBtn.disabled = true; stopBtn.disabled = false;
        setStatus('âºï¸ Spelar in...');
      } catch (e) {
        console.error(e);
        setStatus('âŒ Mikrofon nekad eller ej tillgÃ¤nglig');
      }
    };

    // Stoppa inspelning
    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        setStatus('â¹ï¸ Bearbetar...');
      }
    };

    // NÃ¤r inspelningen stoppas â†’ skicka till API
    async function onStop() {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      player.src = URL.createObjectURL(blob);
      player.style.display = 'block';

      const form = new FormData();
      form.append('audio', blob, 'inspelning.webm');
      setStatus('â¬†ï¸ Laddar upp & transkriberar...');
      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: form });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        result.value = data.text || '';
        setStatus(data.saved ? `âœ… Sparad: ${data.filename}` : 'âœ… Klar!');
        await loadHistory();
      } catch (e) {
        console.error(e);
        setStatus('âŒ Fel: ' + e.message);
      } finally {
        recordBtn.disabled = false; stopBtn.disabled = true;
      }
    }

    // Spara lokalt (download)
    saveLocalBtn.onclick = () => {
      const text = result.value.trim();
      if (!text) return alert('Inget att spara!');
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `transkript_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    };

    // Historik
    async function loadHistory() {
      try {
        const res = await fetch('/api/history');
        const data = await res.json();
        const files = (data.files || []);
        historyEl.innerHTML = files.map(f => {
          const dt = new Date(f.mtime).toLocaleString();
          return `<li>
            <span>${f.name}<div class="muted">${dt} Â· ${(f.size/1024).toFixed(1)} KB</div></span>
            <span>
              <a href="/api/text/${encodeURIComponent(f.name)}" download>
                <button class="secondary">â¬‡ï¸ Ladda ner</button>
              </a>
              <button class="secondary" onclick="delFile('${f.name}')">ğŸ—‘ï¸ Radera</button>
            </span>
          </li>`;
        }).join('') || '<li class="muted">Ingen historik Ã¤nnu.</li>';
      } catch (e) {
        historyEl.innerHTML = '<li class="muted">Kunde inte hÃ¤mta historik.</li>';
      }
    }
    window.delFile = async (name) => {
      if (!confirm('Radera filen permanent?')) return;
      await fetch('/api/text/' + encodeURIComponent(name), { method: 'DELETE' });
      await loadHistory();
    };

    // Init
    loadHistory();
  </script>
</body>
</html>
