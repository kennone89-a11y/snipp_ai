<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>snipp_ai – Live</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{--bg:#0b0f14;--panel:#0f1721;--text:#e7eef8;--muted:#93a3ad;--line:#1f2937;--accent:#38bdf8;--ok:#22c55e;--r:16px}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:920px;margin:24px auto;padding:12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);padding:20px;box-shadow:0 0 1px rgba(0,0,0,.08)}
    h1{margin:0 0 8px} .muted{color:var(--muted);font-size:14px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    input{flex:1;min-width:260px;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:12px}
    button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn{background:#0b1220;color:#fff;border:1px solid var(--line)} .btn:hover{border-color:#243044}
    .primary{background:var(--accent);color:#041017} .ok{background:var(--ok);color:#02140b}
    audio{width:100%} .pill{padding:4px 8px;background:#0b1220;border:1px solid var(--line);border-radius:999px;font-size:12px}
    .list .item{padding:12px;border:1px solid var(--line);border-radius:12px;margin-bottom:10px;background:#0b1220}
  </style>
  <script>
  const SUPABASE_URL = "https://hywwzzzxgagqhlxooekz.supabase.co
";            // exakt EN https://
  const SUPABASE_ANON_KEY = `
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh5d3d6enp4Z2FncWhseG9vZWt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Mjk5NTcsImV4cCI6MjA3NzUwNTk1N30.A1BcczjSnP-LOh6p9XLozCBbBcr9LgHIcpjIqsk3eSA
  `.replace(/\s+/g,""); // lämna kvar backticks + den här .replace()!

  window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>


    // init
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // helper
    function makePath(){ return `reviews/${Date.now()}-${Math.random().toString(36).slice(2,8)}.webm`; }
    async function uploadAudioBlob(blob){
      const path = makePath();
      const up = await sb.storage.from("audio").upload(path, blob, { contentType:"audio/webm", upsert:false });
      if (up.error) throw up.error;
      const pub = sb.storage.from("audio").getPublicUrl(path);
      return { path, publicUrl: pub.data.publicUrl };
    }
    window.uploadAudioBlob = uploadAudioBlob;
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>snipp_ai</h1>
      <p class="muted">Live-uppladdning till Supabase Storage (bucket: <b>audio</b>).</p>

      <div class="row" style="margin-top:12px">
        <input id="title" type="text" placeholder="Titel (valfritt)" />
        <button id="btnStart" class="primary">Starta inspelning</button>
        <button id="btnStop"  class="btn" disabled>Stoppa</button>
        <button id="btnUpload" class="ok" disabled>Ladda upp</button>
        <span id="timer" class="pill">00:00</span>
      </div>

      <div style="margin-top:14px"><audio id="player" controls></audio></div>
      <a id="last-upload" target="_blank" rel="noopener" style="display:inline-block;margin-top:10px">—</a>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Dina uppladdningar</h3>
      <div id="review-list" class="list"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Sanity test</h3>
      <button id="btnList" class="btn">Lista 10 från "audio/reviews"</button>
      <pre id="out" style="background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px;white-space:pre-wrap;margin-top:10px"></pre>
    </div>
  </div>

  <script>
    // inspelning
    let mediaRecorder, chunks=[], audioBlob=null, tInt=null, t0=0;
    const $ = s=>document.querySelector(s);
    const btnStart=$('#btnStart'), btnStop=$('#btnStop'), btnUpload=$('#btnUpload');
    const player=$('#player'), timer=$('#timer'), out=$('#out');

    const setTimer=ms=>{const s=Math.floor(ms/1000),m=String(Math.floor(s/60)).padStart(2,'0'),ss=String(s%60).padStart(2,'0');timer.textContent=`${m}:${ss}`};

    async function startRec(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        chunks=[]; audioBlob=null;
        mediaRecorder = new MediaRecorder(stream, { mimeType:"audio/webm" });
        mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
        mediaRecorder.onstop = ()=>{ audioBlob=new Blob(chunks,{type:"audio/webm"}); player.src=URL.createObjectURL(audioBlob); btnUpload.disabled=false; stream.getTracks().forEach(t=>t.stop()); };
        mediaRecorder.start(); t0=Date.now(); tInt=setInterval(()=>setTimer(Date.now()-t0),250);
        btnStart.disabled=true; btnStop.disabled=false; btnUpload.disabled=true;
      }catch(e){ alert("Ge mikrofontillstånd."); console.error(e); }
    }
    function stopRec(){ if(mediaRecorder && mediaRecorder.state!=="inactive") mediaRecorder.stop(); clearInterval(tInt); setTimer(0); btnStart.disabled=false; btnStop.disabled=true; }

    async function doUpload(){
      if(!audioBlob) return alert("Spela in först.");
      try{
        const { publicUrl } = await uploadAudioBlob(audioBlob);
        const title = ($('#title').value || 'Review').trim();
        const shareUrl = `${location.origin}/share.html?src=${encodeURIComponent(publicUrl)}&t=${encodeURIComponent(title)}`;
        const a = $('#last-upload'); a.href=shareUrl; a.textContent="Spela upp senaste";
        await loadReviews();
      }catch(e){ console.error(e); alert("Upload fail – se konsolen."); }
    }
    btnStart.onclick=startRec; btnStop.onclick=stopRec; btnUpload.onclick=doUpload;

    // lista
    async function loadReviews(limit=25){
      const holder = document.getElementById('review-list');
      const resp = await sb.storage.from("audio").list("reviews", { limit, sortBy:{column:"created_at",order:"desc"} });
      if(resp.error){ holder.innerHTML="<p class='muted'>Kunde inte lista filer.</p>"; console.error(resp.error); return; }
      holder.innerHTML="";
      for(const f of resp.data||[]){
        const url = sb.storage.from("audio").getPublicUrl(`reviews/${f.name}`).data.publicUrl;
        const title = ($('#title')?.value || 'Review').trim();
        const shareUrl = `${location.origin}/share.html?src=${encodeURIComponent(url)}&t=${encodeURIComponent(title)}`;
        holder.insertAdjacentHTML("beforeend", `
          <div class="item">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
              <strong>${f.name}</strong>
              <a href="${shareUrl}" target="_blank" rel="noopener">Öppna</a>
            </div>
            <audio controls src="${url}" style="margin-top:6px"></audio>
            <div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap">
              <button class="btn" onclick="navigator.clipboard.writeText('${shareUrl}').then(()=>this.textContent='Kopierad!')">Kopiera länk</button>
              <a class="btn" href="https://wa.me/?text=${encodeURIComponent(shareUrl)}" target="_blank" rel="noopener">WhatsApp</a>
              <a class="btn" href="https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent('Lyssna på min review')}" target="_blank" rel="noopener">Telegram</a>
            </div>
          </div>
        `);
      }
    }
    document.addEventListener("DOMContentLoaded", loadReviews);

    // sanity
    document.getElementById('btnList').onclick = async () => {
      out.textContent = "";
      try{
        const ping = await sb.auth.getSession();
        out.textContent += "AUTH: " + (ping.error || "✓ PASS") + "\n";
        const list = await sb.storage.from("audio").list("reviews", { limit: 10 });
        out.textContent += "LIST: " + (list.error ? list.error.message : (list.data?.length+" filer")) + "\n";
      }catch(e){ out.textContent += "ERROR: " + e + "\n"; }
    };
  </script>
</body>
</html>
