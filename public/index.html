<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kenai – Recorder + Supabase</title>

  <!-- BYT TILL DINA RIKTIGA VÄRDEN -->
  <meta name="supabase-url"  content="https://hywwzzzxgagqhlxooekz.supabase.co;>
  <meta name="supabase-anon" content="sb_publishable_fLQC4d675JKhsc-QXj2oGw_BGIfI87Z';>

  <style>
    :root{--bg:#0b0f14;--card:#111723;--muted:#8aa0b6;--text:#e6eef7;--ok:#29bf12;--err:#ff006e;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto}
    .wrap{max-width:880px;margin:32px auto;padding:20px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px}
    p.muted{color:var(--muted);margin:4px 0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    #startBtn{background:#00e07b;color:#001}  #stopBtn{background:#ff4976;color:#fff}
    #testBtn{background:#3a86ff;color:#fff}
    #stopBtn[disabled],#startBtn[disabled]{opacity:.45;cursor:not-allowed}
    select{background:#0a0e14;color:#e6eef7;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;margin:10px 0 4px}
    #codec,#mime{color:#9cc3ff}
    small#status{display:block;white-space:pre-wrap;background:#0a0e14;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;margin-top:10px}
    audio{width:100%;margin-top:12px}
    a.action{display:inline-block;margin-top:10px;color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.2);padding:8px 12px;border-radius:12px}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Kenai – Recorder</h1>
      <p class="muted">WAV-only, 44.1 kHz mono, auto-stop. Upload till Supabase.</p>

      <div class="row">
        <button id="startBtn">Starta inspelning</button>
        <button id="stopBtn" disabled>Stoppa</button>
        <button id="testBtn" title="Testa upload utan inspelning">Testa Supabase</button>
        <span id="dot" style="margin-left:8px">status: <b id="state">idle</b></span>
      </div>

      <div class="row" style="margin-top:8px">
        <label for="maxlen">Maxlängd:</label>
        <select id="maxlen">
          <option value="30000">00:30</option>
          <option value="60000">01:00</option>
          <option value="120000" selected>02:00</option>
          <option value="300000">05:00</option>
        </select>
        <span style="margin-left:8px;color:#9cc3ff">Mono, 44100 Hz</span>
      </div>

      <div class="kv">
        <b>Tillstånd:</b>  <span id="st">idle</span>
        <b>Codec:</b>     <span id="codec">WAV-fallback</span>
        <b>MIME:</b>      <span id="mime">audio/wav</span>
        <b>Filnamn:</b>   <span id="fname">-</span>
        <b>Storlek:</b>   <span id="fsize">-</span>
        <b>Varaktighet:</b><span id="dur">00:00</span>
        <b>UA:</b>        <span id="ua"></span>
      </div>

      <small id="status">Klar. Tryck Starta för att begära mikrofonåtkomst.</small>
      <audio id="player" controls></audio>

      <div id="dl" class="hide" style="margin-top:8px">
        <a id="download" class="action" download>Ladda ner</a>
        <a id="open"     class="action" target="_blank" rel="noopener">Öppna fil</a>
        <a id="copy"     class="action" href="javascript:void(0)">Kopiera länk</a>
      </div>
    </div>
  </div>

  <!-- Recorder + Supabase (module) -->
  <script type="module">
    // ====== Supabase client ======
    const SB_URL  = document.querySelector('meta[name="supabase-url"]').content.trim();
    const SB_ANON = document.querySelector('meta[name="supabase-anon"]').content.trim();
    const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
    const supabase = createClient(SB_URL, SB_ANON);

    // ====== UI refs ======
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const testBtn  = document.getElementById('testBtn');
    const maxSel   = document.getElementById('maxlen');
    const stEl     = document.getElementById('st');
    const stateEl  = document.getElementById('state');
    const codecEl  = document.getElementById('codec');
    const mimeEl   = document.getElementById('mime');
    const nameEl   = document.getElementById('fname');
    const sizeEl   = document.getElementById('fsize');
    const durEl    = document.getElementById('dur');
    const uaEl     = document.getElementById('ua');
    const statusEl = document.getElementById('status');
    const player   = document.getElementById('player');
    const dlBox    = document.getElementById('dl');
    const aDownload= document.getElementById('download');
    const aOpen    = document.getElementById('open');
    const aCopy    = document.getElementById('copy');

    uaEl.textContent = navigator.userAgent;

    // ====== State ======
    const STATE = { IDLE:'idle', REC:'recording', STOP:'stopping', DONE:'done' };
    let startedAt = 0, tick=null, maxMs=+maxSel.value;
    let stream, ac=null, proc=null, bufs=[], chs=1, rate=44100;

    function setState(s){
      stEl.textContent = s; stateEl.textContent = s;
      startBtn.disabled = (s!==STATE.IDLE);
      stopBtn.disabled  = (s!==STATE.REC);
    }
    function log(t){ statusEl.textContent += (statusEl.textContent? '\n':'') + t; }
    function mmss(ms){ const s=Math.floor(ms/1000); return `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; }

    maxSel.addEventListener('change', ()=> maxMs=+maxSel.value);

    // ====== WAV helpers ======
    function pcm16(samples){
      const out = new Int16Array(samples.length);
      for(let i=0;i<samples.length;i++){
        const s = Math.max(-1, Math.min(1, samples[i]));
        out[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      return out;
    }
    function wavBlob(buffers, sampleRate){
      // concat
      let length = 0; buffers.forEach(b=>length+=b.length);
      const interleaved = new Float32Array(length);
      let o=0; buffers.forEach(b=>{ interleaved.set(b, o); o+=b.length; });
      const pcm = pcm16(interleaved);

      // WAV header
      const bytesPerSample = 2, blockAlign = chs * bytesPerSample;
      const dataSize = pcm.length * bytesPerSample;
      const buffer = new ArrayBuffer(44 + dataSize);
      const view = new DataView(buffer);
      function wStr(off, s){ for(let i=0;i<s.length;i++) view.setUint8(off+i, s.charCodeAt(i)); }

      wStr(0, 'RIFF'); view.setUint32(4, 36 + dataSize, true);
      wStr(8, 'WAVE'); wStr(12, 'fmt '); view.setUint32(16, 16, true);
      view.setUint16(20, 1, true); // PCM
      view.setUint16(22, chs, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * blockAlign, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, 8*bytesPerSample, true);
      wStr(36, 'data'); view.setUint32(40, dataSize, true);

      // PCM
      let idx=44;
      for(let i=0;i<pcm.length;i++,idx+=2) view.setInt16(idx, pcm[i], true);

      return new Blob([view], { type:'audio/wav' });
    }

    // ====== Recording ======
    async function startRec(){
      setState(STATE.REC); statusEl.textContent = '1) Begär mikrofon…';
      try{
        stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        statusEl.textContent = 'Mikrofon OK';
      }catch(e){
        setState(STATE.IDLE); alert('Mikrofon nekad'); return;
      }
      ac = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: rate });
      const src = ac.createMediaStreamSource(stream);
      const bufSize = 4096;
      proc = ac.createScriptProcessor(bufSize, chs, chs);
      bufs = [];
      proc.onaudioprocess = e=>{
        const ch = e.inputBuffer.getChannelData(0);
        bufs.push(new Float32Array(ch));
      };
      src.connect(proc); proc.connect(ac.destination);
      startedAt = performance.now();
      tick = setInterval(()=>{
        const t = performance.now()-startedAt;
        durEl.textContent = mmss(t);
        if(t >= maxMs) stopRec();
      }, 250);
      log('Spelar in …');
    }

    async function stopRec(){
      if(stateEl.textContent!==STATE.REC) return;
      setState(STATE.STOP); log('Stoppar inspelning…');
      clearInterval(tick);
      try{ proc.disconnect(); }catch{}
      try{ ac.close(); }catch{}
      try{ stream.getTracks().forEach(t=>t.stop()); }catch{}
      const blob = wavBlob(bufs, rate);
      const url = URL.createObjectURL(blob);
      player.src = url; player.play().catch(()=>{});
      codecEl.textContent = 'WAV-fallback';
      mimeEl.textContent  = blob.type || 'audio/wav';
      const dt = new Date();
      const fname = `kenai-${dt.toISOString().replace(/[:.]/g,'').slice(0,15)}.wav`;
      nameEl.textContent = fname;
      sizeEl.textContent = (blob.size/1024/1024).toFixed(2)+' MB';
      setState(STATE.DONE);
      log('Bygger WAV… klar. Klicka Ladda ner eller ladda upp.');
      // ställ in länkar
      aDownload.href = url; aDownload.download = fname;
      dlBox.classList.remove('hide');

      // direkt-upload efter stopp? (behåll manuell via knapp: tryck "Testa Supabase" eller låt auto)
      await uploadToSupabase(blob, fname);
    }

    // ====== Supabase upload ======
    async function uploadToSupabase(file, filename){
      log('⤴️  Laddar upp till Supabase…');
      const path = `reviews/${filename}`;
      const { data, error } = await supabase.storage.from('audio').upload(path, file, {
        cacheControl: '3600', upsert: true, contentType: file.type || 'audio/wav'
      });
      if(error){ log('❌ Upload fel: '+error.message); alert('Upload fel: '+error.message); return; }

      // Hämta public URL (förutsätter public bucket, annars use createSignedUrl)
      const { data: pub } = supabase.storage.from('audio').getPublicUrl(path);
      const publicUrl = pub?.publicUrl;
      log('✅ Upload klar: '+publicUrl);

      aOpen.href = publicUrl;
      aCopy.onclick = ()=>{ navigator.clipboard.writeText(publicUrl).then(()=>log('Kopierad länk ✅')); };
    }

    // test-knapp (liten blob)
    testBtn.onclick = async ()=>{
      const b = new Blob([new Uint8Array([82,73,70,70])], {type:'application/octet-stream'});
      await uploadToSupabase(b, `test-${Date.now()}.bin`);
    };

    // bindningar
    startBtn.onclick = ()=>{ if(stateEl.textContent===STATE.IDLE) startRec(); };
    stopBtn.onclick  = ()=> stopRec();

    // init
    setState(STATE.IDLE);
  </script>
</body>
</html>
